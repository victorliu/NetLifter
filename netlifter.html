<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Net Lifter</title>
<style>

body{
	font-family: Verdana, Geneva, sans-serif;
}
h1{ font-size: 150% }
h2{ font-size: 130% }
h3{ font-size: 120% }
td{ vertical-align: top; }

table tr th{
	padding: 0 0.5em;
}

/* Style the list */
ul.tabbar {
    list-style-type: none;
    margin: 0;
    padding: 0;
    overflow: hidden;
    border: 1px solid #ccc;
    background-color: #f1f1f1;
    position: fixed;
    bottom: 0;
	right: 0;
}

/* Float the list items side by side */
ul.tabbar li {float: left;}

/* Style the links inside the list items */
ul.tabbar li a {
    display: inline-block;
    color: black;
    text-align: center;
    padding: 14px 16px;
    text-decoration: none;
    transition: 0.3s;
    font-size: 17px;
}

/* Change background color of links on hover */
ul.tabbar li a:hover {background-color: #ddd;}

/* Create an active/current tablink class */
ul.tabbar li a:focus, .active {background-color: #ccc;}

/* Style the tab content */
.tabcontent {
    display: none;
    padding: 6px 12px;
    border: 1px solid #ccc;
    border-top: none;
}


.table_divider{
	background-color: #ccc;
}






.weightKG:after{
	content: " kg";
}
.weightLB:after{
	content: " lb";
}
#bgbox{
	position:absolute;
	width: 1024px;
	height: 768px;
	background-color: #eee;
	z-index: -1;
}
textarea{
	font: 10pt Courier, Courier New, sans-serif;
}
.curLifterInfo{
	background-color: #ccc;
	border: 1px solid #999;
	font-size: 24px;
}
#curLifterName{
	font-weight: bold;
}
#curLifterAge:before{
	content: "Age ";
}
#curLifterBodyWeight:before{
	content: "BodyWt: ";
}
#curLifterWeightClass:before{
	content: "WtCls: ";
}
#curLifterDivision:before{
	content: "Div: ";
}

#curLiftInfo{
	background-color: #ccc;
	border: 1px solid #999;
	font-size: 200%;
}
#curLift{
}
#curWeightOtherUnit:before{
	content: "(";
	color: #666;
}
#curWeightOtherUnit{
	color: #666;
}
#curWeightOtherUnit:after{
	content: ")";
	color: #666;
}
#curRackHeight:before{
	content: "Rack height: ";
}
blink {
  -webkit-animation: blink 1s steps(5, start) infinite;
  -moz-animation:    blink 1s steps(5, start) infinite;
  -o-animation:      blink 1s steps(5, start) infinite;
  animation:         blink 1s steps(5, start) infinite;
}

@-webkit-keyframes blink {
  to { visibility: hidden; }
}
@-moz-keyframes blink {
  to { visibility: hidden; }
}
@-o-keyframes blink {
  to { visibility: hidden; }
}
@keyframes blink {
  to { visibility: hidden; }
}
.entry_section{
	margin: 0.5em;
	padding: 0.5em;
	border: 1px solid #ccc;
}

table{
	border-collapse: collapse;
}
td{
	padding: 0.1em 0.2em 0.1em 0.2em;
	border: 1px solid #ccc;
}
tr.current{
	background-color: #ccccff;
}
td.current{
	font-weight: bold;
}
td.good{
	color: #009900;
}
td.nolift{
	color: #990000;
	text-decoration: line-through;
}

#dlgEntry{
	background-color: #ffff99;
	border: 1px solid black;
	padding: 0.5em;
	position:absolute;
	display:none;
}
#dlgEntryAttempt{
	background-color: #ffff99;
	border: 1px solid black;
	padding: 0.5em;
	position:absolute;
	display:none;
}
#dlgEntryRowIndicator{
	background-color: #ffff99;
	position:absolute;
	display:none;
	width: 1em;
}
#tbdCurLifterInfo td{
	border: 1px solid black;
}
#timerbox #timer{
	float: right;
	font-size: 45px;
}





#secTableDisplay{
	height: 400px;
	width: 1024px;
	overflow: auto;
	position: relative;
}

</style>
<style>
td.number {
	text-align: right;
	font-weight: bold;
	padding-right: 5px;
	white-space: nowrap;
}

td.number.nan {
	font-weight: normal;
	color: #AAA;
}

th.number {
	text-align: right;
}

td.boolean {
	text-align: center;
}

th.boolean {
	text-align: center;
}
</style>
<script>
function _$(a){return document.getElementById(a)}function Column(a){var b={name:"",label:"",editable:!0,renderable:!0,datatype:"string",unit:null,precision:-1,nansymbol:"",decimal_point:",",thousands_separator:".",unit_before_number:!1,bar:!0,hidden:!1,headerRenderer:null,headerEditor:null,cellRenderer:null,cellEditor:null,cellValidators:[],enumProvider:null,optionValues:null,optionValuesForRender:null,columnIndex:-1};for(var c in b)this[c]="undefined"==typeof a||"undefined"==typeof a[c]?b[c]:a[c]}function EnumProvider(a){this.getOptionValuesForRender=function(a,b,c){return null},this.getOptionValuesForEdit=function(a,b,c){return null};for(var b in a)this[b]=a[b]}function EditableGrid(a,b){"undefined"!=typeof a&&""==a.replace(/\s+/g,"")&&console.error("EditableGrid() : parameter [name] cannot be empty."),a&&this.init(a,b)}Column.prototype.getOptionValuesForRender=function(a){if(!this.enumProvider)return console.log("getOptionValuesForRender called on column "+this.name+" but there is no EnumProvider"),null;var b=this.enumProvider.getOptionValuesForRender(this.editablegrid,this,a);return b?b:this.optionValuesForRender},Column.prototype.getOptionValuesForEdit=function(a){if(!this.enumProvider)return console.log("getOptionValuesForEdit called on column "+this.name+" but there is no EnumProvider"),null;var b=this.enumProvider.getOptionValuesForEdit(this.editablegrid,this,a);return b?this.editablegrid._convertOptions(b):this.optionValues},Column.prototype.isValid=function(a){for(var b=0;b<this.cellValidators.length;b++)if(!this.cellValidators[b].isValid(a))return!1;return!0},Column.prototype.isNumerical=function(){return"double"==this.datatype||"integer"==this.datatype},EditableGrid.prototype.enableSort=!0,EditableGrid.prototype.enableStore=!0,EditableGrid.prototype.doubleclick=!1,EditableGrid.prototype.editmode="absolute",EditableGrid.prototype.editorzoneid="",EditableGrid.prototype.allowSimultaneousEdition=!1,EditableGrid.prototype.saveOnBlur=!0,EditableGrid.prototype.invalidClassName="invalid",EditableGrid.prototype.ignoreLastRow=!1,EditableGrid.prototype.caption=null,EditableGrid.prototype.dateFormat="EU",EditableGrid.prototype.shortMonthNames=null,EditableGrid.prototype.smartColorsBar=["#dc243c","#4040f6","#00f629","#efe100","#f93fb1","#6f8183","#111111"],EditableGrid.prototype.smartColorsPie=["#FF0000","#00FF00","#0000FF","#FFD700","#FF00FF","#00FFFF","#800080"],EditableGrid.prototype.pageSize=0,EditableGrid.prototype.serverSide=!1,EditableGrid.prototype.pageCount=0,EditableGrid.prototype.totalRowCount=0,EditableGrid.prototype.unfilteredRowCount=0,EditableGrid.prototype.paginatorAttributes=null,EditableGrid.prototype.lastURL=null,EditableGrid.prototype.init=function(a,b){if(("string"!=typeof a||"object"!=typeof b&&"undefined"!=typeof b)&&alert("The EditableGrid constructor takes two arguments:\n- name (string)\n- config (object)\n\nGot instead "+typeof a+" and "+typeof b+"."),"undefined"!=typeof b)for(var c in b)this[c]=b[c];if(this.Browser={IE:!(!window.attachEvent||navigator.userAgent.indexOf("Opera")!==-1),Opera:navigator.userAgent.indexOf("Opera")>-1,WebKit:navigator.userAgent.indexOf("AppleWebKit/")>-1,Gecko:navigator.userAgent.indexOf("Gecko")>-1&&navigator.userAgent.indexOf("KHTML")===-1,MobileSafari:!!navigator.userAgent.match(/Apple.*Mobile.*Safari/)},"function"!=typeof this.detectDir){var d=new Error;alert("Who is calling me now ? "+d.stack)}this.name=a,this.columns=[],this.data=[],this.dataUnfiltered=null,this.xmlDoc=null,this.sortedColumnName=-1,this.sortDescending=!1,this.baseUrl=this.detectDir(),this.nbHeaderRows=1,this.lastSelectedRowIndex=-1,this.currentPageIndex=0,this.currentFilter=null,this.currentContainerid=null,this.currentClassName=null,this.currentTableid=null,this.enableSort&&("undefined"!=typeof b&&"undefined"!=typeof b.sortIconUp?(this.sortUpElement=new Image,this.sortUpElement.src=b.sortIconUp):(this.sortUpElement=document.createElement("span"),this.sortUpElement.innerHTML="&#8593;"),"undefined"!=typeof b&&"undefined"!=typeof b.sortIconDown?(this.sortDownElement=new Image,this.sortDownElement.src=b.sortIconDown):(this.sortDownElement=document.createElement("span"),this.sortDownElement.innerHTML="&#8595;")),this.currentPageIndex=this.localisset("pageIndex")?parseInt(this.localget("pageIndex")):0,this.sortedColumnName=this.localisset("sortColumnIndexOrName")?this.localget("sortColumnIndexOrName"):-1,this.sortDescending=!(!this.localisset("sortColumnIndexOrName")||!this.localisset("sortDescending"))&&"true"==this.localget("sortDescending"),this.currentFilter=this.localisset("filter")?this.localget("filter"):null},EditableGrid.prototype.tableLoaded=function(){},EditableGrid.prototype.chartRendered=function(){},EditableGrid.prototype.tableRendered=function(a,b,c){},EditableGrid.prototype.tableSorted=function(a,b){},EditableGrid.prototype.tableFiltered=function(){},EditableGrid.prototype.openedCellEditor=function(a,b){},EditableGrid.prototype.modelChanged=function(a,b,c,d,e){},EditableGrid.prototype.rowSelected=function(a,b){},EditableGrid.prototype.isHeaderEditable=function(a,b){return!1},EditableGrid.prototype.isEditable=function(a,b){return!0},EditableGrid.prototype.readonlyWarning=function(){},EditableGrid.prototype.rowRemoved=function(a,b){},EditableGrid.prototype.loadXML=function(a,b,c){this.lastURL=a;var d=this;if(window.ActiveXObject)this.xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),this.xmlDoc.onreadystatechange=function(){4==d.xmlDoc.readyState&&(d.processXML(),d._callback("xml",b))},this.xmlDoc.load(this._addUrlParameters(a,c));else if(window.XMLHttpRequest)this.xmlDoc=new XMLHttpRequest,this.xmlDoc.onreadystatechange=function(){if(4==this.readyState){if(d.xmlDoc=this.responseXML,!d.xmlDoc)return console.error("Could not load XML from url '"+a+"'"),!1;d.processXML(),d._callback("xml",b)}},this.xmlDoc.open("GET",this._addUrlParameters(a,c),!0),this.xmlDoc.send("");else{if(!document.implementation||!document.implementation.createDocument)return alert("Cannot load a XML url with this browser!"),!1;this.xmlDoc=document.implementation.createDocument("","",null),this.xmlDoc.onload=function(){d.processXML(),d._callback("xml",b)},this.xmlDoc.load(this._addUrlParameters(a,c))}return!0},EditableGrid.prototype.loadXMLFromString=function(a){if(window.DOMParser){var b=new DOMParser;this.xmlDoc=b.parseFromString(a,"application/xml")}else this.xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),this.xmlDoc.async="false",this.xmlDoc.loadXML(a);this.processXML()},EditableGrid.prototype.processXML=function(){with(this){this.data=[],this.dataUnfiltered=null,this.table=null;var metadata=xmlDoc.getElementsByTagName("metadata");if(metadata&&metadata.length>=1){this.columns=[];for(var columnDeclarations=metadata[0].getElementsByTagName("column"),i=0;i<columnDeclarations.length;i++){var col=columnDeclarations[i],datatype=col.getAttribute("datatype"),optionValuesForRender=null,optionValues=null,enumValues=col.getElementsByTagName("values");if(enumValues.length>0){optionValues=[],optionValuesForRender={};var enumGroups=enumValues[0].getElementsByTagName("group");if(enumGroups.length>0)for(var g=0;g<enumGroups.length;g++){var groupOptionValues=[];enumValues=enumGroups[g].getElementsByTagName("value");for(var v=0;v<enumValues.length;v++){var _value=enumValues[v].getAttribute("value"),_label=enumValues[v].firstChild?enumValues[v].firstChild.nodeValue:"";optionValuesForRender[_value]=_label,groupOptionValues.push({value:_value,label:_label})}optionValues.push({label:enumGroups[g].getAttribute("label"),values:groupOptionValues})}else{enumValues=enumValues[0].getElementsByTagName("value");for(var v=0;v<enumValues.length;v++){var _value=enumValues[v].getAttribute("value"),_label=enumValues[v].firstChild?enumValues[v].firstChild.nodeValue:"";optionValuesForRender[_value]=_label,optionValues.push({value:_value,label:_label})}}}columns.push(new Column({name:col.getAttribute("name"),label:"string"==typeof col.getAttribute("label")?col.getAttribute("label"):col.getAttribute("name"),datatype:col.getAttribute("datatype")?col.getAttribute("datatype"):"string",editable:"true"==col.getAttribute("editable"),bar:!col.getAttribute("bar")||"true"==col.getAttribute("bar"),hidden:!!col.getAttribute("hidden")&&"true"==col.getAttribute("hidden"),optionValuesForRender:optionValuesForRender,optionValues:optionValues}))}processColumns()}var paginator=xmlDoc.getElementsByTagName("paginator");paginator&&paginator.length>=1&&(this.paginatorAttributes=null,this.pageCount=paginator[0].getAttribute("pagecount"),this.totalRowCount=paginator[0].getAttribute("totalrowcount"),this.unfilteredRowCount=paginator[0].getAttribute("unfilteredrowcount"));for(var defaultRowId=1,rows=xmlDoc.getElementsByTagName("row"),i=0;i<rows.length;i++){for(var cellValues={},cols=rows[i].getElementsByTagName("column"),j=0;j<cols.length;j++){var colname=cols[j].getAttribute("name");colname||(j>=columns.length?console.error("You defined too many columns for row "+(i+1)):colname=columns[j].name),cellValues[colname]=cols[j].firstChild?cols[j].firstChild.nodeValue:""}for(var rowData={visible:!0,originalIndex:i,id:null!==rows[i].getAttribute("id")?rows[i].getAttribute("id"):defaultRowId++},attrIndex=0;attrIndex<rows[i].attributes.length;attrIndex++){var node=rows[i].attributes.item(attrIndex);"id"!=node.nodeName&&(rowData[node.nodeName]=node.nodeValue)}rowData.columns=[];for(var c=0;c<columns.length;c++){var cellValue=columns[c].name in cellValues?cellValues[columns[c].name]:"";rowData.columns.push(getTypedValue(c,cellValue))}data.push(rowData)}}return!0},EditableGrid.prototype.loadJSON=function(a,b,c){this.lastURL=a;var d=this;if(!window.XMLHttpRequest)return alert("Cannot load a JSON url with this browser!"),!1;var e=new XMLHttpRequest;return e.onreadystatechange=function(){if(4==this.readyState){if(!this.responseText)return console.error("Could not load JSON from url '"+a+"'"),!1;if(!d.processJSON(this.responseText))return console.error("Invalid JSON data obtained from url '"+a+"'"),!1;d._callback("json",b)}},e.open("GET",this._addUrlParameters(a,c),!0),e.send(""),!0},EditableGrid.prototype._addUrlParameters=function(a,b){var c=a.indexOf("?")>=0?"&":"?";return a+=c+(new Date).getTime(),this.serverSide?a+"&page="+(this.currentPageIndex+1)+"&filter="+(this.currentFilter?encodeURIComponent(this.currentFilter):"")+"&sort="+(this.sortedColumnName&&this.sortedColumnName!=-1?encodeURIComponent(this.sortedColumnName):"")+"&asc="+(this.sortDescending?0:1)+(b?"&data_only=1":""):a},EditableGrid.prototype._callback=function(a,b){b?b.call(this):(this.serverSide&&(this.refreshGrid=function(b){var c=function(){EditableGrid.prototype.refreshGrid.call(this)},d="xml"==a?this.loadXML:this.loadJSON;d.call(this,b||this.lastURL,c,!0)}),this.tableLoaded())},EditableGrid.prototype.loadJSONFromString=function(a){return this.processJSON(a)},EditableGrid.prototype.load=function(a){return this.processJSON(a)},EditableGrid.prototype.update=function(a){if(a.data)for(var b=0;b<a.data.length;b++){var c=a.data[b];if(c.id&&c.values){var d=this.getRowIndex(c.id),e=this.data[d];if("[object Array]"!==Object.prototype.toString.call(c.values))cellValues=c.values;else{cellValues={};for(var f=0;f<c.values.length&&f<this.columns.length;f++)cellValues[this.columns[f].name]=c.values[f]}for(var g in c)"id"!=g&&"values"!=g&&(e[g]=c[g]);e.columns=[];for(var h=0;h<this.columns.length;h++){var i=this.columns[h].name in cellValues?cellValues[this.columns[h].name]:"";e.columns.push(this.getTypedValue(h,i))}for(var j=this.getRow(d),f=0;f<j.cells.length&&f<this.columns.length;f++)this.columns[f].renderable&&this.columns[f].cellRenderer._render(d,f,j.cells[f],this.getValueAt(d,f));this.tableRendered(this.currentContainerid,this.currentClassName,this.currentTableid)}}},EditableGrid.prototype.processJSON=function(jsonData){if("string"==typeof jsonData&&(jsonData=eval("("+jsonData+")")),!jsonData)return!1;if(this.data=[],this.dataUnfiltered=null,this.table=null,jsonData.metadata){this.columns=[];for(var c=0;c<jsonData.metadata.length;c++){var columndata=jsonData.metadata[c],optionValues=columndata.values?this._convertOptions(columndata.values):null,optionValuesForRender=null;if(optionValues)for(var optionValuesForRender={},optionIndex=0;optionIndex<optionValues.length;optionIndex++){var optionValue=optionValues[optionIndex];if("object"==typeof optionValue.values)for(var groupOptionIndex=0;groupOptionIndex<optionValue.values.length;groupOptionIndex++){var groupOptionValue=optionValue.values[groupOptionIndex];optionValuesForRender[groupOptionValue.value]=groupOptionValue.label}else optionValuesForRender[optionValue.value]=optionValue.label}this.columns.push(new Column({name:columndata.name,label:columndata.label?columndata.label:columndata.name,datatype:columndata.datatype?columndata.datatype:"string",editable:!!columndata.editable,bar:"undefined"==typeof columndata.bar||(columndata.bar||!1),hidden:"undefined"!=typeof columndata.hidden&&!!columndata.hidden,optionValuesForRender:optionValuesForRender,optionValues:optionValues}))}this.processColumns()}jsonData.paginator&&(this.paginatorAttributes=jsonData.paginator,this.pageCount=jsonData.paginator.pagecount,this.totalRowCount=jsonData.paginator.totalrowcount,this.unfilteredRowCount=jsonData.paginator.unfilteredrowcount);var defaultRowId=1;if(jsonData.data)for(var i=0;i<jsonData.data.length;i++){var row=jsonData.data[i];if(row.values){if("[object Array]"!==Object.prototype.toString.call(row.values))cellValues=row.values;else{cellValues={};for(var j=0;j<row.values.length&&j<this.columns.length;j++)cellValues[this.columns[j].name]=row.values[j]}var rowData={visible:!0,originalIndex:i,id:void 0!==row.id&&null!==row.id?row.id:defaultRowId++};for(var attributeName in row)"id"!=attributeName&&"values"!=attributeName&&(rowData[attributeName]=row[attributeName]);rowData.columns=[];for(var c=0;c<this.columns.length;c++){var cellValue=this.columns[c].name in cellValues?cellValues[this.columns[c].name]:"";rowData.columns.push(this.getTypedValue(c,cellValue))}this.data.push(rowData)}}return!0},EditableGrid.prototype.processColumns=function(){for(var a=0;a<this.columns.length;a++){var b=this.columns[a];b.columnIndex=a,b.editablegrid=this,this.parseColumnType(b),b.enumProvider||(b.enumProvider=b.optionValues?new EnumProvider:null),b.cellRenderer||this._createCellRenderer(b),b.headerRenderer||this._createHeaderRenderer(b),b.cellEditor||this._createCellEditor(b),b.headerEditor||this._createHeaderEditor(b),this._addDefaultCellValidators(b)}},EditableGrid.prototype.parseColumnType=function(a){if(a.unit=null,a.precision=-1,a.decimal_point=",",a.thousands_separator=".",a.unit_before_number=!1,a.nansymbol="",a.datatype.match(/(.*)\((.*),(.*),(.*),(.*),(.*),(.*)\)$/))a.datatype=RegExp.$1,a.unit=RegExp.$2,a.precision=parseInt(RegExp.$3),a.decimal_point=RegExp.$4,a.thousands_separator=RegExp.$5,a.unit_before_number=RegExp.$6,a.nansymbol=RegExp.$7,a.unit=a.unit.trim(),a.decimal_point=a.decimal_point.trim(),a.thousands_separator=a.thousands_separator.trim(),a.unit_before_number="1"==a.unit_before_number.trim(),a.nansymbol=a.nansymbol.trim();else if(a.datatype.match(/(.*)\((.*),(.*),(.*),(.*),(.*)\)$/))a.datatype=RegExp.$1,a.unit=RegExp.$2,a.precision=parseInt(RegExp.$3),a.decimal_point=RegExp.$4,a.thousands_separator=RegExp.$5,a.unit_before_number=RegExp.$6,a.unit=a.unit.trim(),a.decimal_point=a.decimal_point.trim(),a.thousands_separator=a.thousands_separator.trim(),a.unit_before_number="1"==a.unit_before_number.trim();else if(a.datatype.match(/(.*)\((.*),(.*),(.*)\)$/))a.datatype=RegExp.$1,a.unit=RegExp.$2.trim(),a.precision=parseInt(RegExp.$3),a.nansymbol=RegExp.$4.trim();else if(a.datatype.match(/(.*)\((.*),(.*)\)$/))a.datatype=RegExp.$1.trim(),a.unit=RegExp.$2.trim(),a.precision=parseInt(RegExp.$3);else if(a.datatype.match(/(.*)\((.*)\)$/)){a.datatype=RegExp.$1.trim();var b=RegExp.$2.trim();b.match(/^[0-9]*$/)?a.precision=parseInt(b):a.unit=b}"comma"==a.decimal_point&&(a.decimal_point=","),"dot"==a.decimal_point&&(a.decimal_point="."),"comma"==a.thousands_separator&&(a.thousands_separator=","),"dot"==a.thousands_separator&&(a.thousands_separator="."),isNaN(a.precision)&&(a.precision=-1),""==a.unit&&(a.unit=null),""==a.nansymbol&&(a.nansymbol=null)},EditableGrid.prototype.getTypedValue=function(a,b){if(null===b)return b;var c=this.getColumnType(a);return"boolean"==c&&(b=!(!b||0==b||"false"==b||"f"==b)),"integer"==c&&(b=parseInt(b,10)),"double"==c&&(b=parseFloat(b)),"string"==c&&(b=""+b),b},EditableGrid.prototype.attachToHTMLTable=function(a,b){if(this.data=[],this.dataUnfiltered=null,this.table=null,b){this.columns=b;for(var c=0;c<this.columns.length;c++)this.columns[c].optionValues=this._convertOptions(this.columns[c].optionValues);this.processColumns()}this.table="string"==typeof a?_$(a):a,this.table||console.error("Invalid table given: "+a),this.tHead=this.table.tHead,this.tBody=this.table.tBodies[0],this.tBody||(this.tBody=document.createElement("TBODY"),this.table.insertBefore(this.tBody,this.table.firstChild)),this.tHead||(this.tHead=document.createElement("THEAD"),this.table.insertBefore(this.tHead,this.tBody)),0==this.tHead.rows.length&&this.tBody.rows.length>0&&this.tHead.appendChild(this.tBody.rows[0]),this.nbHeaderRows=this.tHead.rows.length;for(var d=this.tHead.rows,e=0;e<d.length;e++)for(var f=d[e].cells,g=0,h=0;h<f.length&&g<this.columns.length;h++){this.columns[g].label&&this.columns[g].label!=this.columns[g].name||(this.columns[g].label=f[h].innerHTML);var i=parseInt(f[h].getAttribute("colspan"));g+=i>1?i:1}for(var d=this.tBody.rows,e=0;e<d.length;e++){for(var j=[],f=d[e].cells,h=0;h<f.length&&h<this.columns.length;h++)j.push(this.getTypedValue(h,f[h].innerHTML));this.data.push({visible:!0,originalIndex:e,id:d[e].id,columns:j}),d[e].rowId=d[e].id,d[e].id=this._getRowDOMId(d[e].id)}},EditableGrid.prototype._createCellRenderer=function(a){a.cellRenderer=a.enumProvider&&"list"==a.datatype&&"undefined"!=typeof MultiselectCellRenderer?new MultiselectCellRenderer:a.enumProvider?new EnumCellRenderer:"integer"==a.datatype||"double"==a.datatype?new NumberCellRenderer:"boolean"==a.datatype?new CheckboxCellRenderer:"email"==a.datatype?new EmailCellRenderer:"website"==a.datatype||"url"==a.datatype?new WebsiteCellRenderer:"date"==a.datatype?new DateCellRenderer:new CellRenderer,a.cellRenderer&&(a.cellRenderer.editablegrid=this,a.cellRenderer.column=a)},EditableGrid.prototype._createHeaderRenderer=function(a){a.headerRenderer=this.enableSort&&"html"!=a.datatype?new SortHeaderRenderer(a.name):new CellRenderer,a.headerRenderer&&(a.headerRenderer.editablegrid=this,a.headerRenderer.column=a)},EditableGrid.prototype._createCellEditor=function(a){a.cellEditor=a.enumProvider&&"list"==a.datatype&&"undefined"!=typeof MultiselectCellEditor?new MultiselectCellEditor:a.enumProvider?new SelectCellEditor:"integer"==a.datatype||"double"==a.datatype?new NumberCellEditor(a.datatype):"boolean"==a.datatype?null:"email"==a.datatype?new TextCellEditor(a.precision):"website"==a.datatype||"url"==a.datatype?new TextCellEditor(a.precision):"date"==a.datatype?"undefined"==typeof jQuery||"undefined"==typeof jQuery.datepicker?new TextCellEditor(a.precision,10):new DateCellEditor({fieldSize:a.precision,maxLength:10}):new TextCellEditor(a.precision),a.cellEditor&&(a.cellEditor.editablegrid=this,a.cellEditor.column=a)},EditableGrid.prototype._createHeaderEditor=function(a){a.headerEditor=new TextCellEditor,a.headerEditor&&(a.headerEditor.editablegrid=this,a.headerEditor.column=a)},EditableGrid.prototype.getRowCount=function(){return this.data.length},EditableGrid.prototype.getUnfilteredRowCount=function(){if(this.unfilteredRowCount>0)return this.unfilteredRowCount;var a=null==this.dataUnfiltered?this.data:this.dataUnfiltered;return a.length},EditableGrid.prototype.getTotalRowCount=function(){return this.totalRowCount>0?this.totalRowCount:this.getRowCount()},EditableGrid.prototype.getColumnCount=function(){return this.columns.length},EditableGrid.prototype.hasColumn=function(a){return this.getColumnIndex(a)>=0},EditableGrid.prototype.getColumn=function(a){var b=this.getColumnIndex(a);return b<0?(console.error("[getColumn] Column not found with index or name "+a),null):this.columns[b]},EditableGrid.prototype.getColumnName=function(a){return this.getColumn(a).name},EditableGrid.prototype.getColumnLabel=function(a){return this.getColumn(a).label},EditableGrid.prototype.getColumnType=function(a){return this.getColumn(a).datatype},EditableGrid.prototype.getColumnUnit=function(a){return this.getColumn(a).unit},EditableGrid.prototype.getColumnPrecision=function(a){return this.getColumn(a).precision},EditableGrid.prototype.isColumnBar=function(a){var b=this.getColumn(a);return b.bar&&b.isNumerical()},EditableGrid.prototype.getColumnStack=function(a){var b=this.getColumn(a);return b.isNumerical()?b.bar:""},EditableGrid.prototype.isColumnNumerical=function(a){var b=this.getColumn(a);return b.isNumerical()},EditableGrid.prototype.getValueAt=function(a,b){if(b<0||b>=this.columns.length)return console.error("[getValueAt] Invalid column index "+b),null;var c=this.columns[b];if(a<0)return c.label;if("undefined"==typeof this.data[a])return console.error("[getValueAt] Invalid row index "+a),null;var d=this.data[a].columns;return d?d[b]:null},EditableGrid.prototype.getDisplayValueAt=function(a,b){var c=this.getValueAt(a,b),d=a<0?this.columns[b].headerRenderer:this.columns[b].cellRenderer;return d.getDisplayValue(a,c)},EditableGrid.prototype.setValueAt=function(a,b,c,d){"undefined"==typeof d&&(d=!0);var e=null;if(b<0||b>=this.columns.length)return console.error("[setValueAt] Invalid column index "+b),null;var f=this.columns[b];if(a<0)e=f.label,f.label=c;else{if("undefined"==typeof this.data[a])return console.error("Invalid rowindex "+a),null;var g=this.data[a].columns;e=g[b],g&&(g[b]=this.getTypedValue(b,c))}if(d){var h=a<0?f.headerRenderer:f.cellRenderer,i=this.getCell(a,b);i&&h._render(a,b,i,c)}return e},EditableGrid.prototype.getColumnIndex=function(a){if("undefined"==typeof a||""===a)return-1;if(!isNaN(a)&&a>=0&&a<this.columns.length)return a;for(var b=0;b<this.columns.length;b++)if(this.columns[b].name==a)return b;return-1},EditableGrid.prototype.getRow=function(a){return a<0?this.tHead.rows[a+this.nbHeaderRows]:"undefined"==typeof this.data[a]?(console.error("[getRow] Invalid row index "+a),null):_$(this._getRowDOMId(this.data[a].id))},EditableGrid.prototype.getRowId=function(a){return a<0||a>=this.data.length?null:this.data[a].id},EditableGrid.prototype.getRowIndex=function(a){a="object"==typeof a?a.rowId:a;for(var b=0;b<this.data.length;b++)if(this.data[b].id==a)return b;return-1},EditableGrid.prototype.getRowAttribute=function(a,b){return"undefined"==typeof this.data[a]?(console.error("Invalid rowindex "+a),null):this.data[a][b]},EditableGrid.prototype.setRowAttribute=function(a,b,c){this.data[a][b]=c},EditableGrid.prototype._getRowDOMId=function(a){return null!=this.currentContainerid?this.name+"_"+a:a},EditableGrid.prototype.removeRow=function(a){return this.remove(this.getRowIndex(a))},EditableGrid.prototype.remove=function(a){var b=this.data[a].id,c=this.data[a].originalIndex,d=null==this.dataUnfiltered?this.data:this.dataUnfiltered,e=_$(this._getRowDOMId(b));null!=e&&this.tBody.removeChild(e);for(var f=0;f<d.length;f++)d[f].originalIndex>=c&&d[f].originalIndex--;if(this.data.splice(a,1),null!=this.dataUnfiltered)for(var f=0;f<this.dataUnfiltered.length;f++)if(this.dataUnfiltered[f].id==b){this.dataUnfiltered.splice(f,1);break}this.rowRemoved(a,b),this.refreshGrid()},EditableGrid.prototype.getRowValues=function(a){for(var b={},c=0;c<this.getColumnCount();c++)b[this.getColumnName(c)]=this.getValueAt(a,c);return b},EditableGrid.prototype.append=function(a,b,c,d){return this.insert(this.data.length,a,b,c,d)},EditableGrid.prototype.addRow=function(a,b,c,d){return this.append(a,b,c,d)},EditableGrid.prototype._insert=function(a,b,c,d,e,f){var g=null,h=0,i=null==this.dataUnfiltered?this.data:this.dataUnfiltered;if("undefined"!=typeof this.data[a]&&(g=this.data[a].id,h=this.data[a].originalIndex+b),null==this.currentContainerid){var j=this.tBody.insertRow(a+b);j.rowId=c,j.id=this._getRowDOMId(c);for(var k=0;k<this.columns.length;k++)j.insertCell(k)}var l={visible:!0,originalIndex:h,id:c};if(e)for(var m in e)l[m]=e[m];l.columns=[];for(var k=0;k<this.columns.length;k++){var n=this.columns[k].name in d?d[this.columns[k].name]:"";l.columns.push(this.getTypedValue(k,n))}for(var o=0;o<i.length;o++)i[o].originalIndex>=h&&i[o].originalIndex++;if(this.data.splice(a+b,0,l),null!=this.dataUnfiltered)if(null===g)this.dataUnfiltered.splice(a+b,0,l);else for(var o=0;o<this.dataUnfiltered.length;o++)if(this.dataUnfiltered[o].id==g){this.dataUnfiltered.splice(o+b,0,l);break}this.refreshGrid(),f||this.sort(),this.filter()},EditableGrid.prototype.insert=function(a,b,c,d,e){return a<0&&(a=0),a>=this.data.length&&this.data.length>0?this.insertAfter(this.data.length-1,b,c,d,e):this._insert(a,0,b,c,d,e)},EditableGrid.prototype.insertAfter=function(a,b,c,d,e){return a<0?this.insert(0,b,c,d,e):(a>=this.data.length&&(a=Math.max(0,this.data.length-1)),this._insert(a,1,b,c,d,e))},EditableGrid.prototype.setHeaderRenderer=function(a,b){var c=this.getColumnIndex(a);if(c<0)console.error("[setHeaderRenderer] Invalid column: "+a);else{var d=this.columns[c];d.headerRenderer=this.enableSort&&"html"!=d.datatype?new SortHeaderRenderer(d.name,b):b,b&&(this.enableSort&&"html"!=d.datatype&&(d.headerRenderer.editablegrid=this,d.headerRenderer.column=d),b.editablegrid=this,b.column=d)}},EditableGrid.prototype.setCellRenderer=function(a,b){var c=this.getColumnIndex(a);if(c<0)console.error("[setCellRenderer] Invalid column: "+a);else{var d=this.columns[c];d.cellRenderer=b,b&&(b.editablegrid=this,b.column=d)}},EditableGrid.prototype.setCellEditor=function(a,b){var c=this.getColumnIndex(a);if(c<0)console.error("[setCellEditor] Invalid column: "+a);else{var d=this.columns[c];d.cellEditor=b,b&&(b.editablegrid=this,b.column=d)}},EditableGrid.prototype.setHeaderEditor=function(a,b){var c=this.getColumnIndex(a);if(c<0)console.error("[setHeaderEditor] Invalid column: "+a);else{var d=this.columns[c];d.headerEditor=b,b&&(b.editablegrid=this,b.column=d)}},EditableGrid.prototype.setEnumProvider=function(a,b){var c=this.getColumnIndex(a);if(c<0)console.error("[setEnumProvider] Invalid column: "+a);else{var d=null!=this.columns[c].enumProvider;this.columns[c].enumProvider=b,d||(this._createCellRenderer(this.columns[c]),this._createCellEditor(this.columns[c]))}},EditableGrid.prototype.clearCellValidators=function(a){var b=this.getColumnIndex(a);b<0?console.error("[clearCellValidators] Invalid column: "+a):this.columns[b].cellValidators=[]},EditableGrid.prototype.addDefaultCellValidators=function(a){var b=this.getColumnIndex(a);return b<0&&console.error("[addDefaultCellValidators] Invalid column: "+a),this._addDefaultCellValidators(this.columns[b])},EditableGrid.prototype._addDefaultCellValidators=function(a){"integer"==a.datatype||"double"==a.datatype?a.cellValidators.push(new NumberCellValidator(a.datatype)):"email"==a.datatype?a.cellValidators.push(new EmailCellValidator):"website"==a.datatype||"url"==a.datatype?a.cellValidators.push(new WebsiteCellValidator):"date"==a.datatype&&a.cellValidators.push(new DateCellValidator(this))},EditableGrid.prototype.addCellValidator=function(a,b){var c=this.getColumnIndex(a);c<0?console.error("[addCellValidator] Invalid column: "+a):this.columns[c].cellValidators.push(b)},EditableGrid.prototype.setCaption=function(a){this.caption=a},EditableGrid.prototype.getCell=function(a,b){var c=this.getRow(a);return null==c?(console.error("[getCell] Invalid row index "+a),null):c.cells[b]},EditableGrid.prototype.getCellX=function(a){for(var b=0;null!=a&&this.isStatic(a);)try{b+=a.offsetLeft,a=a.offsetParent}catch(b){a=null}return b},EditableGrid.prototype.getCellY=function(a){for(var b=0;null!=a&&this.isStatic(a);)try{b+=a.offsetTop,a=a.offsetParent}catch(b){a=null}return b},EditableGrid.prototype.getScrollXOffset=function(a){for(var b=0;null!=a&&"undefined"!=typeof a.scrollLeft&&this.isStatic(a)&&a!=document.body;)try{b+=parseInt(a.scrollLeft),a=a.parentNode}catch(b){a=null}return b},EditableGrid.prototype.getScrollYOffset=function(a){for(var b=0;null!=a&&"undefined"!=typeof a.scrollTop&&this.isStatic(a)&&a!=document.body;)try{b+=parseInt(a.scrollTop),a=a.parentNode}catch(b){a=null}return b},EditableGrid.prototype._rendergrid=function(containerid,className,tableid){with(this){if(lastSelectedRowIndex=-1,_currentPageIndex=getCurrentPageIndex(),"undefined"!=typeof table&&null!=table){var _data=null==dataUnfiltered?data:dataUnfiltered;_renderHeaders();for(var rows=tBody.rows,skipped=0,displayed=0,rowIndex=0,i=0;i<rows.length;i++)if(!_data[i].visible||pageSize>0&&displayed>=pageSize)"none"!=rows[i].style.display&&(rows[i].style.display="none",rows[i].hidden_by_editablegrid=!0);else{if(skipped<pageSize*_currentPageIndex)skipped++,"none"!=rows[i].style.display&&(rows[i].style.display="none",rows[i].hidden_by_editablegrid=!0);else{displayed++;var cols=rows[i].cells;"undefined"!=typeof rows[i].hidden_by_editablegrid&&rows[i].hidden_by_editablegrid&&(rows[i].style.display="",rows[i].hidden_by_editablegrid=!1),rows[i].rowId=getRowId(rowIndex),rows[i].id=_getRowDOMId(rows[i].rowId);for(var j=0;j<cols.length&&j<columns.length;j++)columns[j].renderable&&columns[j].cellRenderer._render(rowIndex,j,cols[j],getValueAt(rowIndex,j))}rowIndex++}table.editablegrid=this,doubleclick?table.ondblclick=function(a){this.editablegrid.mouseClicked(a)}:table.onclick=function(a){this.editablegrid.mouseClicked(a)}}else{if(!containerid)return console.error("Container ID not specified (renderGrid not called yet ?)");if(!_$(containerid))return console.error("Unable to get element ["+containerid+"]");currentContainerid=containerid,currentClassName=className,currentTableid=tableid;var startRowIndex=0,endRowIndex=getRowCount();for(pageSize>0&&(startRowIndex=_currentPageIndex*pageSize,endRowIndex=Math.min(getRowCount(),startRowIndex+pageSize)),this.table=document.createElement("table"),table.className=className||"editablegrid","undefined"!=typeof tableid&&(table.id=tableid);_$(containerid).hasChildNodes();)_$(containerid).removeChild(_$(containerid).firstChild);if(_$(containerid).appendChild(table),caption){var captionElement=document.createElement("CAPTION");captionElement.innerHTML=this.caption,table.appendChild(captionElement)}this.tHead=document.createElement("THEAD"),table.appendChild(tHead);for(var trHeader=tHead.insertRow(0),columnCount=getColumnCount(),c=0;c<columnCount;c++){var headerCell=document.createElement("TH"),td=trHeader.appendChild(headerCell);columns[c].headerRenderer._render(-1,c,td,columns[c].label)}this.tBody=document.createElement("TBODY"),table.appendChild(tBody);for(var insertRowIndex=0,i=startRowIndex;i<endRowIndex;i++){var tr=tBody.insertRow(insertRowIndex++);for(tr.rowId=data[i].id,tr.id=this._getRowDOMId(data[i].id),j=0;j<columnCount;j++){var td=tr.insertCell(j);columns[j].cellRenderer._render(i,j,td,getValueAt(i,j))}}_$(containerid).editablegrid=this,doubleclick?_$(containerid).ondblclick=function(a){this.editablegrid.mouseClicked(a)}:_$(containerid).onclick=function(a){this.editablegrid.mouseClicked(a)}}tableRendered(containerid,className,tableid)}},EditableGrid.prototype.renderGrid=function(a,b,c){this._rendergrid(a,b,c),this.serverSide||(this.sort(),this.filter())},EditableGrid.prototype.refreshGrid=function(){null!=this.currentContainerid&&(this.table=null),this._rendergrid(this.currentContainerid,this.currentClassName,this.currentTableid)},EditableGrid.prototype._renderHeaders=function(){with(this)for(var rows=tHead.rows,i=0;i<1;i++)for(var rowData=[],cols=rows[i].cells,columnIndexInModel=0,j=0;j<cols.length&&columnIndexInModel<columns.length;j++){columns[columnIndexInModel].headerRenderer._render(-1,columnIndexInModel,cols[j],columns[columnIndexInModel].label);
var colspan=parseInt(cols[j].getAttribute("colspan"));columnIndexInModel+=colspan>1?colspan:1}},EditableGrid.prototype.mouseClicked=function(e){with(e=e||window.event,this){for(var target=e.target||e.srcElement;target&&"A"!=target.tagName&&"TD"!=target.tagName&&"TH"!=target.tagName;)target=target.parentNode;if(!target||!target.parentNode||!target.parentNode.parentNode||"TBODY"!=target.parentNode.parentNode.tagName&&"THEAD"!=target.parentNode.parentNode.tagName||target.isEditing)return;if("A"==target.tagName)return;var rowIndex=getRowIndex(target.parentNode),columnIndex=target.cellIndex;editCell(rowIndex,columnIndex)}},EditableGrid.prototype.editCell=function(rowIndex,columnIndex){var target=this.getCell(rowIndex,columnIndex);with(this){var column=columns[columnIndex];column&&(rowIndex>-1&&(rowSelected(lastSelectedRowIndex,rowIndex),lastSelectedRowIndex=rowIndex),column.editable?rowIndex<0?column.headerEditor&&isHeaderEditable(rowIndex,columnIndex)&&column.headerEditor.edit(rowIndex,columnIndex,target,column.label):column.cellEditor&&isEditable(rowIndex,columnIndex)&&column.cellEditor.edit(rowIndex,columnIndex,target,getValueAt(rowIndex,columnIndex)):readonlyWarning(column))}},EditableGrid.prototype.sortColumns=function(headerArray){with(this){newColumns=[],newColumnIndices=[];for(var i=0;i<headerArray.length;i++){if(columnIndex=this.getColumnIndex(headerArray[i]),columnIndex==-1)return console.error("[sortColumns] Invalid column: "+columnIndex),!1;newColumns[i]=this.columns[columnIndex],newColumnIndices[i]=columnIndex}this.columns=newColumns;for(var i=0;i<this.data.length;i++){for(var myData=this.data[i],myDataColumns=myData.columns,newDataColumns=[],j=0;j<myDataColumns.length;j++)newIndex=newColumnIndices[j],newDataColumns[j]=myDataColumns[newIndex];this.data[i].columns=newDataColumns}return!0}},EditableGrid.prototype.sort=function(columnIndexOrName,descending,backOnFirstPage){with(this){if("undefined"==typeof columnIndexOrName&&sortedColumnName===-1)return tableSorted(-1,sortDescending),!0;if("undefined"==typeof columnIndexOrName&&(columnIndexOrName=sortedColumnName),"undefined"==typeof descending&&(descending=sortDescending),localset("sortColumnIndexOrName",columnIndexOrName),localset("sortDescending",descending),serverSide)return backOnFirstPage?setPageIndex(0):refreshGrid();var columnIndex=columnIndexOrName;if(parseInt(columnIndex,10)!==-1&&(columnIndex=this.getColumnIndex(columnIndexOrName),columnIndex<0))return console.error("[sort] Invalid column: "+columnIndexOrName),!1;if(!enableSort)return void tableSorted(columnIndex,descending);var filterActive=null!=dataUnfiltered;filterActive&&(data=dataUnfiltered);for(var type=columnIndex<0?"":getColumnType(columnIndex),row_array=[],rowCount=getRowCount(),i=0;i<rowCount-(ignoreLastRow?1:0);i++)row_array.push([columnIndex<0?null:getDisplayValueAt(i,columnIndex),i,data[i].originalIndex]);var sort_function="integer"==type||"double"==type?sort_numeric:"boolean"==type?sort_boolean:"date"==type?sort_date:sort_alpha;row_array.sort(columnIndex<0?unsort:sort_stable(sort_function,descending)),ignoreLastRow&&row_array.push([columnIndex<0?null:getDisplayValueAt(rowCount-1,columnIndex),rowCount-1,data[rowCount-1].originalIndex]);var _data=data;data=[];for(var i=0;i<row_array.length;i++)data.push(_data[row_array[i][1]]);if(delete row_array,filterActive){dataUnfiltered=data,data=[];for(var r=0;r<rowCount;r++)dataUnfiltered[r].visible&&data.push(dataUnfiltered[r])}return backOnFirstPage?setPageIndex(0):refreshGrid(),tableSorted(columnIndex,descending),!0}},EditableGrid.prototype.filter=function(filterString,cols){with(this){if("undefined"!=typeof filterString&&(this.currentFilter=filterString,this.localset("filter",filterString)),serverSide)return setPageIndex(0);if(null==currentFilter||""==currentFilter){if(null!=dataUnfiltered){data=dataUnfiltered,dataUnfiltered=null;for(var r=0;r<getRowCount();r++)data[r].visible=!0;setPageIndex(0),tableFiltered()}return}var words=currentFilter.toLowerCase().split(" ");null!=dataUnfiltered&&(data=dataUnfiltered);for(var rowCount=getRowCount(),columnCount="undefined"!=typeof cols?cols.length:getColumnCount(),r=0;r<rowCount;r++){var row=data[r];row.visible=!0;for(var rowContent="",c=0;c<columnCount;c++)if("boolean"!=getColumnType(c)){var displayValue=getDisplayValueAt(r,"undefined"!=typeof cols?cols[c]:c),value=getValueAt(r,"undefined"!=typeof cols?cols[c]:c);rowContent+=displayValue+" "+(displayValue==value?"":value+" ")}for(var attributeName in row)"visible"!=attributeName&&"originalIndex"!=attributeName&&"columns"!=attributeName&&(rowContent+=row[attributeName]);for(var i=0;i<words.length;i++){var word=words[i],match=!1,invertMatch=word.startsWith("!");invertMatch&&(word=word.substr(1));var colindex=-1,attributeName=null;if(word.contains("!=")){var parts=word.split("!=");colindex=getColumnIndex(parts[0]),colindex>=0?(word=parts[1],invertMatch=!invertMatch):"undefined"!=typeof row[parts[0]]&&(attributeName=parts[0],word=parts[1],invertMatch=!invertMatch)}else if(word.contains("=")){var parts=word.split("=");colindex=getColumnIndex(parts[0]),colindex>=0?word=parts[1]:"undefined"!=typeof row[parts[0]]&&(attributeName=parts[0],word=parts[1])}if(word.endsWith("!"))if(word=word.substr(0,word.length-1),colindex>=0)match=(""+getDisplayValueAt(r,colindex)).trim().toLowerCase()==word||(""+getValueAt(r,colindex)).trim().toLowerCase()==word;else if(null!==attributeName)match=(""+getRowAttribute(r,attributeName)).trim().toLowerCase()==word;else for(var c=0;c<columnCount;c++)"boolean"!=getColumnType("undefined"!=typeof cols?cols[c]:c)&&((""+getDisplayValueAt(r,"undefined"!=typeof cols?cols[c]:c)).trim().toLowerCase()!=word&&(""+getValueAt(r,"undefined"!=typeof cols?cols[c]:c)).trim().toLowerCase()!=word||(match=!0));else match=colindex>=0?(getValueAt(r,colindex)+" "+getDisplayValueAt(r,colindex)).trim().toLowerCase().indexOf(word)>=0:null!==attributeName?(""+getRowAttribute(r,attributeName)).trim().toLowerCase().indexOf(word)>=0:rowContent.toLowerCase().indexOf(word)>=0;if(invertMatch?match:!match){data[r].visible=!1;break}}}dataUnfiltered=data,data=[];for(var r=0;r<rowCount;r++)dataUnfiltered[r].visible&&data.push(dataUnfiltered[r]);setPageIndex(0),tableFiltered()}},EditableGrid.prototype.setPageSize=function(a){this.pageSize=parseInt(a),isNaN(this.pageSize)&&(this.pageSize=0),this.currentPageIndex=0,this.refreshGrid()},EditableGrid.prototype.getPageCount=function(){return 0==this.getRowCount()?0:this.pageCount>0?this.pageCount:this.pageSize<=0?1:Math.ceil(this.getRowCount()/this.pageSize)},EditableGrid.prototype.getCurrentPageIndex=function(){return this.pageSize<=0&&!this.serverSide?0:Math.max(0,this.currentPageIndex>=this.getPageCount()?this.getPageCount()-1:this.currentPageIndex)},EditableGrid.prototype.setPageIndex=function(a){this.currentPageIndex=a,this.localset("pageIndex",a),this.refreshGrid()},EditableGrid.prototype.prevPage=function(){this.canGoBack()&&this.setPageIndex(this.getCurrentPageIndex()-1)},EditableGrid.prototype.firstPage=function(){this.canGoBack()&&this.setPageIndex(0)},EditableGrid.prototype.nextPage=function(){this.canGoForward()&&this.setPageIndex(this.getCurrentPageIndex()+1)},EditableGrid.prototype.lastPage=function(){this.canGoForward()&&this.setPageIndex(this.getPageCount()-1)},EditableGrid.prototype.canGoBack=function(){return this.getCurrentPageIndex()>0},EditableGrid.prototype.canGoForward=function(){return this.getCurrentPageIndex()<this.getPageCount()-1},EditableGrid.prototype.getSlidingPageInterval=function(a){var b=this.getPageCount();if(b<=1)return null;var c=this.getCurrentPageIndex(),d=Math.max(0,c-Math.floor(a/2)),e=Math.min(b-1,c+Math.floor(a/2));if(e-d<a){var f=a-(e-d+1);d=Math.max(0,d-f),e=Math.min(b-1,e+f)}return{startPageIndex:d,endPageIndex:e}},EditableGrid.prototype.getPagesInInterval=function(a,b){for(var c=[],d=a.startPageIndex;d<=a.endPageIndex;d++)c.push("function"==typeof b?b(d,d==this.getCurrentPageIndex()):d);return c};
/**
 * Abstract cell renderer
 * @constructor
 * @class Base class for all cell renderers
 * @param {Object} config
 */

function CellRenderer(config) { this.init(config); }

CellRenderer.prototype.init = function(config)
{
	// override default properties with the ones given
	for (var p in config) this[p] = config[p];
};

CellRenderer.prototype._render = function(rowIndex, columnIndex, element, value)
{
	// remember all the things we need
	element.rowIndex = rowIndex;
	element.columnIndex = columnIndex;

	// remove existing content
	while (element.hasChildNodes()) element.removeChild(element.firstChild);

	// clear isEditing (in case a currently editeed is being re-rendered by some external call)
	element.isEditing = false;

	// always apply the number class to numerical cells and column headers
	if (this.column.isNumerical()) EditableGrid.prototype.addClassName(element, "number");

	// always apply the boolean class to boolean column headers
	if (this.column.datatype == 'boolean') EditableGrid.prototype.addClassName(element, "boolean");

	// apply a css class corresponding to the column name
	EditableGrid.prototype.addClassName(element, "editablegrid-" + this.column.name);

	// add a data-title attribute used for responsiveness
	element.setAttribute('data-title', this.column.label);

	// call the specialized render method
	return this.render(element, typeof value == 'string' && this.column.datatype != "html" ? (value === null ? null : htmlspecialchars(value, 'ENT_NOQUOTES').replace(/  /g, ' &nbsp;')) : value);
};

CellRenderer.prototype.render = function(element, value, escapehtml)
{
	var _value = escapehtml ? (typeof value == 'string' && this.column.datatype != "html" ? (value === null ? null : htmlspecialchars(value, 'ENT_NOQUOTES').replace(/  /g, ' &nbsp;')) : value) : value;
	element.innerHTML = _value ? _value : "";
};

CellRenderer.prototype.getDisplayValue = function(rowIndex, value)
{
	return value;
};

/**
 * Enum cell renderer
 * @constructor
 * @class Class to render a cell with enum values
 */

function EnumCellRenderer(config) { this.init(config); }
EnumCellRenderer.prototype = new CellRenderer();
EnumCellRenderer.prototype.getLabel = function(rowIndex, value)
{
	var label = null;
	if (typeof value != 'undefined') {
		value = value ? value : '';
		var optionValues = this.column.getOptionValuesForRender(rowIndex);
		if (optionValues && value in optionValues) label = optionValues[value];
		if (label === null) {
			var isNAN = typeof value == 'number' && isNaN(value);
			label = isNAN ? "" : value;
		}
	}
	return label ? label : '';
};

EnumCellRenderer.prototype.render = function(element, value)
{
	var label = this.getLabel(element.rowIndex, value);
	element.innerHTML = label ? (this.column.datatype != "html" ? htmlspecialchars(label, 'ENT_NOQUOTES').replace(/\s\s/g, '&nbsp; ') : label) : '';
};

EnumCellRenderer.prototype.getDisplayValue = function(rowIndex, value)
{
	// if the column has enumerated values, sort and filter on the value label
	return value === null ? null : this.getLabel(rowIndex, value);
};

/**
 * Number cell renderer
 * @constructor
 * @class Class to render a cell with numerical values
 */

function NumberCellRenderer(config) { this.init(config); }
NumberCellRenderer.prototype = new CellRenderer();
NumberCellRenderer.prototype.render = function(element, value)
{
	var column = this.column || {}; // in case somebody calls new NumberCellRenderer().render(..)

	var isNAN = value === null || (typeof value == 'number' && isNaN(value));
	var displayValue = isNAN ? (column.nansymbol || "") : value;
	if (typeof displayValue == 'number') {

		if (column.precision !== null) {
			// displayValue = displayValue.toFixed(column.precision);
			displayValue = number_format(displayValue, column.precision, column.decimal_point, column.thousands_separator);
		}

		if (column.unit !== null) {
			if (column.unit_before_number) displayValue = column.unit + ' ' + displayValue;
			else displayValue = displayValue + ' ' + column.unit;
		}
	}

	element.innerHTML = displayValue;
	if (isNAN) EditableGrid.prototype.addClassName(element, "nan");
	else EditableGrid.prototype.removeClassName(element, "nan");
};

/**
 * Checkbox cell renderer
 * @constructor
 * @class Class to render a cell with an HTML checkbox
 */

function CheckboxCellRenderer(config) { this.init(config); }
CheckboxCellRenderer.prototype = new CellRenderer();

CheckboxCellRenderer.prototype._render = function(rowIndex, columnIndex, element, value)
{
	// if a checkbox already exists keep it, otherwise clear current content
	if (element.firstChild && (typeof element.firstChild.getAttribute != "function" || element.firstChild.getAttribute("type") != "checkbox"))
		while (element.hasChildNodes()) element.removeChild(element.firstChild);

	// remember all the things we need
	element.rowIndex = rowIndex;
	element.columnIndex = columnIndex;

	// apply a css class corresponding to the column name
	EditableGrid.prototype.addClassName(element, "editablegrid-" + this.column.name);

	// add a data-title attribute used for responsiveness
	element.setAttribute('data-title', this.column.label);

	// call the specialized render method
	return this.render(element, value);
};

CheckboxCellRenderer.prototype.render = function(element, value)
{
	// convert value to boolean just in case
	value = (value && value != 0 && value != "false") ? true : false;

	// if check box already created, just update its state
	if (element.firstChild) { element.firstChild.checked = value; return; }

	// create and initialize checkbox
	var htmlInput = document.createElement("input");
	htmlInput.setAttribute("type", "checkbox");

	// give access to the cell editor and element from the editor field
	htmlInput.element = element;
	htmlInput.cellrenderer = this;

	// this renderer is a little special because it allows direct edition
	var cellEditor = new CellEditor();
	cellEditor.editablegrid = this.editablegrid;
	cellEditor.column = this.column;
	htmlInput.onclick = function(event) {
		element.rowIndex = this.cellrenderer.editablegrid.getRowIndex(element.parentNode); // in case it has changed due to sorting or remove
		element.isEditing = true;
		cellEditor.applyEditing(element, htmlInput.checked ? true : false);
	};

	element.appendChild(htmlInput);
	htmlInput.checked = value;
	htmlInput.disabled = (!this.column.editable || !this.editablegrid.isEditable(element.rowIndex, element.columnIndex));

	EditableGrid.prototype.addClassName(element, "boolean");
};

/**
 * Email cell renderer
 * @constructor
 * @class Class to render a cell with emails
 */

function EmailCellRenderer(config) { this.init(config); }
EmailCellRenderer.prototype = new CellRenderer();
EmailCellRenderer.prototype.render = function(element, value)
{
	element.innerHTML = value ? "<a href='mailto:" + value + "'>" + value + "</a>" : "";
};

/**
 * Website cell renderer
 * @constructor
 * @class Class to render a cell with websites
 */

function WebsiteCellRenderer(config) { this.init(config); }
WebsiteCellRenderer.prototype = new CellRenderer();
WebsiteCellRenderer.prototype.render = function(element, value)
{
	element.innerHTML = value ? "<a href='" + (value.indexOf("//") == -1 ? "http://" + value : value) + "'>" + value + "</a>" : "";
};

/**
 * Date cell renderer
 * @constructor
 * @class Class to render a cell containing a date
 */

function DateCellRenderer(config) { this.init(config); }
DateCellRenderer.prototype = new CellRenderer;

DateCellRenderer.prototype.render = function(cell, value)
{
	var date = this.editablegrid.checkDate(value);
	if (typeof date == "object") cell.innerHTML = date.formattedDate;
	else cell.innerHTML = value ? value : "";
	cell.style.whiteSpace = 'nowrap';
};

/**
 * Sort header renderer
 * @constructor
 * @class Class to add sorting functionalities to headers
 */

function SortHeaderRenderer(columnName, cellRenderer) { this.columnName = columnName; this.cellRenderer = cellRenderer; };
SortHeaderRenderer.prototype = new CellRenderer();
SortHeaderRenderer.prototype.render = function(cell, value)
{
	if (!value) { if (this.cellRenderer) this.cellRenderer.render(cell, value); }
	else {

		// create a link that will sort (alternatively ascending/descending)
		var link = document.createElement("a");
		cell.appendChild(link);
		link.columnName = this.columnName;
		link.style.cursor = "pointer";
		link.innerHTML = value;
		link.editablegrid = this.editablegrid;
		link.renderer = this;
		link.onclick = function() {
			with (this.editablegrid) {

				var cols = tHead.rows[0].cells;
				var clearPrevious = -1;
				var backOnFirstPage = false;

				if (sortedColumnName != this.columnName) {
					clearPrevious = sortedColumnName;
					sortedColumnName = this.columnName;
					sortDescending = false;
					backOnFirstPage = true;
				}
				else {
					if (!sortDescending) sortDescending = true;
					else {
						clearPrevious = sortedColumnName;
						sortedColumnName = -1;
						sortDescending = false;
						backOnFirstPage = true;
					}
				}

				// render header for previous sort column (not needed anymore since the grid is now fully refreshed after a sort - cf. possible pagination)
				// var j = getColumnIndex(clearPrevious);
				// if (j >= 0) columns[j].headerRenderer._render(-1, j, cols[j], columns[j].label);

				sort(sortedColumnName, sortDescending, backOnFirstPage);

				// render header for new sort column (not needed anymore since the grid is now fully refreshed after a sort - cf. possible pagination)
				// var j = getColumnIndex(sortedColumnName);
				// if (j >= 0) columns[j].headerRenderer._render(-1, j, cols[j], columns[j].label);
			}
		};

		// add an arrow to indicate if sort is ascending or descending
		if (this.editablegrid.sortedColumnName == this.columnName) {
			cell.appendChild(document.createTextNode("\u00a0"));
			cell.appendChild(this.editablegrid.sortDescending ? this.editablegrid.sortDownElement: this.editablegrid.sortUpElement);
		}

		// call user renderer if any
		if (this.cellRenderer) this.cellRenderer.render(cell, value);
	}
};

function WeightCellRenderer(config) { this.init(config); }
WeightCellRenderer.prototype = new CellRenderer();
WeightCellRenderer.prototype.render = function(element, value)
{
	var unit = this.unit;
	if('KG' == unit){
		element.className += " weightKG";
	}else{
		element.className += " weightLB";
	}
};

function CellEditor(a){this.init(a)}function TextCellEditor(a,b,c){a&&(this.fieldSize=a),b&&(this.maxLength=b),c&&this.init(c)}function NumberCellEditor(a,b){this.type=a,this.init(b)}function SelectCellEditor(a){this.minWidth=75,this.minHeight=22,this.adaptHeight=!0,this.adaptWidth=!0,this.init(a)}function DateCellEditor(a){this.init(a)}CellEditor.prototype.init=function(a){if(a)for(var b in a)this[b]=a[b]},CellEditor.prototype.edit=function(a,b,c,d){c.isEditing=!0,c.rowIndex=a,c.columnIndex=b;var e=this.getEditor(c,d);return!!e&&(e.element=c,e.celleditor=this,e.onkeydown=function(a){if(a=a||window.event,13==a.keyCode||9==a.keyCode){if(this.onblur_backup=this.onblur,this.onblur=null,this.celleditor.applyEditing(this.element,this.celleditor.getEditorValue(this))===!1&&(this.onblur=this.onblur_backup),9==a.keyCode&&this.element.rowIndex>=0&&this.celleditor.editablegrid.getColumnCount()>0&&this.celleditor.editablegrid.getRowCount()>0)for(var b=this.element.rowIndex,c=this.element.columnIndex;;){c<this.celleditor.editablegrid.getColumnCount()-1?c++:(b++,c=0),this.celleditor.editablegrid.getRow(b)||(b=0);var d=this.celleditor.editablegrid.getColumn(c);if(d.editable&&"boolean"!=d.datatype&&this.celleditor.editablegrid.isEditable(b,c)){this.celleditor.editablegrid.editCell(b,c);break}if(b==this.element.rowIndex&&c==this.element.columnIndex)break}return!1}if(27==a.keyCode)return this.onblur=null,this.celleditor.cancelEditing(this.element),!1},this.editablegrid.allowSimultaneousEdition||(e.onblur=this.editablegrid.saveOnBlur?function(a){this.onblur_backup=this.onblur,this.onblur=null,this.celleditor.applyEditing(this.element,this.celleditor.getEditorValue(this))===!1&&(this.onblur=this.onblur_backup)}:function(a){this.onblur=null,this.celleditor.cancelEditing(this.element)}),this.displayEditor(c,e),void this.autoFocus(e))},CellEditor.prototype.autoFocus=function(a){a.focus()},CellEditor.prototype.getEditor=function(a,b){return null},CellEditor.prototype.getEditorValue=function(a){return a.value},CellEditor.prototype.formatValue=function(a){return a},CellEditor.prototype.displayEditor=function(a,b,c,d){if(b.style.fontFamily=this.editablegrid.getStyle(a,"fontFamily","font-family"),b.style.fontSize=this.editablegrid.getStyle(a,"fontSize","font-size"),"static"==this.editablegrid.editmode){for(;a.hasChildNodes();)a.removeChild(a.firstChild);a.appendChild(b)}if("absolute"==this.editablegrid.editmode){a.appendChild(b),b.style.position="absolute";var e=this.editablegrid.paddingLeft(a),f=this.editablegrid.paddingTop(a),g=this.editablegrid.getScrollXOffset(a),h=this.editablegrid.getScrollYOffset(a),i="middle"==this.editablegrid.verticalAlign(a)?(a.offsetHeight-b.offsetHeight)/2-f:0;if(b.style.left=this.editablegrid.getCellX(a)-g+e+(c?c:0)+"px",b.style.top=this.editablegrid.getCellY(a)-h+f+i+(d?d:0)+"px","integer"==this.column.datatype||"double"==this.column.datatype){var j=this.editablegrid.getCellX(a)-g+a.offsetWidth-(parseInt(b.style.left)+b.offsetWidth);b.style.left=parseInt(b.style.left)+j+"px",b.style.textAlign="right"}}if("fixed"==this.editablegrid.editmode){for(var k=_$(this.editablegrid.editorzoneid);k.hasChildNodes();)k.removeChild(k.firstChild);k.appendChild(b)}a&&a.isEditing&&this.editablegrid.openedCellEditor&&this.editablegrid.openedCellEditor(a.rowIndex,a.columnIndex)},CellEditor.prototype._clearEditor=function(a){if(a.isEditing=!1,"fixed"==this.editablegrid.editmode)for(var b=_$(this.editablegrid.editorzoneid);b.hasChildNodes();)b.removeChild(b.firstChild)},CellEditor.prototype.cancelEditing=function(element){with(this)if(element&&element.isEditing){var renderer=this==column.headerEditor?column.headerRenderer:column.cellRenderer;renderer._render(element.rowIndex,element.columnIndex,element,editablegrid.getValueAt(element.rowIndex,element.columnIndex)),_clearEditor(element)}},CellEditor.prototype.applyEditing=function(element,newValue){with(this){if(element&&element.isEditing){if(!column.isValid(newValue))return!1;var formattedValue=formatValue(newValue),previousValue=editablegrid.setValueAt(element.rowIndex,element.columnIndex,formattedValue),newValue=editablegrid.getValueAt(element.rowIndex,element.columnIndex);return this.editablegrid.isSame(newValue,previousValue)||editablegrid.modelChanged(element.rowIndex,element.columnIndex,previousValue,newValue,editablegrid.getRow(element.rowIndex)),_clearEditor(element),!0}return!1}},TextCellEditor.prototype=new CellEditor,TextCellEditor.prototype.fieldSize=-1,TextCellEditor.prototype.maxLength=-1,TextCellEditor.prototype.autoHeight=!0,TextCellEditor.prototype.editorValue=function(a){return a},TextCellEditor.prototype.updateStyle=function(a){this.column.isValid(this.getEditorValue(a))?this.editablegrid.removeClassName(a,this.editablegrid.invalidClassName):this.editablegrid.addClassName(a,this.editablegrid.invalidClassName)},TextCellEditor.prototype.getEditor=function(a,b){var c=document.createElement("input");c.setAttribute("type","text"),this.maxLength>0&&c.setAttribute("maxlength",this.maxLength),this.fieldSize>0?c.setAttribute("size",this.fieldSize):c.style.width=this.editablegrid.autoWidth(a)+"px";var d=this.editablegrid.autoHeight(a);return this.autoHeight&&(c.style.height=d+"px"),c.value=this.editorValue(b),c.onkeyup=function(a){this.celleditor.updateStyle(this)},c},TextCellEditor.prototype.displayEditor=function(a,b){CellEditor.prototype.displayEditor.call(this,a,b,-1*this.editablegrid.borderLeft(b),-1*(this.editablegrid.borderTop(b)+1)),this.updateStyle(b),b.select()},NumberCellEditor.prototype=new TextCellEditor(-1,32),NumberCellEditor.prototype.editorValue=function(a){return null===a||isNaN(a)?"":(a+"").replace(".",this.column.decimal_point)},NumberCellEditor.prototype.getEditorValue=function(a){return a.value.replace(",",".")},NumberCellEditor.prototype.formatValue=function(a){return"integer"==this.type?parseInt(a):parseFloat(a)},SelectCellEditor.prototype=new CellEditor,SelectCellEditor.prototype.isValueSelected=function(a,b,c){return!b&&!c||b==c},SelectCellEditor.prototype.getEditor=function(a,b){var c=this,d=document.createElement("select");this.adaptWidth&&"undefined"==typeof jQuery.fn.select2&&(d.style.width=Math.max(this.minWidth,this.editablegrid.autoWidth(a))+"px"),this.adaptHeight&&"undefined"==typeof jQuery.fn.select2&&(d.style.height=Math.max(this.minHeight,this.editablegrid.autoHeight(a))+"px");for(var e=this.column.getOptionValuesForEdit(a.rowIndex),f=0,g=!1,h=0;h<e.length;h++){var i=e[h];if("object"==typeof i.values){var j=document.createElement("optgroup");j.label=i.label,d.appendChild(j);for(var k=0;k<i.values.length;k++){var l=i.values[k],m=document.createElement("option");m.text=l.label,m.value=l.value?l.value:"",j.appendChild(m),this.isValueSelected(d,l.value,b)?(m.selected=!0,g=!0):m.selected=!1,f++}}else{var m=document.createElement("option");m.text=i.label,m.value=i.value?i.value:"";try{d.add(m,null)}catch(a){d.add(m)}this.isValueSelected(d,i.value,b)?(m.selected=!0,g=!0):m.selected=!1,f++}}if(!g){var m=document.createElement("option");m.text=b?b:"",m.value=b?b:"";try{d.add(m,d.options[0])}catch(a){d.add(m)}d.selectedIndex=0}return d.onchange=function(a){this.onblur=null,this.celleditor.applyEditing(this.element,c.getEditorValue(this))},d},SelectCellEditor.prototype.displayEditor=function(a,b){CellEditor.prototype.displayEditor.call(this,a,b),"undefined"!=typeof jQuery.fn.select2&&(b.onblur=null,b.onchange=null,jQuery(b).select2({dropdownAutoWidth:!0,minimumResultsForSearch:10}),jQuery(b).siblings("span.select2-container").css("position","absolute").css("left",b.style.left),jQuery(b).select2("open"),jQuery(b).on("select2:close",function(){this.celleditor.applyEditing(this.element,this.celleditor.getEditorValue(this))}).on("select2-blur",function(){this.celleditor.applyEditing(this.element,this.celleditor.getEditorValue(this))}).on("select2-close",function(){this.celleditor.applyEditing(this.element,this.celleditor.getEditorValue(this))}))},SelectCellEditor.prototype.autoFocus=function(a){return"undefined"!=typeof jQuery.fn.select2||CellEditor.prototype.autoFocus.call(this,a)},SelectCellEditor.prototype.getEditorValue=function(a){return"undefined"!=typeof jQuery.fn.select2?jQuery(a).val():CellEditor.prototype.getEditorValue.call(this,a)},SelectCellEditor.prototype.cancelEditing=function(a){"undefined"!=typeof jQuery.fn.select2&&jQuery(a).find("select").select2("destroy"),CellEditor.prototype.cancelEditing.call(this,a)},DateCellEditor.prototype=new TextCellEditor,DateCellEditor.prototype.displayEditor=function(a,b){TextCellEditor.prototype.displayEditor.call(this,a,b),jQuery(b).datepicker({dateFormat:"EU"==this.editablegrid.dateFormat?"dd/mm/yy":"mm/dd/yy",changeMonth:!0,changeYear:!0,yearRange:"c-100:c+10",beforeShow:function(){this.onblur_backup=this.onblur,this.onblur=null},onClose:function(a){""!=a?this.celleditor.applyEditing(b.element,a):null!=this.onblur_backup&&this.onblur_backup()}}).datepicker("show")};
/**
 * Abstract cell validator
 * @constructor
 * @class Base class for all cell validators
 */

function CellValidator(config) 
{
	// default properties
    var props = { isValid: null };

    // override default properties with the ones given
    for (var p in props) if (typeof config != 'undefined' && typeof config[p] != 'undefined') this[p] = config[p];
}

CellValidator.prototype.isValid = function(value) 
{
	return true;
};

/**
 * Number cell validator
 * @constructor
 * @class Class to validate a numeric cell
 */

function NumberCellValidator(type) { this.type = type; }
NumberCellValidator.prototype = new CellValidator;
NumberCellValidator.prototype.isValid = function(value) 
{
	// check that it is a valid number
	if (isNaN(value)) return false;
	
	// for integers check that it's not a float
	if (this.type == "integer" && value != "" && parseInt(value) != parseFloat(value)) return false;
	
	// the integer or double is valid
	return true;
};

/**
 * Email cell validator
 * @constructor
 * @class Class to validate a cell containing an email
 */

function EmailCellValidator() {}
EmailCellValidator.prototype = new CellValidator;
EmailCellValidator.prototype.isValid = function(value) { return value == "" || /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/.test(value); };

/**
 * Website cell validator
 * @constructor
 * @class Class to validate a cell containing a website
 */

function WebsiteCellValidator() {}
WebsiteCellValidator.prototype = new CellValidator;
WebsiteCellValidator.prototype.isValid = function(value) { return value == "" || (value.indexOf(".") > 0 && value.indexOf(".") < (value.length - 2)); };

/**
 * Date cell validator
 * @constructor
 * @augments CellValidator
 * @class Class to validate a cell containing a date
 */

function DateCellValidator(grid) { this.grid = grid; }
DateCellValidator.prototype = new CellValidator;

DateCellValidator.prototype.isValid = function(value) 
{
	return value == "" || typeof this.grid.checkDate(value) == "object";
};function LeapYear(a){if(a%100==0){if(a%400==0)return!0}else if(a%4==0)return!0;return!1}function get_html_translation_table(a,b){var c={},d={},e=0,f="",g={},h={},i={},j={};if(g[0]="HTML_SPECIALCHARS",g[1]="HTML_ENTITIES",h[0]="ENT_NOQUOTES",h[2]="ENT_COMPAT",h[3]="ENT_QUOTES",i=isNaN(a)?a?a.toUpperCase():"HTML_SPECIALCHARS":g[a],j=isNaN(b)?b?b.toUpperCase():"ENT_COMPAT":h[b],"HTML_SPECIALCHARS"!==i&&"HTML_ENTITIES"!==i)throw new Error("Table: "+i+" not supported");"HTML_ENTITIES"===i&&(c[160]="&nbsp;",c[161]="&iexcl;",c[162]="&cent;",c[163]="&pound;",c[164]="&curren;",c[165]="&yen;",c[166]="&brvbar;",c[167]="&sect;",c[168]="&uml;",c[169]="&copy;",c[170]="&ordf;",c[171]="&laquo;",c[172]="&not;",c[173]="&shy;",c[174]="&reg;",c[175]="&macr;",c[176]="&deg;",c[177]="&plusmn;",c[178]="&sup2;",c[179]="&sup3;",c[180]="&acute;",c[181]="&micro;",c[182]="&para;",c[183]="&middot;",c[184]="&cedil;",c[185]="&sup1;",c[186]="&ordm;",c[187]="&raquo;",c[188]="&frac14;",c[189]="&frac12;",c[190]="&frac34;",c[191]="&iquest;",c[192]="&Agrave;",c[193]="&Aacute;",c[194]="&Acirc;",c[195]="&Atilde;",c[196]="&Auml;",c[197]="&Aring;",c[198]="&AElig;",c[199]="&Ccedil;",c[200]="&Egrave;",c[201]="&Eacute;",c[202]="&Ecirc;",c[203]="&Euml;",c[204]="&Igrave;",c[205]="&Iacute;",c[206]="&Icirc;",c[207]="&Iuml;",c[208]="&ETH;",c[209]="&Ntilde;",c[210]="&Ograve;",c[211]="&Oacute;",c[212]="&Ocirc;",c[213]="&Otilde;",c[214]="&Ouml;",c[215]="&times;",c[216]="&Oslash;",c[217]="&Ugrave;",c[218]="&Uacute;",c[219]="&Ucirc;",c[220]="&Uuml;",c[221]="&Yacute;",c[222]="&THORN;",c[223]="&szlig;",c[224]="&agrave;",c[225]="&aacute;",c[226]="&acirc;",c[227]="&atilde;",c[228]="&auml;",c[229]="&aring;",c[230]="&aelig;",c[231]="&ccedil;",c[232]="&egrave;",c[233]="&eacute;",c[234]="&ecirc;",c[235]="&euml;",c[236]="&igrave;",c[237]="&iacute;",c[238]="&icirc;",c[239]="&iuml;",c[240]="&eth;",c[241]="&ntilde;",c[242]="&ograve;",c[243]="&oacute;",c[244]="&ocirc;",c[245]="&otilde;",c[246]="&ouml;",c[247]="&divide;",c[248]="&oslash;",c[249]="&ugrave;",c[250]="&uacute;",c[251]="&ucirc;",c[252]="&uuml;",c[253]="&yacute;",c[254]="&thorn;",c[255]="&yuml;"),"ENT_NOQUOTES"!==j&&(c[34]="&quot;"),"ENT_QUOTES"===j&&(c[39]="&#39;"),c[60]="&lt;",c[62]="&gt;";for(e in c)f=String.fromCharCode(e),d[f]=c[e];return d}function htmlentities(a,b){var c={},d="",e="";if(e=a.toString(),!1===(c=this.get_html_translation_table("HTML_ENTITIES",b)))return!1;e=e.split("&").join("&amp;"),c["'"]="&#039;";for(d in c)e=e.split(d).join(c[d]);return e}function htmlspecialchars(a,b){var c={},d="",e="";if(e=a.toString(),!1===(c=this.get_html_translation_table("HTML_SPECIALCHARS",b)))return!1;e=e.split("&").join("&amp;");for(d in c)e=e.split(d).join(c[d]);return e}function number_format(a,b,c,d){a=(a+"").replace(/[^0-9+\-Ee.]/g,"");var e=isFinite(+a)?+a:0,f=isFinite(+b)?b:0,g="undefined"==typeof d?",":d,h="undefined"==typeof c?".":c,i="",j=function(a,b){var c=Math.pow(10,b);return""+Math.round(a*c)/c};return i=(f<0?""+e:f?j(e,f):""+Math.round(e)).split("."),i[0].length>3&&(i[0]=i[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,g)),(i[1]||"").length<f&&(i[1]=i[1]||"",i[1]+=new Array(f-i[1].length+1).join("0")),i.join(h)}EditableGrid.prototype._convertOptions=function(a){if(null!==a&&!(a instanceof Array)&&"object"==typeof a){var b=[];for(var c in a)"object"==typeof a[c]?b.push({label:c,values:this._convertOptions(a[c])}):b.push({value:c,label:a[c]});a=b}return a},EditableGrid.prototype.setCookie=function(a,b,c){var d=new Date;d.setDate(d.getDate()+c);var e=escape(b)+(null==c?"":"; expires="+d.toUTCString());document.cookie=a+"="+e},EditableGrid.prototype.getCookie=function(a){for(var b=document.cookie.split(";"),c=0;c<b.length;c++){var d=b[c].substr(0,b[c].indexOf("=")),e=b[c].substr(b[c].indexOf("=")+1);if(d=d.replace(/^\s+|\s+$/g,""),d==a)return unescape(e)}return null},EditableGrid.prototype.has_local_storage=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},EditableGrid.prototype._localset=function(a,b){this.has_local_storage()?localStorage.setItem(a,b):this.setCookie(a,b,null)},EditableGrid.prototype._localunset=function(a){this.has_local_storage()?localStorage.removeItem(a):this.setCookie(a,null,null)},EditableGrid.prototype._localget=function(a){return this.has_local_storage()?localStorage.getItem(a):this.getCookie(a)},EditableGrid.prototype._localisset=function(a){return this.has_local_storage()?null!==localStorage.getItem(a)&&"undefined"!=localStorage.getItem(a):null!==this.getCookie(a)},EditableGrid.prototype.localset=function(a,b){if(this.enableStore)return this._localset(this.name+"_"+a,b)},EditableGrid.prototype.localunset=function(a){if(this.enableStore)return this._localunset(this.name+"_"+a,value)},EditableGrid.prototype.localget=function(a){return this.enableStore?this._localget(this.name+"_"+a):null},EditableGrid.prototype.localisset=function(a){return!!this.enableStore&&null!==this._localget(this.name+"_"+a)},EditableGrid.prototype.unsort=function(a,b){return aa=isNaN(a[2])?0:parseFloat(a[2]),bb=isNaN(b[2])?0:parseFloat(b[2]),aa-bb},EditableGrid.prototype.sort_stable=function(a,b){return function(c,d){var e=b?a(d,c):a(c,d);return 0!=e?e:EditableGrid.prototype.unsort(c,d)}},EditableGrid.prototype.sort_numeric=function(a,b){return aa=isNaN(parseFloat(a[0]))?0:parseFloat(a[0]),bb=isNaN(parseFloat(b[0]))?0:parseFloat(b[0]),aa-bb},EditableGrid.prototype.sort_boolean=function(a,b){return aa=a[0]&&"false"!=a[0]?1:0,bb=b[0]&&"false"!=b[0]?1:0,aa-bb},EditableGrid.prototype.sort_alpha=function(a,b){return a[0]||b[0]?a[0]&&!b[0]?1:!a[0]&&b[0]?-1:a[0].toLowerCase()==b[0].toLowerCase()?0:a[0].toLowerCase().localeCompare(b[0].toLowerCase()):0},EditableGrid.prototype.sort_date=function(a,b){return date=EditableGrid.prototype.checkDate(a[0]),aa="object"==typeof date?date.sortDate:0,date=EditableGrid.prototype.checkDate(b[0]),bb="object"==typeof date?date.sortDate:0,aa-bb},EditableGrid.prototype.getStyle=function(a,b,c){return c=c||b,a.currentStyle?a.currentStyle[b]:window.getComputedStyle?document.defaultView.getComputedStyle(a,null).getPropertyValue(c):a.style[b]},EditableGrid.prototype.isStatic=function(a){var b=this.getStyle(a,"position");return!b||"static"==b},EditableGrid.prototype.verticalAlign=function(a){return this.getStyle(a,"verticalAlign","vertical-align")},EditableGrid.prototype.paddingLeft=function(a){var b=parseInt(this.getStyle(a,"paddingLeft","padding-left"));return isNaN(b)?0:Math.max(0,b)},EditableGrid.prototype.paddingRight=function(a){var b=parseInt(this.getStyle(a,"paddingRight","padding-right"));return isNaN(b)?0:Math.max(0,b)},EditableGrid.prototype.paddingTop=function(a){var b=parseInt(this.getStyle(a,"paddingTop","padding-top"));return isNaN(b)?0:Math.max(0,b)},EditableGrid.prototype.paddingBottom=function(a){var b=parseInt(this.getStyle(a,"paddingBottom","padding-bottom"));return isNaN(b)?0:Math.max(0,b)},EditableGrid.prototype.borderLeft=function(a){var b=parseInt(this.getStyle(a,"borderRightWidth","border-right-width")),c=parseInt(this.getStyle(a,"borderLeftWidth","border-left-width"));return b=isNaN(b)?0:b,c=isNaN(c)?0:c,Math.max(b,c)},EditableGrid.prototype.borderRight=function(a){return this.borderLeft(a)},EditableGrid.prototype.borderTop=function(a){var b=parseInt(this.getStyle(a,"borderTopWidth","border-top-width")),c=parseInt(this.getStyle(a,"borderBottomWidth","border-bottom-width"));return b=isNaN(b)?0:b,c=isNaN(c)?0:c,Math.max(b,c)},EditableGrid.prototype.borderBottom=function(a){return this.borderTop(a)},EditableGrid.prototype.autoWidth=function(a){return a.offsetWidth-this.paddingLeft(a)-this.paddingRight(a)-this.borderLeft(a)-this.borderRight(a)},EditableGrid.prototype.autoHeight=function(a){return a.offsetHeight-this.paddingTop(a)-this.paddingBottom(a)-this.borderTop(a)-this.borderBottom(a)},EditableGrid.prototype.detectDir=function(){for(var a=location.href,b=document.getElementsByTagName("base"),c=0;c<b.length;c++)b[c].href&&(a=b[c].href);b=document.getElementsByTagName("script");for(var c=0;c<b.length;c++)if(b[c].src&&/(^|\/)editablegrid[^\/]*\.js([?#].*)?$/i.test(b[c].src)){var d=new URI(b[c].src),e=d.toAbsolute(a);return e.path=e.path.replace(/[^\/]+$/,""),e.path=e.path.replace(/\/$/,""),delete e.query,delete e.fragment,e.toString()}return!1},EditableGrid.prototype.isSame=function(a,b){return a===b||(!("number"!=typeof a||!isNaN(a)||"number"!=typeof b||!isNaN(b))||(""===a&&null===b||""===b&&null===a))},EditableGrid.prototype.strip=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},EditableGrid.prototype.hasClassName=function(a,b){return a.className.length>0&&(a.className==b||new RegExp("(^|\\s)"+b.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"(\\s|$)").test(a.className))},EditableGrid.prototype.addClassName=function(a,b){this.hasClassName(a,b)||(a.className+=(a.className?" ":"")+b)},EditableGrid.prototype.removeClassName=function(a,b){a.className=this.strip(a.className.replace(new RegExp("(^|\\s+)"+b+"(\\s+|$)")," "))},String.prototype.trim=function(){return this.replace(/^[\s\xA0]+/,"").replace(/[\s\xA0]+$/,"")},String.prototype.contains=function(a){return this.match(a)==a},String.prototype.startsWith=function(a){return this.match("^"+a)==a},String.prototype.endsWith=function(a){return this.match(a+"$")==a},EditableGrid.prototype.checkDate=function(a,b){b=b||this.dateFormat,b=b||"EU";var c,d,e,f,g,h,j,m,k=!1,l=new Array("-"," ","/","."),o=this.shortMonthNames;if(o=o||["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],!a||a.length<1)return 0;for(m=0;m<l.length;m++)if(a.indexOf(l[m])!=-1){if(c=a.split(l[m]),3!=c.length)return 1;d=c[0],e=c[1],f=c[2],k=!0}if(0==k){if(a.length<=5)return 1;d=a.substr(0,2),e=a.substr(2,2),f=a.substr(4)}if("US"==b&&(strTemp=d,d=e,e=strTemp),g=parseInt(d,10),isNaN(g))return 2;if(h=parseInt(e,10),isNaN(h)){for(i=0;i<12;i++)e.toUpperCase()==o[i].toUpperCase()&&(h=i+1,e=o[i],i=12);if(isNaN(h))return 3}if(h>12||h<1)return 5;if(j=parseInt(f,10),isNaN(j))return 4;if(j<70&&(j=2e3+j,f=""+j),j<100&&(j=1900+j,f=""+j),j<1900||j>2100)return 11;if((1==h||3==h||5==h||7==h||8==h||10==h||12==h)&&(g>31||g<1))return 6;if((4==h||6==h||9==h||11==h)&&(g>30||g<1))return 7;if(2==h){if(g<1)return 8;if(1==LeapYear(j)){if(g>29)return 9}else if(g>28)return 10}return{formattedDate:"US"==b?o[h-1]+" "+g+" "+f:g+" "+o[h-1]+" "+f,sortDate:Date.parse(h+"/"+g+"/"+j),dbDate:j+"-"+h+"-"+g}},URI=function(a){function b(a){for(var b="";a;)if("../"==a.substr(0,3)||"./"==a.substr(0,2))a=a.replace(/^\.+/,"").substr(1);else if("/./"==a.substr(0,3)||"/."==a)a="/"+a.substr(3);else if("/../"==a.substr(0,4)||"/.."==a)a="/"+a.substr(4),b=b.replace(/\/?[^\/]*$/,"");else if("."==a||".."==a)a="";else{var c=a.match(/^\/?[^\/]*/)[0];a=a.substr(c.length),b+=c}return b}this.scheme=null,this.authority=null,this.path="",this.query=null,this.fragment=null,this.parse=function(a){var b=a.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);return this.scheme=b[3]?b[2]:null,this.authority=b[5]?b[6]:null,this.path=b[7],this.query=b[9]?b[10]:null,this.fragment=b[12]?b[13]:null,this},this.toString=function(){var a="";return null!=this.scheme&&(a=a+this.scheme+":"),null!=this.authority&&(a=a+"//"+this.authority),null!=this.path&&(a+=this.path),null!=this.query&&(a=a+"?"+this.query),null!=this.fragment&&(a=a+"#"+this.fragment),a},this.toAbsolute=function(a){var a=new URI(a),c=this,d=new URI;return null!=a.scheme&&(null!=c.scheme&&c.scheme.toLowerCase()==a.scheme.toLowerCase()&&(c.scheme=null),null!=c.scheme?(d.scheme=c.scheme,d.authority=c.authority,d.path=b(c.path),d.query=c.query):(null!=c.authority?(d.authority=c.authority,d.path=b(c.path),d.query=c.query):(""==c.path?(d.path=a.path,null!=c.query?d.query=c.query:d.query=a.query):("/"==c.path.substr(0,1)?d.path=b(c.path):(null!=a.authority&&""==a.path?d.path="/"+c.path:d.path=a.path.replace(/[^\/]+$/,"")+c.path,d.path=b(d.path)),d.query=c.query),d.authority=a.authority),d.scheme=a.scheme),d.fragment=c.fragment,d)},a&&this.parse(a)};
</script>

</head>

<body>

<div id="bgbox"></div>

<ul class="tabbar">
	<li><a href="#" class="tablinks active" onclick="switch_tab(event, 'tabInstructions')">Instructions</a></li>
	<li><a href="#" class="tablinks" onclick="switch_tab(event, 'tabSetup');tabSetup_update_display()">Setup</a></li>
	<li><a href="#" class="tablinks" onclick="switch_tab(event, 'tabWeighIn');tabWeighIn_update_display()">Weigh-in</a></li>
	<li><a href="#" class="tablinks" onclick="switch_tab(event, 'tabLifting');tabLifting_update_display()">Lifting</a></li>
	<li><a href="#" class="tablinks" onclick="switch_tab(event, 'tabSaveRestore');tabSaveRestore_update_display()">Save/Restore</a></li>
</ul>

<div id="tabInstructions" class="tabcontent">
<h1>NetLifter instructions</h1>

<ol>
<li>Prior to the meet, go to the Setup tab and configure everything according to the type of meet. In particular, make sure the platform weight set contains the right number of plates, and that the bar weigth for each flight and lift is accurate. The quantities of plates can be changed later on-the-fly, so for example, the quantity of 50 kg plates can be set to 0 initially.</li>
<li>Prior to weigh-in, go to the Weigh-in tab and download the import template. It is easiest to enter all lifter information through Excel into the spreadsheet.</li>
<li>After weigh-ins are completed, upload the spreadsheet on the Weigh-in tab and click the &quot;Import lifters&quot; button. This will remove any existing lifter data and replace it with the weigh-in data. It is best to keep a copy of the original spreadsheet as a backup.</li>
<li>Once lifting begins, use the Lifting tab for entering data in the same way as in NextLifter. The fields in the table are editable so any typos may be corrected easily at the scoring table.</li>
<li>During lifting, use the Save/Restore tab to periodically save a backup of the program data. These files are timestamped (YYYYMMDD-HHMM) and may be uploaded to restore the program state.</li>
<li>At the end of the meet, use the Save/Restore tab to download a final results spreadsheet.</li>
</ol>

<h1>Motivation</h1>
<p>
NetLifter is intended as a replacement for the famous NextLifter Excel spreadsheet for running powerlifting meets.
NextLifter can be quite fragile, and it is easy to introduce data inconsistencies if weigh-in data is not accurately entered.
NetLifter aims to solve these problems by maintaining a single global program state that can be edited at any time (it does not enforce that all data is finalized for the lifting phase).
This design approach allows NetLifter to easily create regular backup snapshots in case something goes wrong.
</p>

<pre>
todo:
Add hover dialog for divisions on weigh-in [LIST]
Add/Remove row for weight classes, divisions
Validate divisions on weigh-in and lifting pages.
Separate window for warmpup listing, or for broadcast overlay.
Extra export formats
Move character set selection to Setup tab.
</pre>

</div>

<div id="tabLifting" class="tabcontent">
<div onclick="hide_dialogs()">

<div id="secCurrentDisplay"">

<table><tr><td valign="top">
<table width="550px"><tbody id="tbdCurLifterInfo">
	<tr class="curLifterInfo">
		<td width="400" colspan="2"><div id="curLifterName">First Last</div></td>
		<td width="224"><div id="curLifterDivision">M-OR</div></td>
	</tr>
	<tr class="curLifterInfo">
		<td width="130"><div id="curLifterAge">26</div></td>
		<td width="250"><div id="curLifterBodyWeight">100</div></td>
		<td width="250"><div id="curLifterWeightClass">100</div></td>
	</tr>
	<tr class="curLifterInfo">
		<td width="200"><div id="curLift">Squat 1</div></td>
		<td width="400"><div><span id="curWeight"></span><br><span id="curWeightOtherUnit">0</span></div></td>
		<td width="400"><div id="curRackHeight">6-2</div></td>
	</tr>
</tbody>
</table>

<div id="timerbox">
<input type="text" name="timerMin" id="txtTimerMin" value="1" size="3">:<input type="text" name="timerSec" id="txtTimerSec" size="3">
<input type="button" value="Reset" onclick="btnTimerReset_clicked()">
<input type="button" value="Start" id="btnTimerStartStop" onclick="btnTimerStartStop_clicked()">
<span id="timer">1:00</div>
</div>

<div id="secCurrentSelection">

<form action="">
Flight:
<select id="selFlight" onchange="selFlight_changed()">
	<option value="A">A</option>
	<option value="B">B</option>
	<option value="C">C</option>
	<option value="D">D</option>
	<option value="E">E</option>
	<option value="F">F</option>
</select>
Lift:
<select id="selLift" onchange="selLift_changed()">
	<option value="SQ">Squat</option>
	<option value="BP">Bench</option>
	<option value="DL">Deadlift</option>
</select>
Attempt:
<select id="selAttempt" onchange="selAttempt_changed()">
	<option value="1">1</option>
	<option value="2">2</option>
	<option value="3">3</option>
	<option value="4">4</option>
</select><br>
Lifter:
<select id="selLifter" onchange="selLifter_changed()">
<option value="0">First Last</option></select>

<input type="button" value="GOOD" onclick="btnGOOD_clicked()">
<input type="button" value="NOLIFT" onclick="btnNOLIFT_clicked()">

</form>


</div> <!-- id="secCurrentSelection" -->


</td><td>

<canvas id="myCanvas" width="450" height="230"></canvas>

</td></tr></table>


</div> <!-- id="secCurrentDisplay" -->





<div id="tabLifting_tabLifterInfo"></div>


<div id="secTableDisplay">
<table id="tabLifting_tabDisplay">
<thead id="thdLifterInfo">
</thead>
<tbody id="tbdLifterInfo">
</tbody>
</table>


<div id="dlgEntry">
	<span id="dlgEntryLabel"></span>: <input type="text" name="value" id="txtEntry" onfocus="this.select();"><br>
	<input type="button" name="Save" value="Save" id="btnEntrySave">
	<input type="button" name="Cancel" value="Cancel" onclick="dlgEntryCancel_clicked()">
</div>

<div id="dlgEntryAttempt">
	<span id="dlgEntryAttemptLabel"></span>: <input type="text" name="value" id="txtEntryAttempt" onfocus="this.select();"><br>
	<input type="radio" name="Status" value="0" id="radEntryAttemptStatusNotAttempted"> Not attempted<br>
	<input type="radio" name="Status" value="1" id="radEntryAttemptStatusGood"> Good<br>
	<input type="radio" name="Status" value="-1" id="radEntryAttemptStatusNoLift"> No lift<br>
	<input type="radio" name="Status" value="-2" id="radEntryAttemptStatusScratch"> Scratch<br>
	<input type="button" name="Save" value="Save" id="btnEntryAttemptSave">
	<input type="button" name="Cancel" value="Cancel" onclick="dlgEntryAttemptCancel_clicked()">
</div>

<div id="dlgEntryRowIndicator">&nbsp;&nbsp;&nbsp;</div>


</div> <!-- id="secTableDisplay" -->





</div>
</div>

<div id="tabWeighIn" class="tabcontent">
<h1>Lifter cards</h1>

<table><tr><td valign="top">

<select size="40" id="selLifterCard" onchange="selLifterCard_changed()">
<option value="-99">Add new lifter</option>
</select>

</td><td valign="top">

<table>
<tr><td><!-- row 1 -->
	<table><tr>
		<td>Platform</td><td>&nbsp;</td>
		<td>Flight</td><td><input type="text" name="value" id="txtLifterCardFlight"></td>
		<td>Lot Number</td><td><input type="text" name="value" id="txtLifterCardLotNumber"></td>
		<td>Meet Date</td><td>&nbsp;</td>
	</tr></table>
</td></tr>
<tr><td><!-- row 2 -->
	<table><tr>
		<th>SCORE CARD</th>
	</tr></table>
</td></tr>
<tr><td><!-- row 3 -->
	<table><tr>
		<td>Name</td><td><input type="text" name="value" id="txtLifterCardName"></td>
		<td>Body Weight</td><td><input type="text" name="value" size="6" id="txtLifterCardWeight"><span id="tabWeighIn_body_weight_holder">&nbsp;</span></td>
		<td>Weight Class</td><td><input type="text" name="value" size="6" id="txtLifterCardWeightClass" readonly="readonly"><span id="tabWeighIn_weight_class_holder">&nbsp;</span></td></td>
	</tr></table>
</td></tr>
<tr><td><!-- row 4 -->
	<table><tr>
		<td>Team</td><td><input type="text" name="value" id="txtLifterCardTeam"></td>
		<td>State</td><td><input type="text" name="value" size="3" id="txtLifterCardState"></td>
		<td>Age</td><td><input type="text" name="value" size="4" id="txtLifterCardAge"></td>
		<td>Date of Birth</td><td><input type="text" name="value" size="11" id="txtLifterCardDOB"></td>
	</tr></table>
</td></tr>
<tr><td><!-- row 5 -->
	<table><tr>
		<td>Division(s)</td><td><input type="text" name="value" id="txtLifterCardDivision"> (separate with commas if multiple)
		<input type="button" name="Show List" value="Show List" onclick="btnLifterCardDivisionHelper_clicked()">
		</td>
	</tr></table>
</td></tr>
<tr><td><!-- row 6 -->
	<table><tr>
		<td>Events</td>
		<td><input type="checkbox" name="events" id="chkLifterCardEventsPL" value="PL"> PL (Powerlifting)</td>
		<td><input type="checkbox" name="events" id="chkLifterCardEventsBP" value="BP"> BP (Bench press)</td>
		<td><input type="checkbox" name="events" id="chkLifterCardEventsDL" value="DL"> DL (Deadlift)</td>
		<td><input type="checkbox" name="events" id="chkLifterCardEventsPP" value="PP"> PP (Push-pull)</td>
	</tr></table>
</td></tr>
<tr><td><!-- row 7 -->
	<table><tr>
		<td>Squat Bar Height</td><td><input type="text" name="value" id="txtLifterCardSQ_rack"></td>
		<td>Bench Height</td><td><input type="text" name="value" id="txtLifterCardBP_rack"></td>
	</tr></table>
</td></tr>
<tr><td><!-- row 8 -->
	<table>
		<tr>
			<th>Attempt:</th>
			<th>1ST</th>
			<th>2ND</th>
			<th>3RD</th>
			<th>BEST</th>
			<td>4TH (Does not count towards total)</td>
		</tr>
		<tr>
			<th>Squat</th>
			<td><input type="text" name="value" id="txtLifterCardSQ_1"><br>
			<input type="radio" name="LifterCardSQ_1_Status" value="1" id="radLifterCardSQ_1_Good" onclick="radLifterCard_Good_clicked('SQ',1)"> Good
			<input type="radio" name="LifterCardSQ_1_Status" value="0" id="radLifterCardSQ_1_NotAttempted" onclick="radLifterCard_NotAttempted_clicked('SQ',1)"> Not attempted<br>
			<input type="radio" name="LifterCardSQ_1_Status" value="-1" id="radLifterCardSQ_1_NoLift" onclick="radLifterCard_NoLift_clicked('SQ',1)"> No lift
			<input type="radio" name="LifterCardSQ_1_Status" value="-2" id="radLifterCardSQ_1_Scratch" onclick="radLifterCard_Scratch_clicked('SQ',1)"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardSQ_2"><br>
			<input type="radio" name="LifterCardSQ_2_Status" value="1" id="radLifterCardSQ_2_Good"> Good
			<input type="radio" name="LifterCardSQ_2_Status" value="0" id="radLifterCardSQ_2_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardSQ_2_Status" value="-1" id="radLifterCardSQ_2_NoLift"> No lift
			<input type="radio" name="LifterCardSQ_2_Status" value="-2" id="radLifterCardSQ_2_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardSQ_3"><br>
			<input type="radio" name="LifterCardSQ_3_Status" value="1" id="radLifterCardSQ_3_Good"> Good
			<input type="radio" name="LifterCardSQ_3_Status" value="0" id="radLifterCardSQ_3_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardSQ_3_Status" value="-1" id="radLifterCardSQ_3_NoLift"> No lift
			<input type="radio" name="LifterCardSQ_3_Status" value="-2" id="radLifterCardSQ_3_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardSQ_best" readonly="readonly"></td>
			<td><input type="text" name="value" id="txtLifterCardSQ_4"><br>
			<input type="radio" name="LifterCardSQ_4_Status" value="1" id="radLifterCardSQ_4_Good"> Good
			<input type="radio" name="LifterCardSQ_4_Status" value="0" id="radLifterCardSQ_4_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardSQ_4_Status" value="-1" id="radLifterCardSQ_4_NoLift"> No lift
			<input type="radio" name="LifterCardSQ_4_Status" value="-2" id="radLifterCardSQ_4_Scratch"> Scratch<br>
			</td>
		</tr>
		<tr>
			<th>Bench</th>
			<td><input type="text" name="value" id="txtLifterCardBP_1"><br>
			<input type="radio" name="LifterCardBP_1_Status" value="1" id="radLifterCardBP_1_Good"> Good
			<input type="radio" name="LifterCardBP_1_Status" value="0" id="radLifterCardBP_1_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardBP_1_Status" value="-1" id="radLifterCardBP_1_NoLift"> No lift
			<input type="radio" name="LifterCardBP_1_Status" value="-2" id="radLifterCardBP_1_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardBP_2"><br>
			<input type="radio" name="LifterCardBP_2_Status" value="1" id="radLifterCardBP_2_Good"> Good
			<input type="radio" name="LifterCardBP_2_Status" value="0" id="radLifterCardBP_2_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardBP_2_Status" value="-1" id="radLifterCardBP_2_NoLift"> No lift
			<input type="radio" name="LifterCardBP_2_Status" value="-2" id="radLifterCardBP_2_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardBP_3"><br>
			<input type="radio" name="LifterCardBP_3_Status" value="1" id="radLifterCardBP_3_Good"> Good
			<input type="radio" name="LifterCardBP_3_Status" value="0" id="radLifterCardBP_3_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardBP_3_Status" value="-1" id="radLifterCardBP_3_NoLift"> No lift
			<input type="radio" name="LifterCardBP_3_Status" value="-2" id="radLifterCardBP_3_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardBP_best" readonly="readonly"></td>
			<td><input type="text" name="value" id="txtLifterCardBP_4"><br>
			<input type="radio" name="LifterCardBP_4_Status" value="1" id="radLifterCardBP_4_Good"> Good
			<input type="radio" name="LifterCardBP_4_Status" value="0" id="radLifterCardBP_4_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardBP_4_Status" value="-1" id="radLifterCardBP_4_NoLift"> No lift
			<input type="radio" name="LifterCardBP_4_Status" value="-2" id="radLifterCardBP_4_Scratch"> Scratch<br>
			</td>
		</tr>
		<tr>
			<th>Deadlift</th>
			<td><input type="text" name="value" id="txtLifterCardDL_1"><br>
			<input type="radio" name="LifterCardDL_1_Status" value="1" id="radLifterCardDL_1_Good"> Good
			<input type="radio" name="LifterCardDL_1_Status" value="0" id="radLifterCardDL_1_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardDL_1_Status" value="-1" id="radLifterCardDL_1_NoLift"> No lift
			<input type="radio" name="LifterCardDL_1_Status" value="-2" id="radLifterCardDL_1_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardDL_2"><br>
			<input type="radio" name="LifterCardDL_2_Status" value="1" id="radLifterCardDL_2_Good"> Good
			<input type="radio" name="LifterCardDL_2_Status" value="0" id="radLifterCardDL_2_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardDL_2_Status" value="-1" id="radLifterCardDL_2_NoLift"> No lift
			<input type="radio" name="LifterCardDL_2_Status" value="-2" id="radLifterCardDL_2_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardDL_3"><br>
			<input type="radio" name="LifterCardDL_3_Status" value="1" id="radLifterCardDL_3_Good"> Good
			<input type="radio" name="LifterCardDL_3_Status" value="0" id="radLifterCardDL_3_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardDL_3_Status" value="-1" id="radLifterCardDL_3_NoLift"> No lift
			<input type="radio" name="LifterCardDL_3_Status" value="-2" id="radLifterCardDL_3_Scratch"> Scratch<br>
			</td>
			<td><input type="text" name="value" id="txtLifterCardDL_best" readonly="readonly"></td>
			<td><input type="text" name="value" id="txtLifterCardDL_4"><br>
			<input type="radio" name="LifterCardDL_4_Status" value="1" id="radLifterCardDL_4_Good"> Good
			<input type="radio" name="LifterCardDL_4_Status" value="0" id="radLifterCardDL_4_NotAttempted"> Not attempted<br>
			<input type="radio" name="LifterCardDL_4_Status" value="-1" id="radLifterCardDL_4_NoLift"> No lift
			<input type="radio" name="LifterCardDL_4_Status" value="-2" id="radLifterCardDL_4_Scratch"> Scratch<br>
			</td>
		</tr>
		<tr>
			<th>Total</th>
			<td>&nbsp;</td>
			<td>&nbsp;</td>
			<td>&nbsp;</td>
			<td><input type="text" name="value" id="txtLifterCard_total" readonly="readonly"></td>
			<td>&nbsp;</td>
		</tr>
	</table>
</td></tr>
</table>

<input type="button" name="Save lifter" value="Save" onclick="btnLifterCardSave_clicked()">
<input type="button" name="Delete lifter" value="Delete lifter" onclick="btnLifterCardDelete_clicked()">

</td></tr>
</table>

<h2>CSV import</h2>
<p>
First, download the template below:<br>
<input type="button" name="Download import template CSV" value="Download import template" onclick="import_download_template()">
<br>
Next, fill out the template (e.g. in Excel), and then import it here:<br>
<input type="file" id="fileImportLifters" accept="*.csv">
<input type="button" name="Import from CSV" value="Import lifters" onclick="import_upload_lifters()">
</p>
<p>
In order to handle non-English characters, you may need to adjust the character set according to your locale:
<br>
Character set:
<select id="selWeighIn_ImportCharset">
<option value="windows-1252" selected="selected">Excel default (Windows codepage 1252)</option>
<option value="us-ascii">US-ASCII</option>
<option value="iso-8859-1">ISO/IEC 8859-1 (Latin 1 Western Europe)</option>
<option value="iso-8859-2">ISO/IEC 8859-2 (Latin 2 Central Europe)</option>
<option value="iso-8859-3">ISO/IEC 8859-3 (Latin 3 South European)</option>
<option value="iso-8859-4">ISO/IEC 8859-4 (Latin 4 North European)</option>
<option value="iso-8859-5">ISO/IEC 8859-5 (Latin/Cyrillic)</option>
<option value="iso-8859-6">ISO/IEC 8859-6 (Latin/Arabic)</option>
<option value="iso-8859-7">ISO/IEC 8859-7 (Latin/Greek)</option>
<option value="iso-8859-8">ISO/IEC 8859-8 (Latin/Hebrew)</option>
<option value="iso-8859-9">ISO/IEC 8859-9 (Latin-5 Turkish)</option>
<option value="iso-8859-10">ISO/IEC 8859-10 (Latin-6 Nordic)</option>
<option value="iso-8859-11">ISO/IEC 8859-11 (Latin/Thai)</option>
<option value="iso-8859-13">ISO/IEC 8859-13 (Latin-7 Baltic Rim)</option>
<option value="iso-8859-14">ISO/IEC 8859-14 (Latin-8 Celtic)</option>
<option value="iso-8859-15">ISO/IEC 8859-15 (Latin-9)</option>
<option value="iso-8859-16">ISO/IEC 8859-16 (Latin-10 Fantasy mix)</option>
<option value="UTF-8">UTF-8 (Unicode 8-bit)</option>
</select>
</p>


<div id="tabWeighIn_division_helper_dialog">
<table>
<thead>
<tr><th>Division</th><th>Description</th></tr>
</thead>
<tbody id="tabWeighIn_division_helper_table"></tbody>
</table>
</div>

</div>

<div id="tabSetup" class="tabcontent">
<table><tr><td valign="top" width="40%">

<h1>Platform weight set</h1>
<p>
Bar and collar should be first two items, then all the weights in decreasing order.
</p>

<div id="tabSetup_tabPlatformWeightSet">
</div>

<select id="tabSetup_selPredefinedWeightSets">
<option value="KG" selected="selected">Kilogram plates</option>
<option value="LB">Pound plates</option>
</select>
<input type="button" name="Use standard plates" value="Use standard plates" onclick="tabSetup_use_standard_plates_onclick()">

<p>
The bar weight specified above is the "default" bar weight.
Some flights or lifts may use a different weight of bar, and you may specify exceptions on the right.
</p>

</td><td valign="top" width="30%">

<h1>Bar weight</h1>
<div id="tabSetup_tabBarWeight">
</div>

</td><td valign="top" width="30%">

<h1>Units</h1>

<table>
<tr><th></th><th>KG</th><th>LB</th></tr>
<tr>
	<th>Platform Weight</th>
	<td><input type="radio" name="PlatformWeightUnit" value="KG" id="radPlatformWeightUnitKG" onchange="tabSetup_radPlatformWeightUnitChanged()"></td>
	<td><input type="radio" name="PlatformWeightUnit" value="LB" id="radPlatformWeightUnitLB" onchange="tabSetup_radPlatformWeightUnitChanged()"></td>
</tr>
<tr>
	<th>Body Weight</th>
	<td><input type="radio" name="BodyWeightUnit" value="KG" id="radBodyWeightUnitKG" onchange="tabSetup_radBodyWeightUnitChanged()"></td>
	<td><input type="radio" name="BodyWeightUnit" value="LB" id="radBodyWeightUnitLB" onchange="tabSetup_radBodyWeightUnitChanged()"></td>
</tr>
<tr>
	<th>Weight Classes</th>
	<td><input type="radio" name="WeightClassUnit" value="KG" id="radWeightClassUnitKG" onchange="tabSetup_radWeightClassUnitChanged()"></td>
	<td><input type="radio" name="WeightClassUnit" value="LB" id="radWeightClassUnitLB" onchange="tabSetup_radWeightClassUnitChanged()"></td>
</tr>
</table>

</td></tr>
<tr><td valign="top">

<h1>Divisions</h1>
<div id="tabSetup_tabDivisions"></div>

<select id="tabSetup_selPredefinedDivisions">
</select>
<input type="button" name="Import" value="Import" onclick="tabSetup_import_divisions()">


</td><td valign="top">


<h1>Weight classes</h1>

<table>
<tr>
	<td valign="top"><div id="tabSetup_tabWeightClassesMen"></div></td>
	<td valign="top"><div id="tabSetup_tabWeightClassesWomen"></div></td>
</tr>
</table>

<select id="tabSetup_selPredefinedWeightClasses">
</select>
<input type="button" name="Import" value="Import" onclick="tabSetup_import_weight_classes()">

</td></tr></table>

<!--
<h1>Displayed columns</h1>
<textarea id="txtDisplayedColumns" rows="10" cols="10">
flight
name
division
weight
age
SQ_rack
wilks
attempts
best
subtotal
</textarea>
-->

</div>

<div id="tabSaveRestore" class="tabcontent">
<h1>Results</h1>

This file is organized by division and sorted by weight class, and then sorted by total within each weight class.
<input type="button" name="Download current results sheet" value="Download current results sheet" onclick="export_download()">

<h1>Autosave</h1>

Autosave saves to in-browser storage, so if the browser crashes, your data will be preserved. It is not as reliable as saving the full program state below.

<input type="button" name="Autosave" value="Autosave" onclick="btnAutosave_clicked()">
<input type="button" name="Load Autosave" value="Load Autosave" onclick="btnLoadAutosave_clicked()">
<input type="button" name="Clear Autosave" value="Clear Autosave" onclick="btnClearAutosave_clicked()"><br>

<h1>Save full program state</h1>
<input type="button" name="Save State" value="Save State" onclick="btnSaveState_clicked()"><br>
<input type="file" id="fileLoadState" accept="*.json">
<input type="button" name="Load State" value="Load State" onclick="btnLoadState_clicked()">
</div>

<div>
<p>&nbsp;</p>
</div>

<script>
function switch_tab(evt, tabName){
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Show the current tab, and add an "active" class to the link that opened the tab
    document.getElementById(tabName).style.display = "block";
    if(evt){
		// Get all elements with class="tablinks" and remove the class "active"
		tablinks = document.getElementsByClassName("tablinks");
		for (i = 0; i < tablinks.length; i++) {
			tablinks[i].className = tablinks[i].className.replace(" active", "");
		}
		evt.currentTarget.className += " active";
	}
}
function escape_Excel(val){
	if(val.indexOf('-') > 0){
		return '"=""' + val.replace('"','""') + '"""';
	}
	return '' + val;
}
function escale_CSV(val){
	if(val.indexOf('-') > 0){
		return '"' + val.replace('"','""') + '"';
	}
	return '' + val;
}
function textify(stuff){
	if(stuff){ return '' + stuff; }
	return '';
}
function get_timestamp(){
	var today = new Date();
	var dd = today.getDate();
	if(dd < 10){ dd = '0' + dd; }else{ dd = '' + dd; }
	var mm = today.getMonth()+1;
	if(mm < 10){ mm = '0' + mm; }else{ mm = '' + mm; }
	var yyyy = today.getFullYear();
	var hh = '' + today.getHours();
	var mn = '' + today.getMinutes();
	return ('' + yyyy + mm + dd + '-' + hh + mn);
}

function text_to_table(str, delim){
	var tab = [];
	var lines = str.split(/\r\n|\n|\r/);
	for(var i = 0; i < lines.length; ++i){
		if(lines[i].match(/^\s*$/)){ break; } // skip blank lines
		var re = new RegExp(delim);
		var fields = lines[i].split(re);
		tab[i] = [];
		for(var j = 0; j < fields.length; ++j){
			tab[i][j] = fields[j].trim();
		}
	}
	return tab;
}
function table_to_text(tab, delim){
	var str = '';
	const m = tab.length; // m rows
	for(var i = 0; i < m; ++i){
		const n = tab[i].length; // n cols
		for(var j = 0; j+1 < n; ++j){
			str += tab[i][j] + delim;
		}
		str += tab[i][j] + '\n';
	}
	return str;
}

//// Powerlifting functions

function weight_unit_string(unit){
	return unit.toLowerCase();
}
function is_SHW(weight_class){
	if(typeof weight_class === 'number'){ return false; }
	return weight_class.indexOf('+') >= 0;
}
function weight_class_string(weight_class){
	if(is_SHW(weight_class)){
		return 'SHW';
	}else{
		return '' + weight_class;
	}
}
function weight_class_number(weight_class){
	if(is_SHW(weight_class)){
		return 9999;
	}else{
		return Number(weight_class);
	}
}
function check_attempt_weight(weight){
	// weight must be multiple of 2.5 except for record setters
	var x = weight/2.5
	if(Math.abs(x - Math.round(x)) > 1e-6){
		alert("Weight must be a multiple of 2.5 unless this is a record attempt");
	}
}

function wilks_coefficient(is_female, weight){
	const x = weight;
	const c = {
		men: [-216.0475144, 16.2606339, -0.002388645, -0.00113732, 7.01863E-06, -1.291E-08],
		women: [ 594.31747775582, -27.23842536447, 0.82112226871, -0.00930733913, 4.731582E-05, -9.054E-08 ]
	};
	var coeffs;
	if(is_female){
		coeffs = c.women;
	}else{
		coeffs = c.men;
	}
	var sum = coeffs[5];
	sum *= x; sum += coeffs[4];
	sum *= x; sum += coeffs[3];
	sum *= x; sum += coeffs[2];
	sum *= x; sum += coeffs[1];
	sum *= x; sum += coeffs[0];
	return 500/sum;
}
function age_coefficient(age){
	age = Number(age);
	if(age_coefficients.Foster[age]){
		return age_coefficients.Foster[age];
	}
	if(age_coefficients.McCulloch[age]){
		return age_coefficients.McCulloch[age];
	}
	return 1;
}

function get_flight_list(first_flight){
	var flights = [];
	const nlifters = state.lifter_info.length;
	for(i = 0; i < nlifters; ++i){
		var iflight = state.lifter_info[i].flight;
		var j = flights.indexOf(iflight);
		if(j < 0){
			flights.push(iflight);
		}
	}
	flights.sort();
	const n = flights.length;
	var icur = 0;
	for(i = 1; i < n; ++i){
		if(flights[i] == first_flight){
			icur = i;
			break;
		}
	}
	if(0 == icur){ return flights; }
	// rotate list
	flights.unshift.apply(flights, flights.splice(icur, n));
	return flights;
}

function events_contains(event_str, liftstr){
	const evtab = {
		PL: ["SQ", "BP", "DL"],
		BP: [      "BP"      ],
		DL: [            "DL"],
		PP: [      "BP", "DL"]
	};
	var evlist = event_str.split("+");
	for(var i = 0; i < evlist.length; ++i){
		var ev = evlist[i];
		if(!evtab[ev]){ continue; }
		for(var j = 0; j < evtab[ev].length; ++j){
			if(evtab[ev][j] == liftstr){
				return true;
			}
		}
	}
	return false;
}

function get_current_bar_weight(){
	var bar_weight = state.weight_set[0].weight;
	if(state.bar_weight[state.current.flight]){
		var specific_weight = state.bar_weight[state.current.flight][state.current.lift];
		if(specific_weight){
			bar_weight = specific_weight;
		}
	}
	return bar_weight;
}
function get_collar_weight(){
	return state.weight_set[1].weight;
}

function plate_count(weight){
	const n = state.weight_set.length;
	var remaining_weight_4 = Math.round(weight*4);
	var counts = [];
	for(var i = 0; i < n; ++i){
//console.log('Plate: ' + state.weight_set[i].name + ', weight: ' + state.weight_set[i].weight + ', count: ' + state.weight_set[i].count);
		counts[i] = 0;
		var curcount = state.weight_set[i].quantity;
		var num_to_use_at_a_time = 2;
		var cur_weight_4 = Math.round(state.weight_set[i].weight*4);
		if(state.weight_set[i].name == 'bar'){
			num_to_use_at_a_time = 1;
			cur_weight_4 = Math.round(get_current_bar_weight()*4);
		}
//console.log(remaining_weight_4/4 + ' ' + cur_weight_4/4);
		while(remaining_weight_4 >= num_to_use_at_a_time*cur_weight_4 && curcount > 0){
			counts[i] += num_to_use_at_a_time;
			remaining_weight_4 -= num_to_use_at_a_time*cur_weight_4;
			curcount -= num_to_use_at_a_time;
		}
	}
	return counts;
}

function plate_count_to_string(counts){
	var str = '';
	for(var i = 2; i < counts.length; ++i){
		var curstr = '';
		var single_side_count = counts[i]/2;
		if(single_side_count > 1){
			curstr = (single_side_count + 'x' + state.weight_set[i].name);
		}else if(single_side_count > 0){
			curstr = state.weight_set[i].name;
		}
		if(curstr){
			if(str){
				str += ', ';
			}
			str += curstr;
		}
	}
	return str;
}

function base_weight(){
	var weight = 0;
	/*
	for(var i = 0; i < state.weight_set.length; ++i){
		if(state.weight_set[i].name == 'bar'){ weight += Number(state.weight_set[i].weight); break; }
		if(state.weight_set[i].name == 'collar'){ weight += 2*Number(state.weight_set[i].weight); break; }
	}*/
	weight += get_current_bar_weight();
	weight += 2*Number(state.weight_set[1].weight);
	return weight;
}
/* Blob.js
 * A Blob implementation.
 * 2014-07-24
 *
 * By Eli Grey, http://eligrey.com
 * By Devin Samarin, https://github.com/dsamarin
 * License: MIT
 *   See https://github.com/eligrey/Blob.js/blob/master/LICENSE.md
 */

/*global self, unescape */
/*jslint bitwise: true, regexp: true, confusion: true, es5: true, vars: true, white: true,
  plusplus: true */

/*! @source http://purl.eligrey.com/github/Blob.js/blob/master/Blob.js */

(function (view) {
	"use strict";

	view.URL = view.URL || view.webkitURL;

	if (view.Blob && view.URL) {
		try {
			new Blob;
			return;
		} catch (e) {}
	}

	// Internally we use a BlobBuilder implementation to base Blob off of
	// in order to support older browsers that only have BlobBuilder
	var BlobBuilder = view.BlobBuilder || view.WebKitBlobBuilder || view.MozBlobBuilder || (function(view) {
		var
			  get_class = function(object) {
				return Object.prototype.toString.call(object).match(/^\[object\s(.*)\]$/)[1];
			}
			, FakeBlobBuilder = function BlobBuilder() {
				this.data = [];
			}
			, FakeBlob = function Blob(data, type, encoding) {
				this.data = data;
				this.size = data.length;
				this.type = type;
				this.encoding = encoding;
			}
			, FBB_proto = FakeBlobBuilder.prototype
			, FB_proto = FakeBlob.prototype
			, FileReaderSync = view.FileReaderSync
			, FileException = function(type) {
				this.code = this[this.name = type];
			}
			, file_ex_codes = (
				  "NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR "
				+ "NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR"
			).split(" ")
			, file_ex_code = file_ex_codes.length
			, real_URL = view.URL || view.webkitURL || view
			, real_create_object_URL = real_URL.createObjectURL
			, real_revoke_object_URL = real_URL.revokeObjectURL
			, URL = real_URL
			, btoa = view.btoa
			, atob = view.atob

			, ArrayBuffer = view.ArrayBuffer
			, Uint8Array = view.Uint8Array

			, origin = /^[\w-]+:\/*\[?[\w\.:-]+\]?(?::[0-9]+)?/
		;
		FakeBlob.fake = FB_proto.fake = true;
		while (file_ex_code--) {
			FileException.prototype[file_ex_codes[file_ex_code]] = file_ex_code + 1;
		}
		// Polyfill URL
		if (!real_URL.createObjectURL) {
			URL = view.URL = function(uri) {
				var
					  uri_info = document.createElementNS("http://www.w3.org/1999/xhtml", "a")
					, uri_origin
				;
				uri_info.href = uri;
				if (!("origin" in uri_info)) {
					if (uri_info.protocol.toLowerCase() === "data:") {
						uri_info.origin = null;
					} else {
						uri_origin = uri.match(origin);
						uri_info.origin = uri_origin && uri_origin[1];
					}
				}
				return uri_info;
			};
		}
		URL.createObjectURL = function(blob) {
			var
				  type = blob.type
				, data_URI_header
			;
			if (type === null) {
				type = "application/octet-stream";
			}
			if (blob instanceof FakeBlob) {
				data_URI_header = "data:" + type;
				if (blob.encoding === "base64") {
					return data_URI_header + ";base64," + blob.data;
				} else if (blob.encoding === "URI") {
					return data_URI_header + "," + decodeURIComponent(blob.data);
				} if (btoa) {
					return data_URI_header + ";base64," + btoa(blob.data);
				} else {
					return data_URI_header + "," + encodeURIComponent(blob.data);
				}
			} else if (real_create_object_URL) {
				return real_create_object_URL.call(real_URL, blob);
			}
		};
		URL.revokeObjectURL = function(object_URL) {
			if (object_URL.substring(0, 5) !== "data:" && real_revoke_object_URL) {
				real_revoke_object_URL.call(real_URL, object_URL);
			}
		};
		FBB_proto.append = function(data/*, endings*/) {
			var bb = this.data;
			// decode data to a binary string
			if (Uint8Array && (data instanceof ArrayBuffer || data instanceof Uint8Array)) {
				var
					  str = ""
					, buf = new Uint8Array(data)
					, i = 0
					, buf_len = buf.length
				;
				for (; i < buf_len; i++) {
					str += String.fromCharCode(buf[i]);
				}
				bb.push(str);
			} else if (get_class(data) === "Blob" || get_class(data) === "File") {
				if (FileReaderSync) {
					var fr = new FileReaderSync;
					bb.push(fr.readAsBinaryString(data));
				} else {
					// async FileReader won't work as BlobBuilder is sync
					throw new FileException("NOT_READABLE_ERR");
				}
			} else if (data instanceof FakeBlob) {
				if (data.encoding === "base64" && atob) {
					bb.push(atob(data.data));
				} else if (data.encoding === "URI") {
					bb.push(decodeURIComponent(data.data));
				} else if (data.encoding === "raw") {
					bb.push(data.data);
				}
			} else {
				if (typeof data !== "string") {
					data += ""; // convert unsupported types to strings
				}
				// decode UTF-16 to binary string
				bb.push(unescape(encodeURIComponent(data)));
			}
		};
		FBB_proto.getBlob = function(type) {
			if (!arguments.length) {
				type = null;
			}
			return new FakeBlob(this.data.join(""), type, "raw");
		};
		FBB_proto.toString = function() {
			return "[object BlobBuilder]";
		};
		FB_proto.slice = function(start, end, type) {
			var args = arguments.length;
			if (args < 3) {
				type = null;
			}
			return new FakeBlob(
				  this.data.slice(start, args > 1 ? end : this.data.length)
				, type
				, this.encoding
			);
		};
		FB_proto.toString = function() {
			return "[object Blob]";
		};
		FB_proto.close = function() {
			this.size = 0;
			delete this.data;
		};
		return FakeBlobBuilder;
	}(view));

	view.Blob = function(blobParts, options) {
		var type = options ? (options.type || "") : "";
		var builder = new BlobBuilder();
		if (blobParts) {
			for (var i = 0, len = blobParts.length; i < len; i++) {
				if (Uint8Array && blobParts[i] instanceof Uint8Array) {
					builder.append(blobParts[i].buffer);
				}
				else {
					builder.append(blobParts[i]);
				}
			}
		}
		var blob = builder.getBlob(type);
		if (!blob.slice && blob.webkitSlice) {
			blob.slice = blob.webkitSlice;
		}
		return blob;
	};

	var getPrototypeOf = Object.getPrototypeOf || function(object) {
		return object.__proto__;
	};
	view.Blob.prototype = getPrototypeOf(new view.Blob());
}(typeof self !== "undefined" && self || typeof window !== "undefined" && window || this.content || this));


/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||function(e){"use strict";if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,i=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},a=/constructor/i.test(e.HTMLElement),f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},d="application/octet-stream",s=1e3*40,c=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,s)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(i){u(i)}}}},p=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,s){if(!s){t=p(t)}var v=this,w=t.type,m=w===d,y,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&a)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");var n=e.open(t,"_blank");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,"_blank");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;i(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||"download";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!==null){define([],function(){return saveAs})}

const kilos_per_pound = 0.45359237;
const LIFT_STATE = {
	GOOD: 1,
	NOT_ATTEMPTED: 0,
	NO_LIFT: -1,
	SCRATCH: -2
};
function lift_state_completed(lift_state){
	return (LIFT_STATE.GOOD == lift_state || LIFT_STATE.NO_LIFT == lift_state);
}

const liftlist = [ "SQ", "BP", "DL" ];

const standard_flights = [ 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L' ];

const column_headers = {
	flight: "Flight",
	name: "Name",
	division: "Div",
	weight: "Wt",
	age: "Age",
	dob: "DOB",
	which_lifts: "Events",
	SQ_rack: "RH SQ",
	BP_rack: "RH BP",
	state: "State",
	team: "Team",
	lot_number: "lot#",
	wilks: "Wilks",
	age_coeff: "Age Coeff",
	weight_class: "WtCls",
	SQ_best: "Best SQ",
	BP_best: "Best BP",
	DL_best: "Best DL",
	SQ_1: "SQ 1",
	SQ_2: "SQ 2",
	SQ_3: "SQ 3",
	SQ_4: "SQ 4",
	BP_1: "BP 1",
	BP_2: "BP 2",
	BP_3: "BP 3",
	BP_4: "BP 4",
	DL_1: "DL 1",
	DL_2: "DL 2",
	DL_3: "DL 3",
	DL_4: "DL 4",
	SQ_best: "Best SQ",
	BP_best: "Best BP",
	DL_best: "Best DL",
	best: "Best",
	subtotal: "Subtotal",
	total: "Total"
};
const computed_columns = {
	wilks: display_wilks,
	age_coeff: get_age_coeff,
	weight_class: get_weight_class,
	best: get_best,
	SQ_best: get_best_SQ,
	BP_best: get_best_BP,
	DL_best: get_best_DL,
	subtotal: get_subtotal,
	total: get_total
};
const import_columns = [
	'flight',
	'name',
	'division',
	'weight',
	'age',
	'dob',
	'which_lifts',
	'SQ_rack','BP_rack',
	'state','team','lot_number',
	'SQ_1','BP_1','DL_1'
];
const export_columns = [
	'flight',
	'name',
	'division',
	'weight_class',
	'weight',
	'age',
	'dob',
	'which_lifts',
	'SQ_rack','BP_rack',
	'state',
	'team',
	'lot_number',
	'wilks',
	'age_coeff',
	'weight_class',
	'SQ_1','SQ_2','SQ_3', 'SQ_best',
	'BP_1','BP_2','BP_3', 'BP_best',
	'DL_1','DL_2','DL_3', 'DL_best',
	'total',
	'SQ_4','BP_4','DL_4'
];
const displayed_columns = {
	SQ: [
		"flight", "name", "division", "weight", "weight_class", "SQ_rack", "attempts"
	],
	BP: [
		"flight", "name", "division", "weight", "weight_class", "SQ_best", "BP_rack", "attempts", "subtotal"
	],
	DL: [
		"flight", "name", "division", "weight", "weight_class", "SQ_best", "BP_best", "attempts", "total"
	]
};
const weight_columns = {
	weight: 'body_weight_units',
	weight_class: 'weight_class_units',
	SQ_1: 'weight_set_units',
	SQ_2: 'weight_set_units',
	SQ_3: 'weight_set_units',
	SQ_4: 'weight_set_units',
	SQ_best: 'weight_set_units',
	BP_1: 'weight_set_units',
	BP_2: 'weight_set_units',
	BP_3: 'weight_set_units',
	BP_4: 'weight_set_units',
	BP_best: 'weight_set_units',
	DL_1: 'weight_set_units',
	DL_2: 'weight_set_units',
	DL_3: 'weight_set_units',
	DL_4: 'weight_set_units',
	DL_best: 'weight_set_units',
	subtotal: 'weight_set_units',
	total: 'weight_set_units'
};
const text_columns = [
	"flight",
	"name",
	"division",
	"weight",
	"age",
	"dob",
	"which_lifts",
	"SQ_rack",
	"BP_rack",
	"state",
	"team",
	"lot_number",
	"SQ_1", "SQ_1_state",
	"BP_1", "BP_1_state",
	"DL_1", "DL_1_state",
	"SQ_2", "SQ_2_state",
	"BP_2", "BP_2_state",
	"DL_2", "DL_2_state",
	"SQ_3", "SQ_3_state",
	"BP_3", "BP_3_state",
	"DL_3", "DL_3_state",
	"SQ_4", "SQ_4_state",
	"BP_4", "BP_4_state",
	"DL_4", "DL_4_state"
];

const divisions = {
	USAPL: {
		"FR-Y1": "Raw Women (8-9)",
		"FR-Y2": "Raw Women (10-11)",
		"FR-Y3": "Raw Women (12-13)",
		"FR-T1": "Raw Women (14-15)",
		"FR-T2": "Raw Women (16-17)",
		"FR-T3": "Raw Women (18-19)",
		"FR-JR": "Raw Women (20-23)",
		"FR-O": "Raw Women",
		"FR-M1a": "Raw Women (40-44)",
		"FR-M1b": "Raw Women (45-49)",
		"FR-M2a": "Raw Women (50-54)",
		"FR-M2b": "Raw Women (55-59)",
		"FR-M3a": "Raw Women (60-64)",
		"FR-M3b": "Raw Women (65-69)",
		"FR-M4a": "Raw Women (70-74)",
		"FR-M4b": "Raw Women (75-79)",
		"FR-M5a": "Raw Women (80-84)",
		"FR-M5b": "Raw Women (85-89)",
		"FR-M6": "Raw Women (90+)-",
		"MR-Y1": "Raw Men (8-9)",
		"MR-Y2": "Raw Men (10-11)",
		"MR-Y3": "Raw Men (12-13)",
		"MR-T1": "Raw Men (14-15)",
		"MR-T2": "Raw Men (16-17)",
		"MR-T3": "Raw Men (18-19)",
		"MR-JR": "Raw Men (20-23)",
		"MR-O": "Raw Men",
		"MR-M1a": "Raw Men (40-44)",
		"MR-M1b": "Raw Men (45-49)",
		"MR-M2a": "Raw Men (50-54)",
		"MR-M2b": "Raw Men (55-59)",
		"MR-M3a": "Raw Men (60-64)",
		"MR-M3b": "Raw Men (65-69)",
		"MR-M4a": "Raw Men (70-74)",
		"MR-M4b": "Raw Men (75-79)",
		"MR-M5a": "Raw Men (80-84)",
		"MR-M5b": "Raw Men (85-89)",
		"MR-M6": "Raw Men (90+)-",
		"F-T1": "Women (14-15)",
		"F-T2": "Women (16-17)",
		"F-T3": "Women (18-19)",
		"F-JR": "Women (20-23)",
		"F-O": "Women",
		"F-M1a": "Women (40-44)",
		"F-M1b": "Women (45-49)",
		"F-M2a": "Women (50-54)",
		"F-M2b": "Women (55-59)",
		"F-M3a": "Women (60-64)",
		"F-M3b": "Women (65-69)",
		"F-M4a": "Women (70-74)",
		"F-M4b": "Women (75-79)",
		"F-M5a": "Women (80-84)",
		"F-M5b": "Women (85-89)",
		"F-M6": "Women (90+)-",
		"M-T1": "Men (14-15)",
		"M-T2": "Men (16-17)",
		"M-T3": "Men (18-19)",
		"M-JR": "Men (20-23)",
		"M-O": "Men",
		"M-M1a": "Men (40-44)",
		"M-M1b": "Men (45-49)",
		"M-M2a": "Men (50-54)",
		"M-M2b": "Men (55-59)",
		"M-M3a": "Men (60-64)",
		"M-M3b": "Men (65-69)",
		"M-M4a": "Men (70-74)",
		"M-M4b": "Men (75-79)",
		"M-M5a": "Men (80-84)",
		"M-M5b": "Men (85-89)",
		"M-M6": "Men (90+)-"
	},
	IPF: {
		"FR-SJr": "Raw Women (14-18)",
		"FR-Jr": "Raw Women (19-23)",
		"FR-O": "Raw Women",
		"FR-M1": "Raw Women (40-49)",
		"FR-M2": "Raw Women (50-59)",
		"FR-M3": "Raw Women (60-69)",
		"FR-M4": "Raw Women (70+)-",
		"MR-SJr": "Raw Men (14-18)",
		"MR-Jr": "Raw Men (19-23)",
		"MR-O": "Raw Men",
		"MR-M1": "Raw Men (40-49)",
		"MR-M2": "Raw Men (50-59)",
		"MR-M3": "Raw Men (60-69)",
		"MR-M4": "Raw Men (70+)-",
		"F-SJr": "Women (14 -18)",
		"F-Jr": "Women (19 -23)",
		"F-O": "Women",
		"F-M1": "Women (40 -49)",
		"F-M2": "Women (50 -59)",
		"F-M3": "Women (60 -69)",
		"F-M4": "Women (70+) -",
		"M-SJr": "Men (14 -18)",
		"M-Jr": "Men (19 -23)",
		"M-O": "Men",
		"M-M1": "Men (40 -49)",
		"M-M2": "Men (50 -59)",
		"M-M3": "Men (60 -69)",
		"M-M4": "Men (70+) -"
	}
};

const weight_classes = {
	IPF: {
		KG: {
			men: [ 30, 35, 40, 44, 48, 53, 59, 66, 74, 83, 93, 105, 120, '120+' ],
			women: [ 30, 35, 40, 43, 47, 52, 57, 63, 72, 84, '84+' ]
		},
		LB: {
			men: [ 66, 77, 88, 97, 105, 116, 130, 145, 163, 183, 205, 231, 264, '264+' ],
			women: [ 66, 77, 88, 94, 103, 114, 125, 138, 158, 185, '185+' ]
		}
	},
	"High School": {
		KG: {
			men: [ 52, 56, 60, 67.5, 75, 82.5, 90, 100, 125, '125+' ],
			women: [ 44, 48, 52, 56, 60, 67.5, 75, 82.5, 90, '90+' ]
		},
		LB: {
			men: [ 114, 123, 132, 148, 165, 181, 198, 220, 242, 275, '275+' ],
			women: [ 97, 105, 114, 123, 132, 148, 165, 181, 198, '198+' ]
		}
	}
};

const age_coefficients = {
	Foster: {
		14: 1.23,
		15: 1.18,
		16: 1.13,
		17: 1.08,
		18: 1.06,
		19: 1.04,
		20: 1.03,
		21: 1.02,
		22: 1.01,
		23: 1.00
	},
	McCulloch: {
		40: 1,
		41: 1.01,
		42: 1.02,
		43: 1.031,
		44: 1.043,
		45: 1.055,
		46: 1.068,
		47: 1.082,
		48: 1.097,
		49: 1.113,
		50: 1.13,
		51: 1.147,
		52: 1.165,
		53: 1.184,
		54: 1.204,
		55: 1.225,
		56: 1.246,
		57: 1.258,
		58: 1.292,
		59: 1.315,
		60: 1.34,
		61: 1.366,
		62: 1.393,
		63: 1.421,
		64: 1.45,
		65: 1.48,
		66: 1.511,
		67: 1.543,
		68: 1.578,
		69: 1.61,
		70: 1.645,
		71: 1.681,
		72: 1.718,
		73: 1.756,
		74: 1.795,
		75: 1.835,
		76: 1.876,
		77: 1.918,
		78: 1.961,
		79: 2.005,
		80: 2.05,
		81: 2.096,
		82: 2.143,
		83: 2.19,
		84: 2.238,
		85: 2.287,
		86: 2.337,
		87: 2.388,
		88: 2.44,
		89: 2.494,
		90: 2.549
	}
};
const standard_bar_weights = {
	KG: { SQ: 25, BP: 20, DL: 20 },
	LB: { SQ: 55, BP: 45, DL: 45 }
};
const standard_weight_sets = {
	KG: [
		{
			name: "bar",
			weight: 20,
			quantity: 1
		},
		{
			name: "collar",
			weight: 2.5,
			quantity: 2
		},
		{
			name: "50",
			weight: 50,
			quantity: 0
		},
		{
			name: "45",
			weight: 45,
			quantity: 0
		},
		{
			name: "25",
			weight: 25,
			quantity: 14
		},
		{
			name: "20",
			weight: 20,
			quantity: 2
		},
		{
			name: "15",
			weight: 15,
			quantity: 2
		},
		{
			name: "10",
			weight: 10,
			quantity: 2
		},
		{
			name: "5",
			weight: 5,
			quantity: 2
		},
		{
			name: "2.5",
			weight: 2.5,
			quantity: 2
		},
		{
			name: "1.25",
			weight: 1.25,
			quantity: 2
		},
		{
			name: "0.5",
			weight: 0.5,
			quantity: 2
		},
		{
			name: "0.25",
			weight: 0.25,
			quantity: 2
		}
	],
	LB: [
		{
			name: "bar",
			weight: 45,
			quantity: 1
		},
		{
			name: "collar",
			weight: 5,
			quantity: 2
		},
		{
			name: "110",
			weight: 110,
			quantity: 0
		},
		{
			name: "100",
			weight: 100,
			quantity: 0
		},
		{
			name: "55",
			weight: 55,
			quantity: 0
		},
		{
			name: "45",
			weight: 45,
			quantity: 16
		},
		{
			name: "35",
			weight: 35,
			quantity: 2
		},
		{
			name: "25",
			weight: 25,
			quantity: 2
		},
		{
			name: "10",
			weight: 10,
			quantity: 4
		},
		{
			name: "5",
			weight: 5,
			quantity: 2
		},
		{
			name: "2.5",
			weight: 2.5,
			quantity: 2
		},
		{
			name: "1.25",
			weight: 1.25,
			quantity: 4
		},
		{
			name: "0.5",
			weight: 0.5,
			quantity: 2
		}
	]
};
var state = {
	weight_set: [
		{
			name: "bar",
			weight: 20,
			quantity: 1
		},
		{
			name: "collar",
			weight: 2.5,
			quantity: 2
		},
		{
			name: "50",
			weight: 50,
			quantity: 0
		},
		{
			name: "45",
			weight: 45,
			quantity: 0
		},
		{
			name: "25",
			weight: 25,
			quantity: 14
		},
		{
			name: "20",
			weight: 20,
			quantity: 2
		},
		{
			name: "15",
			weight: 15,
			quantity: 2
		},
		{
			name: "10",
			weight: 10,
			quantity: 2
		},
		{
			name: "5",
			weight: 5,
			quantity: 2
		},
		{
			name: "2.5",
			weight: 2.5,
			quantity: 2
		},
		{
			name: "1.25",
			weight: 1.25,
			quantity: 2
		},
		{
			name: "0.5",
			weight: 0.5,
			quantity: 2
		},
		{
			name: "0.25",
			weight: 0.25,
			quantity: 2
		}
	],
	bar_weight: {
		A: { SQ: 25, BP: 20, DL: 20 },
		B: { SQ: 25, BP: 20, DL: 20 },
		C: { SQ: 25, BP: 20, DL: 20 },
		D: { SQ: 25, BP: 20, DL: 20 },
		E: { SQ: 25, BP: 20, DL: 20 },
		F: { SQ: 25, BP: 20, DL: 20 },
		G: { SQ: 25, BP: 20, DL: 20 },
		H: { SQ: 25, BP: 20, DL: 20 },
		I: { SQ: 25, BP: 20, DL: 20 },
		J: { SQ: 25, BP: 20, DL: 20 },
		K: { SQ: 25, BP: 20, DL: 20 },
		L: { SQ: 25, BP: 20, DL: 20 }
	},
	weight_set_units: "KG",
	weight_classes: {
		women: [
			43, 47, 52, 57, 63, 72, 84, "84+"
		],
		men: [
			53, 59, 66, 74, 83, 93, 105, 120, "120+"
		]
	},
	body_weight_units: "KG",
	weight_class_units: "KG",
	divisions: {
	},
	lifter_info: [
		{
			flight: "A",
			name: "First Last",
			age: 32,
			dob: "",
			state: "",
			team: "",
			division: "M-OR",
			weight: 154,
			lot_number: 1,
			which_lifts: "PL",
			SQ_rack: "6-2",
			SQ_1: 150,
			SQ_1_state: 0, // 0 = not attempted, 1 = good, -1 = nolift
			// ...
			SQ_4_state: 0,
			BP_rack: "5-2",
			BP_1: 130,
			BP_1_state: 0,
			// ...
			DL_1: 200,
			DL_1_state: 0
		}
	],
	current: {
		flight: "A",
		lift: "SQ",
		attempt: 1,
		lifter_id: -1,
		lifters: []
	}
};

function add_computed_columns(){
	const m = state.lifter_info.length;
	for(var i = 0; i < m; ++i){
		for(colname in computed_columns){
			state.lifter_info[i][colname] = computed_columns[colname];
		}
	}
}

var records = {};
var record_getter = {
	USAPL: get_records_USAPL
};

function get_records_USAPL(){
	// Download xlsx from "http://usapl.liftingdatabase.com/records-excelnextlifter" + "?state=" + "CA"
	// Two sheets: KG Records, LB Records
	// First row headings: Division
	// First col headings: weight class and lift, first half men, second half women
	//
	// records.USAPL = { men: {}, women: {} };
}

// Called when setup tab is shown, and when info is updated on it
function tabSetup_update_display(){
	update_display_setup_platform_weight_set();
	update_display_setup_bar_weight();
	update_display_setup_units();
	update_display_setup_divisions();
	update_display_setup_weight_classes();
}

function tabSetup_radPlatformWeightUnitChanged(){
	if(document.getElementById('radPlatformWeightUnitKG').checked){
		state.weight_set_units = 'KG';
	}else if(document.getElementById('radPlatformWeightUnitLB').checked){
		state.weight_set_units = 'LB';
	}
	update_display_setup_platform_weight_set();
	update_display_setup_bar_weight();
}
function tabSetup_radBodyWeightUnitChanged(){
	if(document.getElementById('radBodyWeightUnitKG').checked){
		state.body_weight_units = 'KG';
	}else if(document.getElementById('radBodyWeightUnitLB').checked){
		state.body_weight_units = 'LB';
	}
}
function tabSetup_radWeightClassUnitChanged(){
	if(document.getElementById('radWeightClassUnitKG').checked){
		state.weight_class_units = 'KG';
	}else if(document.getElementById('radWeightClassUnitLB').checked){
		state.weight_class_units = 'LB';
	}
	update_display_setup_weight_classes();
}

function update_display_setup_platform_weight_set(){
	var ws_headings = [];
	ws_headings.push({ name: "name", label: "Name", datatype: "string", editable: true});
	ws_headings.push({ name: "weight", label:"Weight", datatype: "double(" + weight_unit_string(state.weight_set_units) + ", , dot, comma, 0)", editable: true});
	ws_headings.push({ name: "quantity", label: "Quantity", datatype: "integer", editable: true});

	var ws_data = [];
	const m = state.weight_set.length;
	var i;
	for(i = 0; i < m; ++i){
		ws_data.push({id: i, values: state.weight_set[i] });
	}

	var grid_ws = new EditableGrid("PlatformWeightSet", { enableSort:false } );
	grid_ws.load({"metadata": ws_headings, "data": ws_data});
	grid_ws.renderGrid("tabSetup_tabPlatformWeightSet", "");
	grid_ws.modelChanged = tabSetup_onPlatformWeightSetEdit;
}
function update_display_setup_units(){
	if('KG' == state.weight_set_units){
		document.getElementById('radPlatformWeightUnitKG').checked = true;
	}else{
		document.getElementById('radPlatformWeightUnitLB').checked = true;
	}
	if('KG' == state.body_weight_units){
		document.getElementById('radBodyWeightUnitKG').checked = true;
	}else{
		document.getElementById('radBodyWeightUnitLB').checked = true;
	}
	if('KG' == state.weight_class_units){
		document.getElementById('radWeightClassUnitKG').checked = true;
	}else{
		document.getElementById('radWeightClassUnitLB').checked = true;
	}
}
function update_display_setup_bar_weight(){
	var bw_headings = [];
	bw_headings.push({ name: "flight", label: "Flight", datatype: "string", editable: false});
	bw_headings.push({ name: "SQ", label: "Squat", datatype: "double(" + weight_unit_string(state.weight_set_units) + ", , dot, comma, 0)", editable: true});
	bw_headings.push({ name: "BP", label: "Bench", datatype: "double(" + weight_unit_string(state.weight_set_units) + ", , dot, comma, 0)", editable: true});
	bw_headings.push({ name: "DL", label: "Deadlift", datatype: "double(" + weight_unit_string(state.weight_set_units) + ", , dot, comma, 0)", editable: true});

	// get list of flights
	var flights = get_flight_list();
	var bw_data = [];
	const w = state.weight_set[0].weight;
	for(i = 0; i < flights.length; ++i){
		var iflight = flights[i];
		if(state.bar_weight[iflight]){
			bw_data.push({ id: iflight, values: [
				iflight,
				state.bar_weight[iflight].SQ ? state.bar_weight[iflight].SQ : w,
				state.bar_weight[iflight].BP ? state.bar_weight[iflight].BP : w,
				state.bar_weight[iflight].DL ? state.bar_weight[iflight].DL : w
			] });
		}else{
			bw_data.push({ id: iflight, values: [iflight,w,w,w] });
		}
	}

	var grid_ws = new EditableGrid("BarWeight", { enableSort:false } );
	grid_ws.load({"metadata": bw_headings, "data": bw_data});
	grid_ws.renderGrid("tabSetup_tabBarWeight", "");
	grid_ws.modelChanged = tabSetup_onBarWeightEdit;
}
function update_display_setup_divisions(){
	var headings = [];
	headings.push({ name: "division", label: "Division", datatype: "string", editable: true});
	headings.push({ name: "description", label: "Description", datatype: "string", editable: true});

	var data = [];
	if(state.divisions){
		for(division in state.divisions){
			data.push({ id: division, values: [ division, state.divisions[division] ] });
		}
	}
	var grid = new EditableGrid("Division", { enableSort:true } );
	grid.load({"metadata": headings, "data": data});
	grid.renderGrid("tabSetup_tabDivisions", "");
	grid.modelChanged = tabSetup_onDivisionsEdit;

	c = document.getElementById('tabSetup_selPredefinedDivisions');
	var c_count = c.options.length;
	for(var i = c_count-1; i >= 0; --i){
		c.removeChild(c.options[i]);
	}
	for(federation in divisions){
		var opt = document.createElement("option");
		opt.appendChild(document.createTextNode(federation));
		opt.value = federation;
		c.appendChild(opt);
	}
}
function update_display_setup_weight_classes(){
	var men_headings = [];
	//men_headings.push({ name: "weight", label: "Men", datatype: "double(" + weight_unit_string(state.weight_class_units) + ", , dot, comma, 0)", editable: true});
	men_headings.push({ name: "weight", label: "Men (" + weight_unit_string(state.weight_class_units) + ")", datatype: "number", editable: true});

	var men_data = [];
	for(i = 0; i < state.weight_classes.men.length; ++i){
		var w = state.weight_classes.men[i];
		men_data.push({ id: i, values: [ w ] });
	}

	var grid_men = new EditableGrid("WeightClassesMen", { enableSort:false } );
	grid_men.load({"metadata": men_headings, "data": men_data});
	grid_men.renderGrid("tabSetup_tabWeightClassesMen", "");
	grid_men.modelChanged = tabSetup_onWeightClassesMenEdit;


	var women_headings = [];
	//women_headings.push({ name: "weight", label: "Women", datatype: "double(" + weight_unit_string(state.weight_class_units) + ", , dot, comma, 0)", editable: true});
	women_headings.push({ name: "weight", label: "Women (" + weight_unit_string(state.weight_class_units) + ")", datatype: "number", editable: true});

	var women_data = [];
	for(i = 0; i < state.weight_classes.women.length; ++i){
		var w = state.weight_classes.women[i];
		women_data.push({ id: i, values: [ w ] });
	}

	var grid_women = new EditableGrid("WeightClassesWomen", { enableSort:false } );
	grid_women.load({"metadata": women_headings, "data": women_data});
	grid_women.renderGrid("tabSetup_tabWeightClassesWomen", "");
	grid_women.modelChanged = tabSetup_onWeightClassesWomenEdit;


	c = document.getElementById('tabSetup_selPredefinedWeightClasses');
	var c_count = c.options.length;
	for(var i = c_count-1; i >= 0; --i){
		c.removeChild(c.options[i]);
	}
	for(federation in weight_classes){
		var opt = document.createElement("option");
		opt.appendChild(document.createTextNode(federation));
		opt.value = federation;
		c.appendChild(opt);
	}
}

function tabSetup_onPlatformWeightSetEdit(rowIndex, columnIndex, oldValue, newValue, row){
	//console.log("Value for '" + this.getColumnName(columnIndex) + "' in row " + rowIndex + " has changed from '" + oldValue + "' to '" + newValue + "'");
	state.weight_set[rowIndex][this.getColumnName(columnIndex)] = newValue;
}


function tabSetup_onBarWeightEdit(rowIndex, columnIndex, oldValue, newValue, row){
//console.log("Value for '" + this.getColumnName(columnIndex) + "' in row " + rowIndex + " has changed from '" + oldValue + "' to '" + newValue + "'");
	const colname = this.getColumnName(columnIndex);
	const flight = row.id.replace('BarWeight_', '');
	if(state.bar_weight[flight]){
		state.bar_weight[flight][colname] = Number(newValue);
	}else{
		state.bar_weight[flight] = {};
		state.bar_weight[flight][colname] = Number(newValue);
	}
}

function tabSetup_onDivisionsEdit(rowIndex, columnIndex, oldValue, newValue, row){
//console.log("Value for '" + this.getColumnName(columnIndex) + "' in row " + rowIndex + " has changed from '" + oldValue + "' to '" + newValue + "'");
}


function tabSetup_onWeightClassesMenEdit(rowIndex, columnIndex, oldValue, newValue, row){
//console.log("Value for '" + this.getColumnName(columnIndex) + "' in row " + rowIndex + " has changed from '" + oldValue + "' to '" + newValue + "'");
	const i = row.id.replace('WeightClassesMen_', '');
	if(state.weight_classes.men[i]){
		state.weight_classes.men[i] = Number(newValue);
	}else{
		state.weight_classes.men[i] = Number(newValue);
	}
}
function tabSetup_onWeightClassesWomenEdit(rowIndex, columnIndex, oldValue, newValue, row){
//console.log("Value for '" + this.getColumnName(columnIndex) + "' in row " + rowIndex + " has changed from '" + oldValue + "' to '" + newValue + "'");
	const i = row.id.replace('WeightClassesWomen_', '');
	if(state.weight_classes.women[i]){
		state.weight_classes.women[i] = Number(newValue);
	}else{
		state.weight_classes.women[i] = Number(newValue);
	}
}

function tabSetup_import_divisions(){
	var c = document.getElementById('tabSetup_selPredefinedDivisions');
	var federation = c.value;
	if(!divisions[federation]){ return; }
	state.divisions = {};
	for(division in divisions[federation]){
		state.divisions[division] = divisions[federation][division];
	}
	update_display_setup_divisions();
}

function tabSetup_import_weight_classes(){
	var c = document.getElementById('tabSetup_selPredefinedWeightClasses');
	var federation = c.value;
	if(!weight_classes[federation][state.weight_class_units]){ return; }
	state.weight_classes.men = [];
	var m;
	m = weight_classes[federation][state.weight_class_units].men.length;
	for(i = 0; i < m; ++i){
		state.weight_classes.men.push(weight_classes[federation][state.weight_class_units].men[i]);
	}
	state.weight_classes.women = [];
	m = weight_classes[federation][state.weight_class_units].women.length;
	for(i = 0; i < m; ++i){
		state.weight_classes.women.push(weight_classes[federation][state.weight_class_units].women[i]);
	}
	update_display_setup_weight_classes();
}

function tabSetup_use_standard_plates_onclick(){
	var unit = document.getElementById('tabSetup_selPredefinedWeightSets').value;
	if('KG' == unit || 'LB' == unit){
		state.weight_set = [];
		state.bar_weight = {};
		var m = standard_weight_sets[unit].length;
		for(var i = 0; i < m; ++i){
			state.weight_set.push({
				name: standard_weight_sets[unit][i].name,
				weight: standard_weight_sets[unit][i].weight,
				quantity: standard_weight_sets[unit][i].quantity
			});
		}
		for(var i = 0; i < standard_flights.length; ++i){
			state.bar_weight[standard_flights[i]] = {};
			state.bar_weight[standard_flights[i]].SQ = standard_bar_weights[unit].SQ;
			state.bar_weight[standard_flights[i]].BP = standard_bar_weights[unit].BP;
			state.bar_weight[standard_flights[i]].DL = standard_bar_weights[unit].DL;
		}
	}
	update_display_setup_platform_weight_set();
	update_display_setup_bar_weight();
}
function tabWeighIn_update_display(){
	tabWeighIn_division_helper_dialog_toggle(false);
	tabWeighIn_update_listbox();

	document.getElementById('tabWeighIn_body_weight_holder').className = 'weight' + state.body_weight_units;
	document.getElementById('tabWeighIn_weight_class_holder').className = 'weight' + state.weight_class_units;
	var t = document.getElementById('tabWeighIn_division_helper_table');
	t.innerHTML = "";
	for(division in state.divisions){
		var row = t.insertRow(-1);
		var cell = row.insertCell(0);
		cell.innerHTML = division;
		cell = row.insertCell(1);
		cell.innerHTML = state.divisions[division];
	}

	// Update the card table
	const id = document.getElementById('selLifterCard').value;
	const curlifter = state.lifter_info[id];
	if(!curlifter){
		clear_lifter_card();
		return;
	}
	// populate fields
	document.getElementById("txtLifterCardFlight").value = curlifter.flight;
	document.getElementById("txtLifterCardLotNumber").value = curlifter.lot_number;
	document.getElementById("txtLifterCardName").value = curlifter.name;
	document.getElementById("txtLifterCardWeight").value = curlifter.weight;
	document.getElementById("txtLifterCardWeightClass").value = get_weight_class(curlifter);
	document.getElementById("txtLifterCardAge").value = curlifter.age;
	document.getElementById("txtLifterCardDOB").value = curlifter.dob;
	document.getElementById("txtLifterCardTeam").value = curlifter.team;
	document.getElementById("txtLifterCardState").value = curlifter.state;
	document.getElementById("txtLifterCardDivision").value = curlifter.division;
	document.getElementById("txtLifterCardSQ_rack").value = curlifter.SQ_rack;
	document.getElementById("txtLifterCardBP_rack").value = curlifter.BP_rack;

	document.getElementById("chkLifterCardEventsPL").checked = false;
	document.getElementById("chkLifterCardEventsBP").checked = false;
	document.getElementById("chkLifterCardEventsDL").checked = false;
	document.getElementById("chkLifterCardEventsPP").checked = false;
	var evlist = curlifter.which_lifts.split("+");
	for(var i = 0; i < evlist.length; ++i){
		switch(evlist[i]){
		case "PL": document.getElementById("chkLifterCardEventsPL").checked = true; break;
		case "BP": document.getElementById("chkLifterCardEventsBP").checked = false; break;
		case "DL": document.getElementById("chkLifterCardEventsDL").checked = false; break;
		case "PP": document.getElementById("chkLifterCardEventsPP").checked = false; break;
		default: break;
		}
	}
	var total = 0;
	for(liftkey in liftlist){
		var curlift = liftlist[liftkey];
		var best = 0;
		for(var iattempt = 1; iattempt <= 4; ++iattempt){
			var lift_attempt = curlift + "_" + iattempt;
			var lift_attempt_state = lift_attempt + "_state";
			var text_to_use = '';
			if(state.lifter_info[id][lift_attempt]){
				text_to_use = state.lifter_info[id][lift_attempt];
				if(state.lifter_info[id][lift_attempt] > best){
					if(1 == state.lifter_info[id][lift_attempt_state]){
						best = state.lifter_info[id][lift_attempt];
					}
				}
			}
			document.getElementById("radLifterCard" + lift_attempt + "_Good").checked = false;
			document.getElementById("radLifterCard" + lift_attempt + "_NotAttempted").checked = false;
			document.getElementById("radLifterCard" + lift_attempt + "_NoLift").checked = false;
			document.getElementById("radLifterCard" + lift_attempt + "_Scratch").checked = false;
			if(!state.lifter_info[id][lift_attempt_state]){
				document.getElementById("radLifterCard" + lift_attempt + "_NotAttempted").checked = true;
			}else{
				switch(state.lifter_info[id][lift_attempt_state]){
				case 1:
					document.getElementById("radLifterCard" + lift_attempt + "_Good").checked = true;
					console.log("Setting " + "radLifterCard" + lift_attempt + "_Good" + " to checked");
					break;
				case -1:
					text_to_use = "-" + text_to_use;
					document.getElementById("radLifterCard" + lift_attempt + "_NoLift").checked = true;
					break;
				case -2:
					text_to_use = "--";
					document.getElementById("radLifterCard" + lift_attempt + "_Scratch").checked = true;
					break;
				default:
					document.getElementById("radLifterCard" + lift_attempt + "_NotAttempted").checked = true;
					break;
				}
			}
			document.getElementById("txtLifterCard" + lift_attempt).value = text_to_use;
		}
		if(best > 0){
			document.getElementById("txtLifterCard" + curlift + "_best").value = best;
			total += best;
		}
	}
	if(total > 0){
		document.getElementById("txtLifterCard_total").value = total;
	}
	return false;
}

function tabWeighIn_update_listbox(){
	const m = state.lifter_info.length;
	var c = document.getElementById("selLifterCard");
	var prev_selected = c.selectedIndex;
	var c_count = c.options.length;
	for(var i = c_count-1; i > 0; --i){
		c.removeChild(c.options[i]);
	}
	var dropdown_ids = [];
	for(var i = 0; i < m; ++i){
		dropdown_ids.push(i);
	}
	dropdown_ids.sort(function(a,b){
		if(state.lifter_info[a].flight < state.lifter_info[b].flight){
			return -1;
		}else if(state.lifter_info[a].flight > state.lifter_info[b].flight){
			return  1;
		}else{
			if(state.lifter_info[a].name < state.lifter_info[b].name){
				return -1;
			}else if(state.lifter_info[a].name > state.lifter_info[b].name){
				return 1;
			}
		}
		return 0;
	});
	for(var i = 0; i < m; ++i){
		var opt = document.createElement("option");
		var id = dropdown_ids[i];
		var optname = state.lifter_info[id].flight + " " + state.lifter_info[id].name + " " + state.lifter_info[id].division;
		opt.appendChild(document.createTextNode(optname));
		opt.value = id;
		c.appendChild(opt);
		if(prev_selected == i){
			c.selectedIndex = i;
		}
	}
}

function selLifterCard_changed(){
	tabWeighIn_update_display();
}
function clear_lifter_card(){
	// clear all fields
	document.getElementById("txtLifterCardFlight").value = '';
	document.getElementById("txtLifterCardLotNumber").value = '';
	document.getElementById("txtLifterCardName").value = '';
	document.getElementById("txtLifterCardWeight").value = '';
	document.getElementById("txtLifterCardAge").value = '';
	document.getElementById("txtLifterCardTeam").value = '';
	document.getElementById("txtLifterCardState").value = '';
	document.getElementById("txtLifterCardDivision").value = '';
	document.getElementById("txtLifterCardSQ_rack").value = '';
	document.getElementById("txtLifterCardBP_rack").value = '';

	document.getElementById("chkLifterCardEventsPL").checked = false;
	document.getElementById("chkLifterCardEventsBP").checked = false;
	document.getElementById("chkLifterCardEventsDL").checked = false;
	document.getElementById("chkLifterCardEventsPP").checked = false;
	for(var iattempt = 1; iattempt <= 4; ++iattempt){
		for(liftkey in liftlist){
			var curlift = liftlist[liftkey];
			var lift_attempt = curlift + "_" + iattempt;
			document.getElementById("txtLifterCard" + curlift + "_" + iattempt).value = '';
			document.getElementById("radLifterCard" + lift_attempt + "_Good").checked = false;
			document.getElementById("radLifterCard" + lift_attempt + "_NotAttempted").checked = true;
			document.getElementById("radLifterCard" + lift_attempt + "_NoLift").checked = false;
			document.getElementById("radLifterCard" + lift_attempt + "_Scratch").checked = false;
		}
	}
}
function btnLifterCardDelete_clicked(){
	const id = document.getElementById('selLifterCard').value;
	if(state.lifter_info[id]){
		if(!window.confirm("Are you sure you want to delete this lifter card?")){
			return false;
		}else{
			state.lifter_info.splice(id, 1);
			tabWeighIn_update_display();
		}
	}
	clear_lifter_card();
	return false;
}
function btnLifterCardSave_clicked(){
	var id = document.getElementById('selLifterCard').value;
	if(id < 0){
		id = state.lifter_info.push({}) - 1;
		for(colname in computed_columns){
			state.lifter_info[id][colname] = computed_columns[colname];
		}
	}
	// clear all fields
	state.lifter_info[id].flight = document.getElementById("txtLifterCardFlight").value;
	state.lifter_info[id].lot_number = document.getElementById("txtLifterCardLotNumber").value;
	state.lifter_info[id].name = document.getElementById("txtLifterCardName").value;
	state.lifter_info[id].weight = document.getElementById("txtLifterCardWeight").value;
	state.lifter_info[id].age = document.getElementById("txtLifterCardAge").value;
	state.lifter_info[id].team = document.getElementById("txtLifterCardTeam").value;
	state.lifter_info[id].state = document.getElementById("txtLifterCardState").value;
	state.lifter_info[id].division = document.getElementById("txtLifterCardDivision").value;
	state.lifter_info[id].SQ_rack = document.getElementById("txtLifterCardSQ_rack").value;
	state.lifter_info[id].BP_rack = document.getElementById("txtLifterCardBP_rack").value;

	var evlist = [];
	if(document.getElementById("chkLifterCardEventsPL").checked){ evlist.push("PL"); }
	if(document.getElementById("chkLifterCardEventsBP").checked){ evlist.push("BP"); }
	if(document.getElementById("chkLifterCardEventsDL").checked){ evlist.push("DL"); }
	if(document.getElementById("chkLifterCardEventsPP").checked){ evlist.push("PP"); }
	state.lifter_info[id].which_lifts = evlist.join("+");
	for(var iattempt = 1; iattempt <= 4; ++iattempt){
		for(liftkey in liftlist){
			var curlift = liftlist[liftkey];
			var lift_attempt = curlift + "_" + iattempt;
			var lift_attempt_state = lift_attempt + "_state";
			var txt = document.getElementById("txtLifterCard" + lift_attempt).value;

			if(txt.match('^\-+$') || ('' == txt && document.getElementById("radLifterCard" + lift_attempt + "_Scratch").checked)){
				state.lifter_info[id][lift_attempt] = "--";
				state.lifter_info[id][lift_attempt_state] = -2;
				if(2 == iattempt){
					state.lifter_info[id][curlift + "_3"] = "--";
					state.lifter_info[id][curlift + "_3_state"] = -2;
					// we need to set the text and radio so that the next loop iteration doesn't trash it
					document.getElementById("txtLifterCard" + curlift + "_3").value = '';
					document.getElementById("radLifterCard" + curlift + "_3_Scratch").checked = true;
				}
			}else if('' == txt){
				state.lifter_info[id][lift_attempt] = "";
				state.lifter_info[id][lift_attempt_state] = 0;
			}else{
				var num = Number(txt);
				if(!isNaN(num)){
					check_attempt_weight(Math.abs(num));
					if(num < 0 || document.getElementById("radLifterCard" + lift_attempt + "_NoLift").checked){
						state.lifter_info[id][lift_attempt] = Math.abs(num);
						state.lifter_info[id][lift_attempt_state] = -1;
					}else{
						state.lifter_info[id][lift_attempt] = num;
						if(document.getElementById("radLifterCard" + lift_attempt + "_Good").checked){
							state.lifter_info[id][lift_attempt_state] = 1;
						}else{
							state.lifter_info[id][lift_attempt_state] = 0;
						}
					}
				}
			}
		}
	}
	tabWeighIn_update_display();
	return false;
}

function radLifterCard_Good_clicked(lift, attempt){
	var txtid = "txtLifterCard" + lift + "_" + attempt;
	var num = Number(document.getElementById(txtid).value);
	if(!isNaN(num)){
		document.getElementById(txtid).value = Math.abs(num);
	}else{
		document.getElementById(txtid).value = '';
	}
}
function radLifterCard_NotAttempted_clicked(lift, attempt){
	var txtid = "txtLifterCard" + lift + "_" + attempt;
	var num = Number(document.getElementById(txtid).value);
	if(!isNaN(num)){
		document.getElementById(txtid).value = Math.abs(num);
	}else{
		document.getElementById(txtid).value = '';
	}
}
function radLifterCard_NoLift_clicked(lift, attempt){
	var txtid = "txtLifterCard" + lift + "_" + attempt;
	var num = Number(document.getElementById(txtid).value);
	if(!isNaN(num)){
		document.getElementById(txtid).value = -Math.abs(num);
	}else{
		document.getElementById(txtid).value = '';
	}
}
function radLifterCard_Scratch_clicked(lift, attempt){
	var txtid = "txtLifterCard" + lift + "_" + attempt;
	document.getElementById(txtid).value = '--';
}

function tabWeighIn_division_helper_dialog_toggle(want_toggle){
	var d = document.getElementById('tabWeighIn_division_helper_dialog');
	if(d.style.display != 'none' && want_toggle){
		d.style.display = 'fixed';
		d.style.left = 0;
		d.style.top = 0;
	}else{
		d.style.display = 'none';
	}
}
function btnLifterCardDivisionHelper_clicked(){
	tabWeighIn_division_helper_dialog_toggle(true);
}


//// Import
function import_download_template(){
	var csv = '';
	for(colidx in import_columns){
		csv += get_column_header(import_columns[colidx]) + ',';
	}
	const charset = document.getElementById('selWeighIn_ImportCharset');
	var blob = new Blob([csv], {type: "text/csv;charset="+charset});
	saveAs(blob, "netlifter_import_template.csv");
}
function import_upload_lifters(){
	var fileToLoad = document.getElementById("fileImportLifters").files[0];

	var fileReader = new FileReader();
	fileReader.onload = function(fileLoadedEvent){
		var textFromFileLoaded = fileLoadedEvent.target.result;
		import_parse_csv(textFromFileLoaded);
		add_computed_columns();
		tabWeighIn_update_display();
	};
	const charset = document.getElementById('selWeighIn_ImportCharset');
	fileReader.readAsText(fileToLoad, charset);
}
function import_parse_csv(txt){
	var tab = text_to_table(txt, ',');
	const m = tab.length;
	const n = import_columns.length;

	state.lifter_info = [];
	for(var i = 0; i+1 < m; ++i){
		state.lifter_info.push({});
		for(var j = 0; j < n; ++j){
			state.lifter_info[i][import_columns[j]] = tab[i+1][j];
		}
	}

	var flights = get_flight_list();
	state.current.flight = flights[0];
	state.current.lift = 'SQ';
	state.current.attempt = 1;
	state.current.lifter_id = -1;
}
function tabLifting_update_display(){
	hide_dialogs();
	tabLifting_update_toolbar();
	// The above does not update selLifter; do that below
	state.current.lifters = [];

	// Update lifter set from current state
	var c = document.getElementById("selLifter");
	var c_count = c.options.length;
	for(var i = c_count-1; i >= 0; --i){
		c.removeChild(c.options[i]);
	}
	const m = state.lifter_info.length;
	for(var i = 0; i < m; ++i){
		if(state.lifter_info[i].flight != state.current.flight){ continue; }
		var doing_this_lift = events_contains(state.lifter_info[i].which_lifts, state.current.lift);
		if(!doing_this_lift){ continue; }
		state.current.lifters.push(i);
	}
	// sort lifters by weight of current attempt, then by lot number
	state.current.lifters.sort(sort_by_weight);

	var found = false;
	for(var i = 0; i < state.current.lifters.length; ++i){
		var id = state.current.lifters[i];
		var opt = document.createElement("option");
		var name = state.lifter_info[id].name;

		opt.appendChild(document.createTextNode(name));
		opt.value = id;
		c.appendChild(opt);
		/*
		// Set current lifter to lower weight that has not been attempted yet
		var lift_attempt_status = state.current.lift + "_" + state.current.attempt + "_state";
		if(!found && !state.lifter_info[id][lift_attempt_status]){
			state.current.lifter_id = id;
			c.selectedIndex = c.length - 1;
			found = true;
		}
		*/
		if(id == state.current.lifter_id){
			c.selectedIndex = c.length - 1;
			found = 1;
		}
	}
	if(!found){
		state.current.lifter_id = state.current.lifters[0];
		c.selectedIndex = 0;
	}


	// Update the display portion
	var curlifter = state.lifter_info[state.current.lifter_id];
	if(curlifter){
		var body_weight = curlifter.weight;
		/*
		if("KG" == state.body_weight_units){
			body_weight = curlifter.weight;
		}else{
			body_weight = Math.round(body_weight*22.0462)/10;
		}*/
		var curlift = '';
		switch(state.current.lift){
		case 'SQ': curlift = 'Squat'; break;
		case 'BP': curlift = 'Bench'; break;
		case 'DL': curlift = 'Deadlift'; break;
		default: break;
		}
		var cur_attempt_weight = curlifter[state.current.lift+"_"+state.current.attempt];
		var rack_height = '';
		if("DL" != state.current.lift){
			rack_height = curlifter[state.current.lift + "_rack"];
		}

		document.getElementById('curLifterName').innerHTML = textify(curlifter.name);
		document.getElementById('curLifterBodyWeight').innerHTML = textify(body_weight);
		document.getElementById('curLifterBodyWeight').className = 'weight' + state.body_weight_units;
		document.getElementById('curLifterWeightClass').innerHTML = textify(get_weight_class(curlifter));
		document.getElementById('curLifterWeightClass').className = 'weight' + state.weight_class_units;
		document.getElementById('curLifterAge').innerHTML = textify(curlifter.age);
		document.getElementById('curLifterDivision').innerHTML = textify(curlifter.division);
		document.getElementById('curLift').innerHTML = curlift + ' ' + state.current.attempt;
		document.getElementById('curWeight').innerHTML = cur_attempt_weight;
		document.getElementById('curWeight').className = 'weight' + state.weight_set_units;
		if('KG' == state.weight_set_units){
			document.getElementById('curWeightOtherUnit').innerHTML = Math.round(cur_attempt_weight*22.0462)/10 + ' ' + weight_unit_string('LB');
		}else{
			document.getElementById('curWeightOtherUnit').innerHTML = Math.round(cur_attempt_weight/0.220462)/10 + ' ' + weight_unit_string('KG');
		}
		document.getElementById('curRackHeight').innerHTML = textify(rack_height);
	}

	drawPlates(cur_attempt_weight);

	drawTable(state.current.lifters);
}
function get_column_header(colname){
	var ret = column_headers[colname];
	if(!ret){
		ret = colname;
	}
	return ret;
}


function get_weight_class(curlifter){
	const division = curlifter.division;
	var body_weight = Number(curlifter.weight);
	if('LB' == state.body_weight_units && 'KG' == state.weight_class_units){
		body_weight *= kilos_per_pound;
	}else if('KG' == state.body_weight_units && 'LB' == state.weight_class_units){
		body_weight /= kilos_per_pound;
	}
	var cls = [];
	if('M' == division.charAt(0)){
		cls = state.weight_classes.men;
	}else{
		cls = state.weight_classes.women;
	}
	const m = cls.length;
	var i = 0;
	var ret = '';
	for(i = 0; i < m; ++i){
		if(body_weight <= cls[i]){
			ret = cls[i];
			break;
		}else if("string" === typeof cls[i] && cls[i].match(/\+/)){
			ret = 'SHW';
			break;
		}
	}
	return ret;
}
function get_wilks(curlifter){
	return wilks_coefficient('M' != curlifter.division.charAt(0), curlifter.weight);
}
function get_age_coeff(curlifter){
	return age_coefficient(curlifter.age);
}
function display_wilks(curlifter){
	var wilks = get_wilks(curlifter);
	return textify(Math.round(wilks*10000)*1e-4).replace(/(\.....)0+[1-9]$/, "$1");
}
function get_best_by_lift(curlifter, lift){
	var best = 0;
	for(var iattempt = 1; iattempt <= 3; ++iattempt){
		var lift_attempt = lift + "_" + iattempt;
		if(curlifter[lift_attempt] > best){
			if(1 == curlifter[lift_attempt + "_state"]){
				best = curlifter[lift_attempt];
			}
		}
	}
	return best;
}
function get_best(curlifter){
	return get_best_by_lift(curlifter, state.current.lift);
}
function get_best_SQ(curlifter){
	return get_best_by_lift(curlifter, 'SQ');
}
function get_best_BP(curlifter){
	return get_best_by_lift(curlifter, 'BP');
}
function get_best_DL(curlifter){
	return get_best_by_lift(curlifter, 'DL');
}
function get_subtotal(curlifter){
	return Number(get_best_by_lift(curlifter, "SQ"))
	+ Number(get_best_by_lift(curlifter, "BP"))
	+ Number(get_best_by_lift(curlifter, "DL"));
}
function get_total(curlifter){
	return get_subtotal(curlifter);
}

function cell_clicked(ev, id, colname, row_index){
	hide_dialogs();
	document.getElementById('dlgEntryLabel').innerHTML = get_column_header(colname);
	var dlg = document.getElementById('dlgEntry');
	var existing_value = state.lifter_info[id][colname];
	if(existing_value){
		document.getElementById('txtEntry').value = existing_value;
	}else{
		document.getElementById('txtEntry').value = '';
	}
	document.getElementById('txtEntry').onkeydown = (function(){
		var my_id = id;
		var my_colname = colname;
		return function(ev){
			var code = (ev.charCode ? ev.charCode : ev.keyCode);
			if(13 == code){
				dlgEntrySave_clicked(my_id, my_colname);
				return false;
			}
			return true;
		}
	})();
	document.getElementById('btnEntrySave').onclick = (function(){
		var my_id = id;
		var my_colname = colname;
		return function(){ return dlgEntrySave_clicked(my_id, my_colname); }
	})();
	document.getElementById('txtEntry').focus();
	if(ev.stopPropagation){ ev.stopPropagation(); }

	var rect = show_row_indicator(row_index);
	var rect0 = document.getElementById('tabLifting_tabDisplay').getBoundingClientRect();
	dlg.style.display = "block";
	dlg.style.left = rect.right-rect0.left + "px";
	if(rect.top < 400){
		dlg.style.top = rect.top-rect0.top + "px";
	}else{
		var rect_dlg = dlg.getBoundingClientRect();
		dlg.style.top = rect.bottom-rect_dlg.height-rect0.top + "px";
	}

	return false;
}
function cell_attempt_clicked(ev, id, lift_attempt, row_index){
	hide_dialogs();
	document.getElementById('dlgEntryAttemptLabel').innerHTML = get_column_header(lift_attempt.replace('_',' '));
	var dlg = document.getElementById('dlgEntryAttempt');
	var existing_value = state.lifter_info[id][lift_attempt];
	if(existing_value > 0){
		document.getElementById('txtEntryAttempt').value = existing_value;
	}else{
		document.getElementById('txtEntryAttempt').value = "";
	}
	document.getElementById('txtEntryAttempt').onkeydown = (function(){
		var my_id = id;
		var my_lift_attempt = lift_attempt;
		return function(ev){
			var code = (ev.charCode ? ev.charCode : ev.keyCode);
			if(13 == code){
				dlgEntryAttemptSave_clicked(my_id, my_lift_attempt);
				return false;
			}
			return true;
		}
	})();
	var status = state.lifter_info[id][lift_attempt + "_state"];
	document.getElementById('radEntryAttemptStatusNotAttempted').checked = (!status);
	document.getElementById('radEntryAttemptStatusGood').checked = (1 == status);
	document.getElementById('radEntryAttemptStatusNoLift').checked = (-1 == status);
	document.getElementById('btnEntryAttemptSave').onclick = (function(){
		var my_id = id;
		var my_lift_attempt = lift_attempt;
		return function(){ return dlgEntryAttemptSave_clicked(my_id, my_lift_attempt); }
	})();
	document.getElementById('txtEntryAttempt').focus();
	if(ev.stopPropagation){ ev.stopPropagation(); }

	var rect = show_row_indicator(row_index);
	var rect0 = document.getElementById('tabLifting_tabDisplay').getBoundingClientRect();
	dlg.style.display = "block";
	dlg.style.left = rect.right-rect0.left + "px";
	if(rect.top < 400){
		dlg.style.top = rect.top-rect0.top + "px";
	}else{
		var rect_dlg = dlg.getBoundingClientRect();
		dlg.style.top = rect.bottom-rect_dlg.height-rect0.top + "px";
	}

	return false;
}

function show_row_indicator(idx){
	const m = document.getElementById('tabLifting_tabDisplay').rows.length;
	var rect0 = document.getElementById('tabLifting_tabDisplay').getBoundingClientRect();
	var rect = document.getElementById('tabLifting_tabDisplay').rows[idx].getBoundingClientRect();
	var ind = document.getElementById('dlgEntryRowIndicator');
	ind.style.display = "block";
	ind.style.left = rect.right-rect0.left + "px";
	ind.style.top = rect.top-rect0.top + "px";
	return ind.getBoundingClientRect();
}

function sort_by_weight(a,b){ // a and b are lifter id's
	var lift_attempt = state.current.lift + "_" + state.current.attempt;
	var lift_attempt_next = state.current.lift + "_" + (state.current.attempt+1);
	var awn = Number(state.lifter_info[a][lift_attempt_next]);
	var bwn = Number(state.lifter_info[b][lift_attempt_next]);
	var as = state.lifter_info[a][lift_attempt + "_state"];
	var bs = state.lifter_info[b][lift_attempt + "_state"];
	var aw = Number(state.lifter_info[a][lift_attempt]);
	var bw = Number(state.lifter_info[b][lift_attempt]);
	const tie_breaker = (Number(state.lifter_info[a].lot_number) - Number(state.lifter_info[b].lot_number));

	// partition by whether lifter is doing current lift
	var a_doing_this_lift = events_contains(state.lifter_info[a].which_lifts, state.current.lift);
	var b_doing_this_lift = events_contains(state.lifter_info[b].which_lifts, state.current.lift);
	if(a_doing_this_lift && !b_doing_this_lift){
		return -1;
	}else if(!a_doing_this_lift && b_doing_this_lift){
		return 1;
	}

	// partition by whether current lift has been performed
	if(!lift_state_completed(as) && lift_state_completed(bs)){
		return 1;
	}else if(lift_state_completed(as) && !lift_state_completed(bs)){
		return -1;
	}
	if(!lift_state_completed(as)){
		if(aw && !bw){ return -1; }
		else if(!aw && bw){ return 1; }
	}
	if(!lift_state_completed(as) || (!awn && !bwn)){ // both have yet to complete current lift, or both have no next attempts
		// put scratches at end
		if(LIFT_STATE.SCRATCH == as && LIFT_STATE.SCRATCH != bs){
			return 1;
		}else if(LIFT_STATE.SCRATCH != as && LIFT_STATE.SCRATCH == bs){
			return -1;
		}
		if(LIFT_STATE.SCRATCH != as){ // both not scratched
			if(aw == bw){ return tie_breaker; }
			return aw - bw;
		}else{
			return tie_breaker;
		}
	}else{ // both have completed current lift
		var asn = state.lifter_info[a][lift_attempt_next + "_state"];
		var bsn = state.lifter_info[b][lift_attempt_next + "_state"];
		// put scratches at end
		if(LIFT_STATE.SCRATCH == asn && LIFT_STATE.SCRATCH != bsn){
			return 1;
		}else if(LIFT_STATE.SCRATCH != asn && LIFT_STATE.SCRATCH == bsn){
			return -1;
		}
		// put those without next attempt later
		if(awn && !bwn){
			return -1;
		}else if(!awn && bwn){
			return 1;
		}
		if(LIFT_STATE.SCRATCH != asn){ // both not scratched
			if(awn == bwn){ return tie_breaker; }
			return awn - bwn;
		}else{
			return tie_breaker;
		}
	}
}

function drawPlates(weight){
	const plate_sizes = [
		{ name: 'bar'  , size: [ 4     ,1.1    ], color: "#DDDDDD", color2: "#888888" },
		{ name: '50'   , size: [ 1.875 ,17.75  ], color: "#00DD00", color2: "#008800" }, // green
		{ name: '45'   , size: [ 2     ,17.75  ], color: "#FFDD00", color2: "#AA8800" }, // gold
		{ name: '25'   , size: [ 1     ,17.75  ], color: "#EE0000", color2: "#880000" }, // red
		{ name: '20'   , size: [ 0.75  ,17.75  ], color: "#0000DD", color2: "#000088" }, // blue
		{ name: '15'   , size: [ 0.8125,15.375 ], color: "#DDDD00", color2: "#888800" }, // yellow
		{ name: '10'   , size: [ 0.8125,12.5   ], color: "#555555", color2: "#000000" }, // black
		{ name:  '5'   , size: [ 0.8125,8.875  ], color: "#555555", color2: "#000000" }, // black
		{ name:  '2.5' , size: [ 0.625 ,7.5    ], color: "#555555", color2: "#000000" }, // black
		{ name:  '1.25', size: [ 0.5   ,6.3125 ], color: "#555555", color2: "#000000" }, // black
		{ name:  '0.5' , size: [ 0.3125,5.3125 ], color: "#555555", color2: "#000000" }, // black
		{ name:  '0.25', size: [ 0.25  ,5      ], color: "#DDDDDD", color2: "#888888" }, //stainless
		{ name:  'collar', size: [ 2,4 ], color: "#FFFFFF", color2: "#BBBBBB" } // stainless
	];
	const margin = 15;
	const w_expansion = 1.5;
	var origin = [ 0, 118 ];
	var ps = 10; // plate scaling
	var h_max = 17.75*ps;

	var bar_weight = get_current_bar_weight();

	var c = document.getElementById("myCanvas");
	var ctx = c.getContext("2d");
	ctx.clearRect(0,0,800,300);

	if(weight < base_weight()){ return; }
	var count = plate_count(weight);

	ctx.font = "20px Arial";
	var text_shift = 0;
	for(var i = 0; i < plate_sizes.length; ++i){
		var num_needed = 0;
		for(var j = 0; j < state.weight_set.length; ++j){
			if(state.weight_set[j].name == plate_sizes[i].name){
				num_needed = count[j];
				break;
			}
		}
		if(plate_sizes[i].name != 'bar'){
			num_needed /= 2;
		}
		if(num_needed < 1){ continue; }
		if(i > 7){ text_shift += 20; }
		var w = plate_sizes[i].size[0]*ps*w_expansion;
		var h = plate_sizes[i].size[1]*ps;
		var grd = ctx.createLinearGradient(0,0,0,h);
		grd.addColorStop(0, plate_sizes[i].color2);
		grd.addColorStop(0.5, plate_sizes[i].color);
		grd.addColorStop(1, plate_sizes[i].color2);
		for(var j = 0; j < num_needed; ++j){
			ctx.strokeStyle = "#000000";
			ctx.strokeRect(origin[0],origin[1]-0.5*h,w,h);
			ctx.fillStyle = grd;
			ctx.fillRect(origin[0],origin[1]-0.5*h,w,h);
			if(i > 7){
				ctx.fillStyle = "#000000";
			}
			var displayed_name = plate_sizes[i].name;
			if(plate_sizes[i].name == 'bar'){
				displayed_name += " (" + bar_weight + ")";
			}else if(plate_sizes[i].name == 'collar'){
				displayed_name += " (" + get_collar_weight() + ")";
			}
			ctx.fillStyle = plate_sizes[i].color2;
			ctx.fillText(displayed_name, origin[0], 20 + text_shift);
			origin[0] += w+margin;
		}
		if(i == 3 && num_needed > 1){
			ctx.fillText(num_needed + ' reds', 350, 30);
		}
	}
	// draw the bar some more
	{
		var w = plate_sizes[0].size[1]*ps*w_expansion;
		var h = plate_sizes[0].size[1]*ps;
		var grd = ctx.createLinearGradient(0,0,0,h);
		grd.addColorStop(0, plate_sizes[0].color2);
		grd.addColorStop(0.5, plate_sizes[0].color);
		grd.addColorStop(1, plate_sizes[0].color2);
		ctx.fillStyle = grd;
		ctx.strokeStyle = "#000000";
		ctx.strokeRect(origin[0],origin[1]-0.5*h,w,h);
		ctx.fillRect(origin[0],origin[1]-0.5*h,w,h);
	}
	ctx.fillStyle = "#000000";
	ctx.fillText('Next load: ' +
		plate_count_to_string(
			plate_count(
				get_next_weight(state.current.lifter_id)
			)
		), 0, 226
	);
}

function drawTable(id_list){
	// generate header row
	var t = document.getElementById("thdLifterInfo");
	t.innerHTML = "";
	var header_row = t.insertRow(0);
	var icol = 0;
	var iattempt = 0;
	for(var i = 0; i < displayed_columns[state.current.lift].length; ++i){
		var colname = displayed_columns[state.current.lift][i];
		if("attempts" == colname){
			for(var j = 0; j < 4; ++j){
				iattempt++;
				var cell = header_row.insertCell(icol++);
				var header_text = state.current.lift + " " + iattempt;
				cell.innerHTML = header_text;
				if(iattempt == state.current.attempt){
					cell.className = "current";
				}
			}
		}else{
			var cell = header_row.insertCell(icol++);
			cell.innerHTML = get_column_header(colname);
		}
	}

	// generate body rows
	t = document.getElementById("tbdLifterInfo");
	t.innerHTML = "";

	var lifter_order = get_lifter_order();
	var ncol;

	const m = lifter_order.length;
	var row_index = 0;
	for(var i = 0; i < m; ++i){
		var id = lifter_order[i];

		var row = t.insertRow(-1);
		row_index++;
		if(state.current.lifter_id == id_list[i]){
			row.className = "current";
		}

		var icol = 0;
		var iattempt = 0;
		for(var j = 0; j < displayed_columns[state.current.lift].length; ++j){
			var colname = displayed_columns[state.current.lift][j];
			if("attempts" == colname){
				for(var k = 0; k < 4; ++k){
					iattempt++;
					var cell = row.insertCell(icol++);
					var lift_attempt = state.current.lift + "_" + iattempt;
					var attempt_weight = state.lifter_info[id][lift_attempt];
					if(attempt_weight){
						cell.innerHTML = attempt_weight;
						//cell.className += (' weight' + state.weight_set_units);
					}
					if(iattempt == state.current.attempt){
						cell.className += " current";
					}
					switch(state.lifter_info[id][lift_attempt + "_state"]){
					case 1: cell.className += " good"; break;
					case -1: cell.className += " nolift"; break;
					case -2: cell.className += " scratch"; break;
					default: break;
					}
					cell.onclick = (function(){
						var my_id = id; var my_lift_attempt = lift_attempt;
						var my_row_index = row_index;
						return function(ev){ cell_attempt_clicked(ev, my_id, my_lift_attempt, my_row_index); }
					})();
				}
			}else{
				var cell = row.insertCell(icol++);
				var cell_value = '';
				if("function" === typeof state.lifter_info[id][colname]){
					cell_value = state.lifter_info[id][colname](state.lifter_info[id]);
				}else{
					var text_to_display = state.lifter_info[id][colname];
					if(!text_to_display){
						text_to_display = '';
					}
					cell_value = text_to_display;
					cell.onclick = (function(){
						var my_id = id; var my_colname = colname;
						var my_row_index = row_index;
						return function(ev){ cell_clicked(ev, my_id, my_colname, my_row_index); }
					})();
				}
				cell.innerHTML = cell_value;
				if(cell_value && weight_columns[colname]){
					cell.className += (' weight' + state[weight_columns[colname]]);
				}
			}
		}
		ncol = icol;
		if(i+1 < m){
			if(state.lifter_info[lifter_order[i+1]].flight != state.lifter_info[id].flight){
				// Insert divider row
				var row = t.insertRow(-1);
				row_index++;
				var cell = row.insertCell(0);
				cell.colSpan = ncol;
				cell.className = "table_divider";
			}
		}
	}
}

function get_lifter_order(){
	// This function returns a permutation of indices of state.lifter_info.
	//   (I)  Lifters in the current flight
	//      (i)  Lifters who are doing the current lift
	//          (a) lifters who already completed current lift
	//              Sort by increasing next attempt, with scratches at end
	//          (b) lifters who have yet to complete current lift
	//              Sort by increasing attempt, with scratches at end
	//      (ii) Lifters who are not doing the current lift
	//   (II) Lifters in the next flight
	//      (i) Order same as in (i) above
	//   (III) etc.
	const flights = get_flight_list(state.current.flight);

	// Group lifters by flight first
	var per_flight = {};
	const m = state.lifter_info.length;
	for(var i = 0; i < m; ++i){
		const iflight = state.lifter_info[i].flight;
		if(!per_flight[iflight]){
			per_flight[iflight] = [];
		}
		per_flight[iflight].push(i);
	}

	// Perform the sort within each flight
	const n = flights.length;
	for(flight in per_flight){
		per_flight[flight].sort(sort_by_weight);
	}
	var ret = [];
	for(var i = 0; i < flights.length; ++i){
		ret = ret.concat(per_flight[flights[i]]);
	}
	return ret;
}



function tabLifting_update_toolbar(){
	// First update the controls
	//// Update flight dropdown
	var flights = get_flight_list();
	var c = document.getElementById("selFlight");
	var c_count = c.options.length;
	for(var i = c_count-1; i >= 0; --i){
		c.removeChild(c.options[i]);
	}
	for(var i = 0; i < flights.length; ++i){
		var opt = document.createElement("option");
		opt.appendChild(document.createTextNode(flights[i]));
		opt.value = flights[i];
		c.appendChild(opt);
	}

	//// Check to see if current flight is valid, and select when found
	var c = document.getElementById("selFlight");
	var c_count = c.options.length;
	var found = false;
	for(var i = 0; i < c_count; ++i){
		if(state.current.flight == c.options[i].text){
			c.selectedIndex = i;
			found = true;
		}
	}
	if(!found){
		c.selectedIndex = 0;
		state.current.flight = c.options[0].value;
	}

	var c = document.getElementById("selLift");
	var c_count = c.options.length;
	var found = false;
	for(var i = 0; i < c_count; ++i){
		if(state.current.lift == c.options[i].value){
			c.selectedIndex = i;
			found = true;
		}
	}
	if(!found){
		c.selectedIndex = 0;
		state.current.lift = c.options[0].value;
	}

	var c = document.getElementById("selAttempt");
	var c_count = c.options.length;
	var found = false;
	for(var i = 0; i < c_count; ++i){
		if(state.current.attempt == c.options[i].value){
			c.selectedIndex = i;
			found = true;
		}
	}
	if(!found){
		c.selectedIndex = 0;
		state.current.attempt = c.options[0].value;
	}
}
function get_next_lifter(id_curr){
	const m = state.current.lifters.length;
	var current_attempt = state.current.attempt;
	var id_next = -1;
	var lift_attempt;
	do{
		if(current_attempt > 4){ return -1; }
		lift_attempt = state.current.lift + "_" + current_attempt;

		// advance
		for(var i = 0; i < m; ++i){
			if(id_curr == state.current.lifters[i]){
				if(i+1 == m){
					current_attempt++;
					id_next = state.current.lifters[0];
				}else{
					id_next = state.current.lifters[i+1];
				}
				break;
			}
		}
		// keep advancing if scratched
	}while(-1 != id_next && LIFT_STATE.SCRATCH == state.lifter_info[id_next][lift_attempt+"_state"]);
	return id_next;
}
function get_next_weight(id_curr){
	const m = state.current.lifters.length;
	var current_attempt = state.current.attempt;
	var id_next = -1;
	var lift_attempt;
	do{
		if(current_attempt > 4){ return -1; }
		lift_attempt = state.current.lift + "_" + current_attempt;

		// advance
		for(var i = 0; i < m; ++i){
			if(id_curr == state.current.lifters[i]){
				if(i+1 == m){
					current_attempt++;
					lift_attempt = state.current.lift + "_" + current_attempt;
					id_next = state.current.lifters[0];
				}else{
					id_next = state.current.lifters[i+1];
				}
				break;
			}
		}
		// keep advancing if scratched
	}while(-1 != id_next && LIFT_STATE.SCRATCH == state.lifter_info[id_next][lift_attempt+"_state"]);
	if(!state.lifter_info[id_next]){ return 0; }
	return state.lifter_info[id_next][lift_attempt];
}
function advance_lifter(){
	if(state.current.attempt > 4){ return; } // safeguard to prevent infinite loops
	const m = state.current.lifters.length;
	const lift_attempt = state.current.lift + "_" + state.current.attempt;

	// advance
	for(var i = 0; i < m; ++i){
		if(state.current.lifter_id == state.current.lifters[i]){
			if(i+1 == m){
				state.current.attempt++;
				tabLifting_update_display(); // call this to update current.lifters
				state.current.lifter_id = state.current.lifters[0];
			}else{
				state.current.lifter_id = state.current.lifters[i+1];
			}
			break;
		}
	}
	// keep advancing if scratched
	if(-2 == state.lifter_info[state.current.lifter_id][lift_attempt+"_state"]){
		advance_lifter();
	}
}
function set_lift_state(good_or_not){
	const lift_attempt = state.current.lift + "_" + state.current.attempt;
	if(!state.lifter_info[state.current.lifter_id][lift_attempt]){ return; }
	state.lifter_info[state.current.lifter_id][lift_attempt + "_state"] = good_or_not;
	advance_lifter();
	tabLifting_update_display();
}
function btnGOOD_clicked(){
	set_lift_state(1);
	return false;
}
function btnNOLIFT_clicked(){
	set_lift_state(-1);
	return false;
}
function selFlight_changed(){
	state.current.flight = document.getElementById("selFlight").value;
	tabLifting_update_display();
}
function selLift_changed(){
	state.current.lift = document.getElementById("selLift").value;
	tabLifting_update_display();
}
function selAttempt_changed(){
	state.current.attempt = document.getElementById("selAttempt").value;
	tabLifting_update_display();
}
function selLifter_changed(){
	state.current.lifter_id = document.getElementById("selLifter").value;
	tabLifting_update_display();
}

function dlgEntryCancel_clicked(){
	var dlg = document.getElementById('dlgEntry');
	dlg.style.display = 'none';
}
function dlgEntrySave_clicked(id, colname){
	var dlg = document.getElementById('dlgEntry');
	state.lifter_info[id][colname] = document.getElementById('txtEntry').value;
	dlg.style.display = 'none';
	tabLifting_update_display();
	return false;
}
function dlgEntryAttemptCancel_clicked(){
	var dlg = document.getElementById('dlgEntryAttempt');
	dlg.style.display = 'none';
}
function dlgEntryAttemptSave_clicked(id, lift_attempt){
	var dlg = document.getElementById('dlgEntryAttempt');
	state.lifter_info[id][lift_attempt] = document.getElementById('txtEntryAttempt').value;
	check_attempt_weight(state.lifter_info[id][lift_attempt]);
	if(document.getElementById('radEntryAttemptStatusNotAttempted').checked){
		state.lifter_info[id][lift_attempt + "_state"] = 0;
	}else if(document.getElementById('radEntryAttemptStatusGood').checked){
		state.lifter_info[id][lift_attempt + "_state"] = 1;
	}else if(document.getElementById('radEntryAttemptStatusNoLift').checked){
		state.lifter_info[id][lift_attempt + "_state"] = -1;
	}else if(document.getElementById('radEntryAttemptStatusScratch').checked){
		state.lifter_info[id][lift_attempt + "_state"] = -2;
		state.lifter_info[id][lift_attempt] = "--";
		if('2' == lift_attempt[lift_attempt.length-1]){
			var key = lift_attempt.substring(0, lift_attempt.length-1) + "3";
			state.lifter_info[id][key] = "--";
			state.lifter_info[id][key + "_state"] = -2;
		}
	}
	dlg.style.display = 'none';
	tabLifting_update_display();
	return false;
}

function hide_dialogs(){
	var dlg = document.getElementById('dlgEntry');
	dlg.style.display = 'none';
	var dlg = document.getElementById('dlgEntryAttempt');
	dlg.style.display = 'none';
	var dlg = document.getElementById('dlgEntryRowIndicator');
	dlg.style.display = 'none';
}
// timer sits on the lifting tab
var timer_sec = 60;
var timer_interval;
function update_timer_display(){
	var min = Math.floor(timer_sec / 60);
	var sec = timer_sec - min*60;
	if(sec < 10){ sec = '0' + sec; }
	document.getElementById('timer').innerHTML = min+":"+sec;
}
function parse_timer(){
	timer_sec = 0;
	if(document.getElementById('txtTimerMin').value){
		timer_sec += 60*parseInt(document.getElementById('txtTimerMin').value);
	}
	if(document.getElementById('txtTimerSec').value){
		timer_sec += parseInt(document.getElementById('txtTimerSec').value);
	}
}
function btnTimerReset_clicked(){
	if(timer_interval){
		clearInterval(timer_interval);
		timer_interval = null;
		document.getElementById('btnTimerStartStop').value = 'Start';
	}
	parse_timer();
	update_timer_display();
}

function btnTimerStartStop_clicked(){
	if(!timer_interval){
		update_timer_display();
		if(timer_sec <= 0){ return; }
		timer_interval = setInterval(function(){
			timer_sec--;
			update_timer_display();
			if(timer_sec <= 0){
				clearInterval(timer_interval);
		timer_interval = null;
				document.getElementById('timer').innerHTML = "<blink>0:00</blink>";
				document.getElementById('btnTimerStartStop').value = 'Start';
			}
		}, 1000);
		document.getElementById('btnTimerStartStop').value = 'Stop';
	}else{
		clearInterval(timer_interval);
		timer_interval = null;
		document.getElementById('btnTimerStartStop').value = 'Start';
	}
}
function tabSaveRestore_update_display(){
//
}

function btnLoadState_clicked(){
	var fileToLoad = document.getElementById("fileLoadState").files[0];

	var fileReader = new FileReader();
	fileReader.onload = function(fileLoadedEvent){
		var textFromFileLoaded = fileLoadedEvent.target.result;
		state = JSON.parse(textFromFileLoaded);
		add_computed_columns();
		update_display();
	};
	fileReader.readAsText(fileToLoad, "UTF-8");
}
function btnSaveState_clicked(){
	var blob = new Blob([JSON.stringify(state)], {type: "text/plain;charset=utf-8"});
	saveAs(blob, "netlifter_" + get_timestamp() + ".json");
}

// Autosave feature:
//   Every five minutes, this will autosave to a cookie.
//   You can delete the last autosave.
//   When reloading, the last autosave is loaded.
//   Autosaves last for 2 days.

function autosave(){
	if(typeof(Storage) === "undefined"){ return; }
	localStorage.setItem("state", JSON.stringify(state));
}
function autoload(){
	if(typeof(Storage) === "undefined"){ return; }
	var statestr = localStorage.getItem("state");
	if(statestr){
		state = JSON.parse(statestr);
	}
	add_computed_columns();
}
function btnAutosave_clicked(){
	autosave();
}
function btnLoadAutosave_clicked(){
	autoload();
	update_display();
}
function btnClearAutosave_clicked(){
	localStorage.removeItem("state");
}



//// Export

function sort_results(a,b){ // a and b are lifter id's
	// Sort by weight class first
	var awc = weight_class_number(state.lifter_info[a].weight_class(state.lifter_info[a]));
	var bwc = weight_class_number(state.lifter_info[b].weight_class(state.lifter_info[b]));
	if(awc < bwc){ return -1; }
	if(awc > bwc){ return 1; }

	// Sort by total
	var atot = state.lifter_info[a].total(state.lifter_info[a]);
	var btot = state.lifter_info[b].total(state.lifter_info[b]);
	return atot - btot;
}

function export_download(){
	var csv = '';
	for(colidx in export_columns){
		csv += get_column_header(export_columns[colidx]) + ',';
	}
	csv += '\n';
	const m = state.lifter_info.length;

	var ids_by_division = {};
	for(var i = 0; i < m; ++i){
		var divs = state.lifter_info[i].division.split(',');
		for(var j = 0; j < divs.length; ++j){
			var div = divs[j].trim();
			if(!ids_by_division[div]){
				ids_by_division[div] = [ i ];
			}else{
				ids_by_division[div].push(i);
			}
		}
	}
	// Sort each division
	for(division in ids_by_division){
		ids_by_division[division].sort(sort_results);
		csv += (division + ':,\n');
		for(var i = 0; i < ids_by_division[division].length; ++i){
			var id = ids_by_division[division][i];
			for(colidx in export_columns){
				const colname = export_columns[colidx];
				if("function" === typeof state.lifter_info[id][colname]){
					csv += (state.lifter_info[id][colname](state.lifter_info[id]) + ',');
				}else{
					field = '';
					if(-1 == (state.lifter_info[id][colname + '_state'])){
						field = ('-' + state.lifter_info[id][colname] + ',');
					}else{
						if(state.lifter_info[id][colname]){
							field = state.lifter_info[id][colname];
						}
					}
					csv += escape_Excel(field) + ',';
				}
			}
			csv += "\n";
		}
	}
	var blob = new Blob([csv], {type: "text/csv;charset=utf-8"});
	saveAs(blob, "netlifter_export_" + get_timestamp() + ".csv");
}

function lifter_info_from_text(text){
	arr = text_to_table(document.getElementById('txtWeightClassesMen').value, ',');
	state.weight_classes.men = [];
	for(var i = 0; i < arr.length; ++i){
		state.weight_classes.men[i] = arr[i][0];
	}
	arr = text_to_table(document.getElementById('txtWeightClassesWomen').value, ',');
	state.weight_classes.women = [];
	for(var i = 0; i < arr.length; ++i){
		state.weight_classes.women[i] = arr[i][0];
	}


	var lines = text.split(/\r\n|\n/);
	//console.log("Parsing " + lines.length + " lines...");
	for(var i = 0; i < lines.length; ++i){
		if(lines[i].match(/^\s*$/)){ break; }
		var fields = lines[i].split(/,|\t/);
		state.lifter_info[i] = {};
		for(var j = 0; j < fields.length; ++j){
			if(j >= text_columns.length){ break; }
			state.lifter_info[i][text_columns[j]] = fields[j].trim();
		}
	}
	add_computed_columns();
}
function lifter_info_to_text(delim){
	var str = '';
	const m = state.lifter_info.length; // m rows
	for(var i = 0; i < m; ++i){
		const n = state.lifter_info[i].length; // n cols
		var j = 0;
		for(j = 0; j+1 < text_columns.length; ++j){
			str += state.lifter_info[i][text_columns[j]] + delim;
		}
		str += state.lifter_info[i][text_columns[j]] + '\n';
	}
	return str;
}

window.onload = function(){
	autoload();
	switch_tab(null, 'tabInstructions');
}
</script>
</body>
</html>
